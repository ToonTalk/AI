<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Sketch Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: white; height: 100vh; width: 100vw; font-family: sans-serif; }
        #drawing-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABCYAAAEpCAYAAABPxSNNAAAQAElEQVR4AezYSW4ryQ4F0I+//0UXNFDBLjXOJho25wGGrVQkgzx8o/v///lHgAABAgQIECBAgAABAgQIVBcIO59gIuxqNEaAAAECBAgQIECAAAEC+QR0fFZAMHFWzHkCBAgQIECAAAECBAgQ2C+ggzICgokyqzQIAQIECBAgQIAAAQIExguoSGC2gGBitrD6BAgQIECAAAECBAgQ+FvACQJtBQQTbVdvcAIECBAgQIAAAQIdBcxMgEA0AcFEtI3ohwABAgQIECBAgEAFATMQIEDgoIBg4iCUYwQIECBAgAABAgQiCuiJAAEC2QUEE9k3qH8CBAgQIECAAIEVAu4gQIAAgUkCgolJsMoSIECAAAECBAhcEfAOAQIECHQTEEx027h5CRAgQIAAAQIPAT8ECBAgQCCIgGAiyCK0QYAAAQIECNQUMBUBAgQIECDwXUAw8d3HtwQIECBAgEAOAV0SIECAAAECSQUEE0kXp20CBAgQILBHwK0ECBAgQIAAgbECgomxnqoRIECAAIExAqoQIECAAAECBJoICCaaLNqYBAgQIPBewFMCBAgQIECAAIG9AoKJvf5uJ0CAQBcBcxIgQIAAAQIECBB4KyCYeMviIQECBLIK6JsAAQIECBAgQIBALgHBRK596ZYAgSgC+iBAgAABAgQIECBAYIiAYGIIoyIECMwSUJcAAQIECBAgQIAAgdoCgona+zUdgaMCzhEgQIAAAQIECBAgQGCLgGBiC7tL+wqYnAABAgQIECBAgAABAgR+Cggmfmr4u46ASQgQIECAAAECBAgQIEAghYBgIsWa4japMwIECBAgQIAAAQIECBAgcEdAMHFHb927biJAgAABAgQIECBAgAABAiUFBBO/1uoDAQIECBAgQIAAAQIECBAgsFJgTzCxckJ3ESBAgAABAgQIECBAgAABAnsEDtwqmDiA5AgBAgQIECBAgAABAgQIEIgskLk3wUTm7emdAAECBAgQIECAAAECBFYKuGuCgGBiAqqSBAgQIECAAAECBAgQIHBHwLudBAQTnbZtVgIECBAgQIAAAQIECPwU8DeBAAKCiQBL0AIBAgQIECBAgAABArUFTEeAwGcBwcRnG98QIECAAAECBAgQIJBLQLcECCQUEEwkXJqWCRAgQIAAAQIECOwVcDsBAgTGCQgmxlmqRIAAAQIECBAgQGCsgGoECBBoICCYaLBkIxIgQIAAAQIECHwX8C0BAgQI7BMQTOyzdzMBAgQIECBAoJuAeQkQIECAwIuAYOKFxAMCBAgQIECAQHYB/RMgQIAAgTwCgok8u9IpAQIECBAgEE1APwQIECBAgMBtAcHEbUIFCBAgQIAAgdkC6hMgQIAAAQJ1BQQTdXdrMgIECBAgcFbAeQIECBAgQIDAcgHBxHJyFxIgQIAAAQIECBAgQIAAAQJPAcHEU8JvAgQIEKgnYCICBAgQIECAAIHwAoKJ8CvSIAECBOIL6JAAAQIECBAgQIDAVQHBxFU57xEgQGC9gBsJECBAgAABAgQIlBMQTJRbqYEIELgvoAIBAgQIECBAgAABAqsEBBOrpN1DgMCrgCcECBAgQIAAAQIECLQXEEy0/y8AoIOAGQkQIECAAAECBAgQIBBVQDARdTP6yiigZwIECBAgQIAAAQIECBA4KSCYOAnmeAQBPRAgQIAAAQIECBAgQIBAFQHBRJVNzphDTQIECBAgQIAAAQIECBAgMFlAMDEZ+Eh5ZwgQIECAAAECBAgQIECAQFeBTsFE1x2bmwABAgQIECBAgAABAgQIhBWYEEyEnVVjBAgQIECAAAECBAgQIECAwDCBMYUEE2McVSFAgAABAgQIECBAgAABAnMEilcVTBRfsPEIECBAgAABAgQIECBA4JiAU3sEBBN73N1KgAABAgQIECBAgACBrgLmJvBLQDDxi8MHAgQIECBAgAABAgQIVBEwB4EcAoKJHHvSJQECBAgQIECAAAECUQX0RYDALQHBxC0+LxMgQIAAAQIECBAgsErAPQQI1BQQTNTcq6kIECBAgAABAgQIXBXwHgECBJYKCCaWcruMAAECBAgQIECAwFPAbwIECBB4CAgmHgp+CBAgQIAAAQIE6gqYjAABAgRCCwgmQq9HcwQIECBAgACBPAI6JUCAAAECVwQEE1fUvEOAAAECBAgQ2CfgZgIECBAgUEpAMFFqnYYhQIAAAQIExgmoRIAAAQIECKwQEEysUHYHAQIECBAg8FnANwQIECBAgEBrAcFE6/UbngABAgQ6CZiVAAECBAgQIBBRQDARcSt6IkCAAIHMAnonQIAAAQIECBA4ISCYOIHlKAECBAhEEtALAQIECBAgQIBABQHBRIUtmoEAAQIzBdQmQIAAAQIECBAgMFFAMDERV2kCBAicEXCWAAECBAgQIECAQEcBwUTHrZuZQG8B0xMgQIAAAQIECBAgEEhAMBFoGVohUEvANAQIECBAgAABAgQIEPhbQDDxt5ETBGIL6I4AAQIECBAgQIAAAQKJBQQTiZen9bUCbiNAgAABAgQIECBAgACB8QKCifGmKt4T8DYBAgQIECBAgAABAgQINBIQTDRa9u9RfSJAgAABAgQIECBAgAABAvsFBBOzd6A+AQIECBAgQIAAAQIECBAg8FGgTDDxcUJfECBAgAABAgQIECBAgAABAmEFzgYTYQfRGAECBAgQIECAAAECBAgQIDBMYFkhwcQyahcRIECAAAECBAgQIECAAIH/CvgsmPB/gAABAgQIECBAgAABAgTqC5gwrIBgIuxqNEaAAAECBAgQIECAAIF8AjomcFZAMHFWzHkCBAgQIECAAAECBAjsF9ABgTICgokyqzQIAQIECBAgQIAAAQLjBVQkQGC2gGBitrD6BAgQIECAAAECBAj8LeAEAQJtBQQTbVdvcAIECBAgQIAAgY4CZiZAgEA0AcFEtI3ohwABAgQIECBAoIKAGQgQIEDgoIBg4iCUYwQIECBAgAABAhEF9ESAAAEC2QUEE9k3qH8CBAgQIECAwAoBdxAgQIAAgUkCgolJsMoSIECAAAECBK4IeIcAAQIECHQTEEx027h5CRAgQIAAgYeAHwIECBAgQCCIgGAiyCK0QYAAAQIEagqYigABAgQIECDwXUAw8d3HtwQIECBAIIeALgkQIECAAAECSQUEE0kXp20CBAgQ2CPgVgIECBAgQIAAgbECgomxnqoRIECAwBgBVQgQIECAAAECBJoICCaaLNqYBAgQeC/gKQECBAgQIECAAIG9AoKJvf5uJ0Cgi4A5CRAgQIAAAQIECBB4KyCYeMviIQECWQX0TYAAAQIECBAgQIBALgHBRK596ZZAFAF9ECBAgAABAgQIECBAYIiAYGIIoyIEZgmoS4AAAQIECBAgQIAAgdoCgona+zXdUQHnCBAgQIAAAQIECBAgQGCLgGBiC3vfS01OgAABAgQIECBAgAABAgR+CggmfmrU+dskBAgQIECAAAECBAgQIEAghYBg4taavEyAAAECBAgQIECAAAECBAjcEcgRTNyZ0LsECBAgQIAAAQIECBAgQIBAWIFfwUTYLjVGgAABAgQIECBAgAABAgQIDBOIVEgwEWkbeiFAgAABAgQIECBAgACBSgJmOSAgmDiA5AgBAgQIECBAgAABAgQIRBbQW2YBwUTm7emdAAECBAgQIECAAAECKwXcRWCCgGBiAqqSBAgQIECAAAECBAgQuCPgXQKdBAQTnbZtVgIECBAgQIAAAQIEfgr4mwCBAAKCiQBL0AIBAgQIECBAgACB2gKmI0CAwGcBwcRnG98QIECAAAECBAgQyCWgWwIECCQUEEwkXJqWCRAgQIAAAQIE9gq4nQABAgTGCQgmxlmqRIAAAQIECBAgMFZANQIECBBoICCYaLBkIxIgQIAAAQIEvgv4lgABAgQI7BMQTOyzdzMBAgQIECDQTcC8BAgQIECAwIuAYOKFxAMCBAgQIEAgu4D+CRAgQIAAgTwCgok8u9IpAQIECBCIJqAfAgQIECBAgMBtAcHEbUIFCBAgQIDAbAH1CRAgQIAAAQJ1BQQTdXdrMgIECBA4K+A8AQIECBAgQIDAcgHBxHJyFxIgQIAAAQIECBAgQIAAAQJPAcHEU8JvAgQI1BMwEQECBAgQIECAAIHwAoKJ8CvSIAEC8QV0SIAAAQIECBAgQIDAVQHBxFU57xEgsF7AjQQIECBAgAABAgQIlBMQTJRbqYEI3BdQgQABAgQIECBAgAABAqsEBBOrpN1D4FXAEwIECBAgQIAAAQIECLQXEEy0/y/QAcCMBAgQIECAAAECBAgQIBBVQDARdTMZ+9IzAQIECBAgQIAAAQIECBA4KSCYOAkW4bgeCBAgQIAAAQIECBAgQIBAFQHBxOdN+oYAAQIECBAgQIAAAQIECBCYLBAgmJg8ofIECBAgQIAAAQIECBAgQIBAAIH3LQgm3rt4SoAAAQIECBAgQIAAAQIEcgok61owkWxh2iVAgAABAgQIECBAgACBGAK6GCMgmBjjqAoBAgQIECBAgAABAgQIzBFQtbiAYKL4go1HgAABAgQIECBAgACBYwJOEdgjIJjY4+5WAgQIECBAgAABAgS6CpibAIFfAoKJXxw+ECBAgAABAgQIECBQRcAcBAjkEBBM5NiTLgkQIECAAAECBAhEFdAXAQIEbgkIJm7xeZkAAQIECBAgQIDAKgH3ECBAoKaAYKLmXk1FgAABAgQIECBwVcB7BAgQILBUQDCxlNtlBAgQIECAAAECTwG/CRAgQIDAQ0Aw8VDwQ4AAAQIECBCoK2AyAgQIECAQWkAwEXo9miNAgAABAgTyCOiUAAECBAgQuCIgmLii5h0CBAgQIEBgn4CbCRAgQIAAgVICgolS6zQMAQIECBAYJ6ASAQIECBAgQGCFgGBihbI7CBAgQIDAZwHfECBAgAABAgRaCwgmWq/f8AQIEOgkYFYCBAgQIECAAIGIAoKJiFvREwECBDIL6J0AAQIECBAgQIDACQHBxAksRwkQIBBJQC8ECBAgQIAAAQIEKggIJips0QwECMwUUJsAAQIECBAgQIAAgYkCgomJuEoTIHBGwFkCBAgQIECAAAECBDoKCCY6bt3MvQVMT4AAAQIECBAgQIAAgUACgolAy9BKLQHTECBAgAABAgQIECBAgMDfAoKJv42ciC2gOwIECBAgQIAAAQIECBBILCCYSLy8ta27jQABAgQIECBAgAABAgQIjBcQTIw3vVfR2wQIECBAgAABAgQIECBAoJFA22Ci0Y6NSoAAAQIECBAgQIAAAQIEwgrMDibCDq4xAgQIECBAgAABAgQIECBAYJjA5UKCict0XiRAgAABAgQIECBAgAABAqsF6t0nmKi3UxMRIECAAAECBAgQIECAwF0B7y8TEEwso3YRAQIECBAgQIAAAQIECPxXwGcCggn/BwgQIECAAAECBAgQIFBfwIQEwgoIJsKuRmMECBAgySZSmwAADKNJREFUQIAAAQIECOQT0DEBAmcFBBNnxZwnQIAAAQIECBAgQGC/gA4IECgjIJgos0qDECBAgAABAgQIEBgvoCIBAgRmCwgmZgurT4AAAQIECBAgQOBvAScIECDQVkAw0Xb1BidAgAABAgQIdBQwMwECBAhEExBMRNuIfggQIECAAAECFQTMQIAAAQIEDgoIJg5COUaAAAECBAgQiCigJwIECBAgkF1AMJF9g/onQIAAAQIEVgi4gwABAgQIEJgkIJiYBKssAQIECBAgcEXAOwQIECBAgEA3AcFEt42blwABAgQIPAT8ECBAgAABAgSCCAgmgixCGwQIECBQU8BUBAgQIECAAAEC3wUEE999fEuAAAECOQR0SYAAAQIECBAgkFRAMJF0cdomQIDAHgG3EiBAgAABAgQIEBgrIJgY66kaAQIExgioQoAAAQIECBAgQKCJgGCiyaKNSYDAewFPCRAgQIAAAQIECBDYKyCY2OvvdgJdBMxJgAABAgQIECBAgACBtwKCibcsHhLIKqBvAgQIECBAgAABAgQI5BIQTOTal26jCOiDAAECBAgQIECAAAECBIYICCaGMCoyS0BdAgQIECBAgAABAgQIEKgtIJiovd+j0zlHgAABAgQIECBAgAABAgS2CAgmlrK7jAABAgQIECBAgAABAgQIEPgpUDOY+DmhvwkQIECAAAECBAgQIECAAIGwAreCibBTaYwAAQIECBAgQIAAAQIECBAYJjCzkGBipq7aBAgQIECAAAECBAgQIEDguEDLk4KJlms3NAECBAgQIECAAAECBDoLmD2SgGAi0jb0QoAAAQIECBAgQIAAgUoCZiFwQEAwcQDJEQIECBAgQIAAAQIECEQW0BuBzAKCiczb0zsBAgQIECBAgAABAisF3EWAwAQBwcQEVCUJECBAgAABAgQIELgj4F0CBDoJCCY6bdusBAgQIECAAAECBH4K+JsAAQIBBAQTAZagBQIECBAgQIAAgdoCpiNAgACBzwKCic82viFAgAABAgQIEMgloFsCBAgQSCggmEi4NC0TIECAAAECBPYKuJ0AAQIECIwTEEyMs1SJAAECBAgQIDBWQDUCBAgQINBAQDDRYMlGJECAAAECBL4L+JYAAQIECBDYJyCY2GfvZgIECBAg0E3AvAQIECBAgACBFwHBxAuJBwQIECBAILuA/gkQIECAAAECeQQEE3l2pVMCBAgQiCagHwIECBAgQIAAgdsCgonbhAoQIECAwGwB9QkQIECAAAECBOoKCCbq7tZkBAgQOCvgPAECBAgQIECAAIHlAoKJ5eQuJECAAAECBAgQIECAAAECBJ4CgomnhN8ECNQTMBEBAgQIECBAgAABAuEFBBPhV6RBAvEFdEiAAAECBAgQIECAAIGrAoKJq3LeI7BewI0ECBAgQIAAAQIECBAoJyCYKLdSA90XUIEAAQIECBAgQIAAAQIEVgkIJlZJu+dVwBMCBAgQIECAAAECBAgQaC8gmGjwX8CIBAgQIECAAAECBAgQIEAgqoBgYtxmVCJAgAABAgQIECBAgAABAgROCiQMJk5O6DgBAgQIECBAgAABAgQIECAQVuBzMBG2ZY0RIECAAAECBAgQIECAAAECwwQ2FxJMbF6A6wkQIECAAAECBAgQIECgh4Ap3wsIJt67eEqAAAECBAgQIECAAAECOQV0nUxAMJFsYdolQIAAAQIECBAgQIBADAFdEBgjIJgY46gKAQIECBAgQIAAAQIE5gioSqC4gGCi+IKNR4AAAQIECBAgQIDAMQGnCBDYIyCY2OPuVgIECBAgQIAAAQJdBcxNgACBXwKCiV8cPhAgQIAAAQIECBCoImAOAgQI5BAQTOTYky4JECBAgAABAgSiCuiLAAECBG4JCCZu8XmZAAECBAgQIEBglYB7CBAgQKCmgGCi5l5NRYAAAQIECBC4KuA9AgQIECCwVEAwsZTbZQQIECBAgACBp4DfBAgQIECAwENAMPFQ8EOAAAECBAjUFTAZAQIECBAgEFpAMBF6PZojQIAAAQJ5BHRKgAABAgQIELgiIJi4ouYdAgQIECCwT8DNBAgQIECAAIFSAoKJUus0DAECBAiME1CJAAECBAgQIEBghYBgYoWyOwgQIEDgs4BvCBAgQIAAAQIEWgsIJlqv3/AECHQSMCsBAgQIECBAgACBiAKCiYhb0RMBApkF9E6AAAECBAgQIECAwAkBwcQJLEcJEIgkoBcCBAgQIECAAAECBCoICCYqbNEMBGYKqE2AAAECBAgQIECAAIGJAoKJibhKEzgj4CwBAgQIECBAgAABAgQ6CggmOm6998ymJ0CAAAECBAgQIECAAIFAAoKJQMuo1YppCBAgQIAAAQIECBAgQIDA3wKCib+NYp/QHQECBAgQIECAAAECBAgQSCwgmDi4PMcIECBAgAABAgQIECBAgACB8QLRgonxE6pIgAABAgQIECBAgAABAgQIRBP4tx/BxL8U/iBAgAABAgQIECBAgAABAtUE4s8jmIi/Ix0SIECAAAECBAgQIECAQHQB/V0WEExcpvMiAQIECBAgQIAAAQIECKwWcF89AcFEvZ2aiAABAgQIECBAgAABAncFvE9gmYBgYhm1iwgQIECAAAECBAgQIPBfAZ8JEBBM+D9AgAABAgQIECBAgEB9ARMSIBBWQDARdjUaI0CAAAECBAgQIJBPQMcECBA4KyCYOCvmPAECBAgQIECAAIH9AjogQIBAGQHBRJlVGoQAAQIECBAgQGC8gIoECBAgMFtAMDFbWH0CBAgQIECAAIG/BZwgQIAAgbYCgom2qzc4AQIECBAg0FHAzAQIECBAIJqAYCLaRvRDgAABAgQIVBAwAwECBAgQIHBQQDBxEMoxAgQIECBAIKKAnggQIECAAIHsAoKJ7BvUPwECBAgQWCHgDgIECBAgQIDAJAHBxCRYZQkQIECAwBUB7xAgQIAAAQIEugkIJrpt3LwECBAg8BDwQ4AAAQIECBAgEERAMBFkEdogQIBATQFTESBAgAABAgQIEPguIJj47uNbAgQI5BDQJQECBAgQIECAAIGkAoKJpIvTNgECewTcSoAAAQIECBAgQIDAWAHBxFhP1QgQGCOgCgECBAgQIECAAAECTQQEE00WbUwC7wU8JUCAAAECBAgQIECAwF4BwcRef7d3ETAnAQIECBAgQIAAAQIECLwVEEy8ZfEwq4C+CRAgQIAAAQIECBAgQCCXgGAi176idKsPAgQIECBAgAABAgQIECAwREAwMYRxVhF1CRAgQIAAAQIECBAgQIBAbQHBxGO/fggQIECAAAECBAgQIECAAIEtAkuDiS0TupQAAQIECBAgQIAAAQIECBBYKnDmMsHEGS1nCRAgQIAAAQIECBAgQIBAHIESnQgmSqzREAQIECBAgAABAgQIECAwT0DlmQKCiZm6ahMgQIAAAQIECBAgQIDAcQEnWwoIJlqu3dAECBAgQIAAAQIECHQWMDuBSAKCiUjb0AsBAgQIECBAgAABApUEzEKAwAEBwcQBJEcIECBAgAABAgQIEIgsoDcCBDILCCYyb0/vBAgQIECAAAECBFYKuIsAAQITBAQTE1CVJECAAAECBAgQIHBHwLsECBDoJCCY6LRtsxIgQIAAAQIECPwU8DcBAgQIBBAQTARYghYIECBAgAABArUFTEeAAAECBD4LCCY+2/iGAAECBAgQIJBLQLcECBAgQCChgGAi4dK0TIAAAQIECOwVcDsBAgQIECAwTkAwMc5SJQIECBAgQGCsgGoECBAgQIBAAwHBRIMlG5EAAQIECHwX8C0BAgQIECBAYJ+AYGKfvZsJECBAoJuAeQkQIECAAAECBF4EBBMvJB4QIECAQHYB/RMgQIAAAQIECOQREEzk2ZVOCRAgEE1APwQIECBAgAABAgRuCwgmbhMqQIAAgdkC6hMgQIAAAQIECBCoKyCYqLtbkxEgcFbAeQIECBAgQIAAAQIElgsIJpaTu5AAAQIECBAgQIAAAQIECBB4CggmnhJ+E6gnYCICBAgQIECAAAECBAiEFxBMhF+RBuML6JAAAQIECBAgQIAAAQIErgoIJq7KeW+9gBsJECBAgAABAgQIECBAoJyAYKLcSu8PpAIBAgQIECBAgAABAgQIEFglIJhYJf16jycECBAgQIAAAQIECBAgQKC9QINgov2OARAgQIAAAQIECBAgQIAAgbAC44KJsCNqjAABAgQIECBAgAABAgQIEBgmMLiQYGIwqHIECBAgQIAAAQIECBAgQGCEQJcagokumzYnAQIECBAgQIAAAQIECLwT8GyzwD8AAAD//1o+bekAAAAGSURBVAMA0w0CU0oPjIYAAAAASUVORK5CYII='); background-size: 100% 100%; background-repeat: no-repeat; background-position: center; transition: opacity 0.3s; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 10; }
        #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 10px; background: rgba(255, 255, 255, 0.9); padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button { background: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; color: #475569; transition: all 0.2s; }
        button:hover { background: #f1f5f9; }
        button.active { background: #e0e7ff; color: #4f46e5; border-color: #c7d2fe; }
    </style>
</head>
<body>
    <div id="drawing-layer"></div>
    <div id="sketch-holder"></div>
    <div id="controls">
        <button id="btn-pause" onclick="togglePause()">Pause</button>
        <button id="btn-sketch" onclick="toggleSketch()">Hide Sketch</button>
        <button id="btn-anim" onclick="toggleAnim()">Hide Animation</button>
    </div>
    <script>
        let myP5; let isPaused = false; let isSketchVisible = true; let isAnimVisible = true;
        const sketch = (p) => {
            

    class Particle {
        constructor(pos, vel, lifespan, color, size, gravity, sticky) {
            this.pos = pos;
            this.vel = vel;
            this.acc = p.createVector(0, 0);
            this.lifespan = lifespan;
            this.life = lifespan;
            this.color = color;
            this.size = size;
            this.gravity = gravity || p.createVector(0, 0);
            this.sticky = sticky;
            this.isStuck = false;
        }

        applyForce(force) {
            this.acc.add(force);
        }

        update() {
            if (this.isStuck) return;

            this.applyForce(this.gravity);
            this.vel.add(this.acc);
            this.pos.add(this.vel);
            this.acc.mult(0);
            this.life -= 1;

            // Check for ground collision for sticky particles (lava)
            if (this.sticky && this.pos.y >= p.vGroundY - this.size / 2) {
                // Stick to the ground/accumulate at base
                this.pos.y = p.vGroundY - this.size / 2;
                this.vel.mult(0);
                this.gravity.mult(0);
                this.isStuck = true;
                this.life = 10000; // Keep immortal once stuck
            }
        }

        display() {
            let alpha = 255;
            if (!this.isStuck) {
                alpha = p.map(this.life, 0, this.lifespan, 0, 255);
            }
            
            p.noStroke();
            
            if (Array.isArray(this.color)) {
                p.fill(this.color[0], this.color[1], this.color[2], alpha);
            } else {
                p.fill(this.color, alpha);
            }
           
            p.ellipse(this.pos.x, this.pos.y, this.size, this.size);
        }

        isDead() {
            return this.life < 0;
        }
    }

    class StickFigure {
        constructor(x, y, color) {
            this.pos = p.createVector(x, y);
            this.vel = p.createVector(0, 0);
            this.acc = p.createVector(0, 0);
            this.color = color;
            this.height = p.height * 0.1;
            this.armAngle = 0;
            this.armSpeedFactor = p.random(0.3, 0.5);
            this.headSize = this.height * 0.2;
            this.isRunning = false;
            this.maxSpeed = p.random(4, 6);
        }

        panic() {
            this.isRunning = true;
            this.acc.x = p.random(0.05, 0.1); 
        }

        update() {
            if (this.isRunning) {
                this.vel.add(this.acc);
                this.vel.x = p.min(this.vel.x, this.maxSpeed); 
                
                // Running/Flailing animation
                this.armAngle = p.sin(p.frameCount * this.armSpeedFactor * 2.5) * p.PI / 3;
            } else {
                // Idle sway
                this.armAngle = p.sin(p.frameCount * 0.05) * p.PI / 12;
            }
            this.pos.add(this.vel);
        }

        display() {
            p.stroke(this.color);
            p.strokeWeight(2);

            p.push();
            p.translate(this.pos.x, this.pos.y);

            const h = this.height;
            const hs = this.headSize;

            // Head
            p.noFill();
            p.ellipse(0, -h + hs / 2, hs, hs);

            // Body (Torso)
            p.line(0, -h + hs, 0, -h / 2);

            // Arm geometry
            const armLength = h * 0.4;
            const armAnchorY = -h + hs + h * 0.1;
            
            // Right Arm (Swinging back)
            p.line(0, armAnchorY, armLength * p.sin(-this.armAngle), armAnchorY + armLength * p.cos(-this.armAngle));

            // Left Arm (Swinging forward)
            p.line(0, armAnchorY, armLength * p.sin(this.armAngle), armAnchorY + armLength * p.cos(this.armAngle));

            // Legs (Slight gait variation)
            const legY = -h / 2;
            const legLength = h * 0.5;
            const legSwing = p.sin(p.frameCount * this.armSpeedFactor * (this.isRunning ? 1.5 : 0.5)) * h * 0.05;
            
            p.line(0, legY, legSwing * 1.5, legY + legLength);
            p.line(0, legY, -legSwing * 1.5, legY + legLength);

            p.pop();
        }
    }

    p.stickFigures = [];
    p.particles = [];       // Mild activity (Smoke/Sparks)
    p.lavaParticles = [];   // Catastrophic Lava
    p.eruptionStart = 0;
    p.eruptionTime = 4000; 
    p.isErupting = false;
    p.bgAlpha = 0; 
    
    // Volcano dimensions holder
    p.vCenterX; p.vGroundY; p.vHeight; p.vBaseWidth; p.vCraterWidth;

    p.drawVolcano = function() {
        p.push();
        
        let shakeX = 0;
        let shakeY = 0;
        if (p.isErupting) {
            // Rapid, noise-based oscillation
            shakeX = p.map(p.noise(p.frameCount * 0.5, 100), 0, 1, -3, 3);
            shakeY = p.map(p.noise(p.frameCount * 0.5 + 500), 0, 1, -1, 1);
        }
        
        // Draw volcano shape relative to its center, translated by shake
        p.translate(p.vCenterX + shakeX, shakeY);
        
        const halfBase = p.vBaseWidth / 2;
        const craterY = p.vGroundY - p.vHeight - shakeY;

        // Volcano Fill (Dark earth tone)
        p.fill(70, 50, 40);
        p.stroke(0);
        p.strokeWeight(2);

        p.beginShape();
        // Base Left
        p.vertex(-halfBase, p.vGroundY - shakeY);
        
        // Left Slope (Curved outline)
        p.bezierVertex(
            -halfBase / 2, p.vGroundY - p.vHeight * 0.1 - shakeY,
            -p.vCraterWidth * 4, craterY * 1.05,
            -p.vCraterWidth, craterY
        );
        
        // Crater Top
        p.vertex(p.vCraterWidth, craterY);
        
        // Right Slope
        p.bezierVertex(
            p.vCraterWidth * 4, craterY * 1.05,
            halfBase / 2, p.vGroundY - p.vHeight * 0.1 - shakeY,
            halfBase, p.vGroundY - shakeY
        );
        p.endShape(p.CLOSE);
        
        p.pop();
        
        // Draw Ground line 
        p.stroke(0);
        p.line(0, p.vGroundY, p.width, p.vGroundY);
    };

    p.emitMildActivity = function() {
        const vY_top = p.vGroundY - p.vHeight;
        const vX_center = p.vCenterX;
        
        // Phase 1 Sparks (stops when erupting)
        if (p.frameCount % 5 === 0 && !p.isErupting) {
            const pos = p.createVector(vX_center + p.random(-p.vCraterWidth / 2, p.vCraterWidth / 2), vY_top);
            const vel = p.createVector(p.random(-0.5, 0.5), p.random(-4, -2));
            const color = [255, p.random(100, 150), 0];
            const size = p.random(2, 4);
            const lifespan = 60;
            const gravity = p.createVector(0, 0.05);
            p.particles.push(new Particle(pos, vel, lifespan, color, size, gravity, false));
        }
        
        // Smoke (Continuous/Increasing)
        if (p.frameCount % (p.isErupting ? 4 : 10) === 0) {
            const pos = p.createVector(vX_center + p.random(-p.vCraterWidth, p.vCraterWidth), vY_top);
            // Smoke velocity is faster during eruption
            const vel = p.createVector(p.random(-0.3, 0.3), p.random(p.isErupting ? -3 : -1.5, p.isErupting ? -1.5 : -0.8));
            const gray = p.random(150, 200);
            const color = [gray, gray, gray];
            const size = p.random(5, 10);
            const lifespan = p.isErupting ? 180 : 120;
            const gravity = p.createVector(0, -0.01); 
            p.particles.push(new Particle(pos, vel, lifespan, color, size, gravity, false));
        }
    };

    p.emitCatastrophicLava = function() {
        const vY_top = p.vGroundY - p.vHeight;
        const vX_center = p.vCenterX;
        
        const emissionRate = 20;

        for (let i = 0; i < emissionRate; i++) {
            const pos = p.createVector(vX_center + p.random(-p.vCraterWidth, p.vCraterWidth), vY_top);
            
            // Launch angle aimed outwards and upwards
            const angle = p.random(p.PI * 0.65, p.PI * 1.35);
            const speed = p.random(8, 15); 
            
            const vel = p.createVector(p.cos(angle) * speed, p.sin(angle) * speed);
            
            const r = 255;
            const g = p.random(50, 150);
            const color = [r, g, 0]; 
            const size = p.random(8, 18);
            const lifespan = 500; 
            const gravity = p.createVector(0, 0.35); 
            
            p.lavaParticles.push(new Particle(pos, vel, lifespan, color, size, gravity, true));
        }
    };

    p.setup = function() {
        
        p.frameRate(60);

        p.vCenterX = p.width * 0.3;
        p.vGroundY = p.height * 0.8;
        p.vHeight = p.height * 0.6;
        p.vBaseWidth = p.width * 0.35;
        p.vCraterWidth = p.width * 0.015;

        // Initialize Stick Figures
        const figY = p.vGroundY;
        const initialX = p.width * 0.6;
        const spacing = p.width * 0.04;

        // Two blue figures, one green figure
        p.stickFigures.push(new StickFigure(initialX, figY, p.color(0, 0, 255)));
        p.stickFigures.push(new StickFigure(initialX + spacing, figY, p.color(0, 0, 255)));
        p.stickFigures.push(new StickFigure(initialX + 2 * spacing, figY, p.color(0, 200, 0)));
        
        p.eruptionStart = p.millis();
    };

    p.draw = function() {
        p.clear();
        
        // --- State Management ---
        if (!p.isErupting && p.millis() - p.eruptionStart > p.eruptionTime) {
            p.isErupting = true;
            p.stickFigures.forEach(f => f.panic());
        }

        // --- Background/Atmosphere Darkening ---
        if (p.isErupting) {
            p.bgAlpha = p.min(p.bgAlpha + 0.5, 120); 
        }
        p.fill(0, p.bgAlpha); 
        p.noStroke();
        p.rect(0, 0, p.width, p.height);

        // --- Draw initial red dashed lines (Phase 1 activity visualization) ---
        if (!p.isErupting) {
            p.stroke(255, 0, 0);
            p.strokeWeight(3);
            const cx = p.vCenterX;
            const cy = p.vGroundY - p.vHeight - 10;
            
            const j = p.random(-1, 1); // Jitter
            
            p.line(cx - 10 + j, cy + j, cx - 20, cy - 10);
            p.line(cx + 10 + j, cy + j, cx + 20, cy - 10);
            p.line(cx + j, cy - 5, cx + j, cy - 15);
        }

        // --- Volcano Drawing ---
        p.drawVolcano();

        // --- Particle Emission ---
        p.emitMildActivity(); 
        if (p.isErupting) {
            p.emitCatastrophicLava();
        }
        
        // --- Particle Update and Display ---
        
        // 1. Lava Flow (Displayed first, so accumulated lava is beneath the final ground line)
        for (let i = p.lavaParticles.length - 1; i >= 0; i--) {
            const pt = p.lavaParticles[i];
            pt.update();
            pt.display();
            
            if (pt.isDead() && !pt.isStuck) {
                p.lavaParticles.splice(i, 1);
            }
        }

        // 2. Smoke/Sparks
        for (let i = p.particles.length - 1; i >= 0; i--) {
            const pt = p.particles[i];
            pt.update();
            pt.display();
            
            if (pt.isDead()) {
                p.particles.splice(i, 1);
            }
        }

        // --- Stick Figure Update and Display ---
        for (let i = p.stickFigures.length - 1; i >= 0; i--) {
            const figure = p.stickFigures[i];
            figure.update();
            figure.display();
            
            // Check if figure ran off screen
            if (figure.pos.x > p.width + figure.height) {
                p.stickFigures.splice(i, 1);
            }
        }
    };

            const originalSetup = p.setup;
            p.setup = function() {
                p.createCanvas(window.innerWidth, window.innerHeight);
                p.clear(); 
                if (originalSetup) originalSetup.call(p);
            };
            p.windowResized = function() { p.resizeCanvas(window.innerWidth, window.innerHeight); p.clear(); }
        };
        window.onload = function() { if (typeof p5 !== 'undefined') { myP5 = new p5(sketch, 'sketch-holder'); } };
        function togglePause() {
            if (!myP5) return;
            const btn = document.getElementById('btn-pause');
            if (isPaused) { myP5.loop(); btn.innerText = "Pause"; btn.classList.remove('active'); isPaused = false; } 
            else { myP5.noLoop(); btn.innerText = "Resume"; btn.classList.add('active'); isPaused = true; }
        }
        function toggleSketch() {
            const el = document.getElementById('drawing-layer');
            const btn = document.getElementById('btn-sketch');
            if (isSketchVisible) { el.style.opacity = '0'; btn.innerText = "Show Sketch"; isSketchVisible = false; } 
            else { el.style.opacity = '1'; btn.innerText = "Hide Sketch"; isSketchVisible = true; }
        }
        function toggleAnim() {
            const el = document.getElementById('sketch-holder');
            const btn = document.getElementById('btn-anim');
            if (isAnimVisible) { el.style.display = 'none'; btn.innerText = "Show Animation"; isAnimVisible = false; } 
            else { el.style.display = 'block'; btn.innerText = "Hide Animation"; isAnimVisible = true; }
        }
    </script>
</body>
</html>