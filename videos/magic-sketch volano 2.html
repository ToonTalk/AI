<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Sketch Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: white; height: 100vh; width: 100vw; font-family: sans-serif; }
        #drawing-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABCYAAAEpCAYAAABPxSNNAAAQAElEQVR4AezYSW4ryQ4F0I+//0UXNFDBLjXOJho25wGGrVQkgzx8o/v///lHgAABAgQIECBAgAABAgQIVBcIO59gIuxqNEaAAAECBAgQIECAAAEC+QR0fFZAMHFWzHkCBAgQIECAAAECBAgQ2C+ggzICgokyqzQIAQIECBAgQIAAAQIExguoSGC2gGBitrD6BAgQIECAAAECBAgQ+FvACQJtBQQTbVdvcAIECBAgQIAAAQIdBcxMgEA0AcFEtI3ohwABAgQIECBAgEAFATMQIEDgoIBg4iCUYwQIECBAgAABAgQiCuiJAAEC2QUEE9k3qH8CBAgQIECAAIEVAu4gQIAAgUkCgolJsMoSIECAAAECBAhcEfAOAQIECHQTEEx027h5CRAgQIAAAQIPAT8ECBAgQCCIgGAiyCK0QYAAAQIECNQUMBUBAgQIECDwXUAw8d3HtwQIECBAgEAOAV0SIECAAAECSQUEE0kXp20CBAgQILBHwK0ECBAgQIAAgbECgomxnqoRIECAAIExAqoQIECAAAECBJoICCaaLNqYBAgQIPBewFMCBAgQIECAAIG9AoKJvf5uJ0CAQBcBcxIgQIAAAQIECBB4KyCYeMviIQECBLIK6JsAAQIECBAgQIBALgHBRK596ZYAgSgC+iBAgAABAgQIECBAYIiAYGIIoyIECMwSUJcAAQIECBAgQIAAgdoCgona+zUdgaMCzhEgQIAAAQIECBAgQGCLgGBiC7tL+wqYnAABAgQIECBAgAABAgR+Cggmfmr4u46ASQgQIECAAAECBAgQIEAghYBgIsWa4japMwIECBAgQIAAAQIECBAgcEdAMHFHb927biJAgAABAgQIECBAgAABAiUFBBO/1uoDAQIECBAgQIAAAQIECBAgsFJgTzCxckJ3ESBAgAABAgQIECBAgAABAnsEDtwqmDiA5AgBAgQIECBAgAABAgQIEIgskLk3wUTm7emdAAECBAgQIECAAAECBFYKuGuCgGBiAqqSBAgQIECAAAECBAgQIHBHwLudBAQTnbZtVgIECBAgQIAAAQIECPwU8DeBAAKCiQBL0AIBAgQIECBAgAABArUFTEeAwGcBwcRnG98QIECAAAECBAgQIJBLQLcECCQUEEwkXJqWCRAgQIAAAQIECOwVcDsBAgTGCQgmxlmqRIAAAQIECBAgQGCsgGoECBBoICCYaLBkIxIgQIAAAQIECHwX8C0BAgQI7BMQTOyzdzMBAgQIECBAoJuAeQkQIECAwIuAYOKFxAMCBAgQIECAQHYB/RMgQIAAgTwCgok8u9IpAQIECBAgEE1APwQIECBAgMBtAcHEbUIFCBAgQIAAgdkC6hMgQIAAAQJ1BQQTdXdrMgIECBAgcFbAeQIECBAgQIDAcgHBxHJyFxIgQIAAAQIECBAgQIAAAQJPAcHEU8JvAgQIEKgnYCICBAgQIECAAIHwAoKJ8CvSIAECBOIL6JAAAQIECBAgQIDAVQHBxFU57xEgQGC9gBsJECBAgAABAgQIlBMQTJRbqYEIELgvoAIBAgQIECBAgAABAqsEBBOrpN1DgMCrgCcECBAgQIAAAQIECLQXEEy0/y8AoIOAGQkQIECAAAECBAgQIBBVQDARdTP6yiigZwIECBAgQIAAAQIECBA4KSCYOAnmeAQBPRAgQIAAAQIECBAgQIBAFQHBRJVNzphDTQIECBAgQIAAAQIECBAgMFlAMDEZ+Eh5ZwgQIECAAAECBAgQIECAQFeBTsFE1x2bmwABAgQIECBAgAABAgQIhBWYEEyEnVVjBAgQIECAAAECBAgQIECAwDCBMYUEE2McVSFAgAABAgQIECBAgAABAnMEilcVTBRfsPEIECBAgAABAgQIECBA4JiAU3sEBBN73N1KgAABAgQIECBAgACBrgLmJvBLQDDxi8MHAgQIECBAgAABAgQIVBEwB4EcAoKJHHvSJQECBAgQIECAAAECUQX0RYDALQHBxC0+LxMgQIAAAQIECBAgsErAPQQI1BQQTNTcq6kIECBAgAABAgQIXBXwHgECBJYKCCaWcruMAAECBAgQIECAwFPAbwIECBB4CAgmHgp+CBAgQIAAAQIE6gqYjAABAgRCCwgmQq9HcwQIECBAgACBPAI6JUCAAAECVwQEE1fUvEOAAAECBAgQ2CfgZgIECBAgUEpAMFFqnYYhQIAAAQIExgmoRIAAAQIECKwQEEysUHYHAQIECBAg8FnANwQIECBAgEBrAcFE6/UbngABAgQ6CZiVAAECBAgQIBBRQDARcSt6IkCAAIHMAnonQIAAAQIECBA4ISCYOIHlKAECBAhEEtALAQIECBAgQIBABQHBRIUtmoEAAQIzBdQmQIAAAQIECBAgMFFAMDERV2kCBAicEXCWAAECBAgQIECAQEcBwUTHrZuZQG8B0xMgQIAAAQIECBAgEEhAMBFoGVohUEvANAQIECBAgAABAgQIEPhbQDDxt5ETBGIL6I4AAQIECBAgQIAAAQKJBQQTiZen9bUCbiNAgAABAgQIECBAgACB8QKCifGmKt4T8DYBAgQIECBAgAABAgQINBIQTDRa9u9RfSJAgAABAgQIECBAgAABAvsFBBOzd6A+AQIECBAgQIAAAQIECBAg8FGgTDDxcUJfECBAgAABAgQIECBAgAABAmEFzgYTYQfRGAECBAgQIECAAAECBAgQIDBMYFkhwcQyahcRIECAAAECBAgQIECAAIH/CvgsmPB/gAABAgQIECBAgAABAgTqC5gwrIBgIuxqNEaAAAECBAgQIECAAIF8AjomcFZAMHFWzHkCBAgQIECAAAECBAjsF9ABgTICgokyqzQIAQIECBAgQIAAAQLjBVQkQGC2gGBitrD6BAgQIECAAAECBAj8LeAEAQJtBQQTbVdvcAIECBAgQIAAgY4CZiZAgEA0AcFEtI3ohwABAgQIECBAoIKAGQgQIEDgoIBg4iCUYwQIECBAgAABAhEF9ESAAAEC2QUEE9k3qH8CBAgQIECAwAoBdxAgQIAAgUkCgolJsMoSIECAAAECBK4IeIcAAQIECHQTEEx027h5CRAgQIAAgYeAHwIECBAgQCCIgGAiyCK0QYAAAQIEagqYigABAgQIECDwXUAw8d3HtwQIECBAIIeALgkQIECAAAECSQUEE0kXp20CBAgQ2CPgVgIECBAgQIAAgbECgomxnqoRIECAwBgBVQgQIECAAAECBJoICCaaLNqYBAgQeC/gKQECBAgQIECAAIG9AoKJvf5uJ0Cgi4A5CRAgQIAAAQIECBB4KyCYeMviIQECWQX0TYAAAQIECBAgQIBALgHBRK596ZZAFAF9ECBAgAABAgQIECBAYIiAYGIIoyIEZgmoS4AAAQIECBAgQIAAgdoCgona+zXdUQHnCBAgQIAAAQIECBAgQGCLgGBiC3vfS01OgAABAgQIECBAgAABAgR+CggmfmrU+dskBAgQIECAAAECBAgQIEAghYBg4taavEyAAAECBAgQIECAAAECBAjcEcgRTNyZ0LsECBAgQIAAAQIECBAgQIBAWIFfwUTYLjVGgAABAgQIECBAgAABAgQIDBOIVEgwEWkbeiFAgAABAgQIECBAgACBSgJmOSAgmDiA5AgBAgQIECBAgAABAgQIRBbQW2YBwUTm7emdAAECBAgQIECAAAECKwXcRWCCgGBiAqqSBAgQIECAAAECBAgQuCPgXQKdBAQTnbZtVgIECBAgQIAAAQIEfgr4mwCBAAKCiQBL0AIBAgQIECBAgACB2gKmI0CAwGcBwcRnG98QIECAAAECBAgQyCWgWwIECCQUEEwkXJqWCRAgQIAAAQIE9gq4nQABAgTGCQgmxlmqRIAAAQIECBAgMFZANQIECBBoICCYaLBkIxIgQIAAAQIEvgv4lgABAgQI7BMQTOyzdzMBAgQIECDQTcC8BAgQIECAwIuAYOKFxAMCBAgQIEAgu4D+CRAgQIAAgTwCgok8u9IpAQIECBCIJqAfAgQIECBAgMBtAcHEbUIFCBAgQIDAbAH1CRAgQIAAAQJ1BQQTdXdrMgIECBA4K+A8AQIECBAgQIDAcgHBxHJyFxIgQIAAAQIECBAgQIAAAQJPAcHEU8JvAgQI1BMwEQECBAgQIECAAIHwAoKJ8CvSIAEC8QV0SIAAAQIECBAgQIDAVQHBxFU57xEgsF7AjQQIECBAgAABAgQIlBMQTJRbqYEI3BdQgQABAgQIECBAgAABAqsEBBOrpN1D4FXAEwIECBAgQIAAAQIECLQXEEy0/y/QAcCMBAgQIECAAAECBAgQIBBVQDARdTMZ+9IzAQIECBAgQIAAAQIECBA4KSCYOAkW4bgeCBAgQIAAAQIECBAgQIBAFQHBxOdN+oYAAQIECBAgQIAAAQIECBCYLBAgmJg8ofIECBAgQIAAAQIECBAgQIBAAIH3LQgm3rt4SoAAAQIECBAgQIAAAQIEcgok61owkWxh2iVAgAABAgQIECBAgACBGAK6GCMgmBjjqAoBAgQIECBAgAABAgQIzBFQtbiAYKL4go1HgAABAgQIECBAgACBYwJOEdgjIJjY4+5WAgQIECBAgAABAgS6CpibAIFfAoKJXxw+ECBAgAABAgQIECBQRcAcBAjkEBBM5NiTLgkQIECAAAECBAhEFdAXAQIEbgkIJm7xeZkAAQIECBAgQIDAKgH3ECBAoKaAYKLmXk1FgAABAgQIECBwVcB7BAgQILBUQDCxlNtlBAgQIECAAAECTwG/CRAgQIDAQ0Aw8VDwQ4AAAQIECBCoK2AyAgQIECAQWkAwEXo9miNAgAABAgTyCOiUAAECBAgQuCIgmLii5h0CBAgQIEBgn4CbCRAgQIAAgVICgolS6zQMAQIECBAYJ6ASAQIECBAgQGCFgGBihbI7CBAgQIDAZwHfECBAgAABAgRaCwgmWq/f8AQIEOgkYFYCBAgQIECAAIGIAoKJiFvREwECBDIL6J0AAQIECBAgQIDACQHBxAksRwkQIBBJQC8ECBAgQIAAAQIEKggIJips0QwECMwUUJsAAQIECBAgQIAAgYkCgomJuEoTIHBGwFkCBAgQIECAAAECBDoKCCY6bt3MvQVMT4AAAQIECBAgQIAAgUACgolAy9BKLQHTECBAgAABAgQIECBAgMDfAoKJv42ciC2gOwIECBAgQIAAAQIECBBILCCYSLy8ta27jQABAgQIECBAgAABAgQIjBcQTIw3vVfR2wQIECBAgAABAgQIECBAoJFA22Ci0Y6NSoAAAQIECBAgQIAAAQIEwgrMDibCDq4xAgQIECBAgAABAgQIECBAYJjA5UKCict0XiRAgAABAgQIECBAgAABAqsF6t0nmKi3UxMRIECAAAECBAgQIECAwF0B7y8TEEwso3YRAQIECBAgQIAAAQIECPxXwGcCggn/BwgQIECAAAECBAgQIFBfwIQEwgoIJsKuRmMECBAgySZSmwAADKNJREFUQIAAAQIECOQT0DEBAmcFBBNnxZwnQIAAAQIECBAgQGC/gA4IECgjIJgos0qDECBAgAABAgQIEBgvoCIBAgRmCwgmZgurT4AAAQIECBAgQOBvAScIECDQVkAw0Xb1BidAgAABAgQIdBQwMwECBAhEExBMRNuIfggQIECAAAECFQTMQIAAAQIEDgoIJg5COUaAAAECBAgQiCigJwIECBAgkF1AMJF9g/onQIAAAQIEVgi4gwABAgQIEJgkIJiYBKssAQIECBAgcEXAOwQIECBAgEA3AcFEt42blwABAgQIPAT8ECBAgAABAgSCCAgmgixCGwQIECBQU8BUBAgQIECAAAEC3wUEE999fEuAAAECOQR0SYAAAQIECBAgkFRAMJF0cdomQIDAHgG3EiBAgAABAgQIEBgrIJgY66kaAQIExgioQoAAAQIECBAgQKCJgGCiyaKNSYDAewFPCRAgQIAAAQIECBDYKyCY2OvvdgJdBMxJgAABAgQIECBAgACBtwKCibcsHhLIKqBvAgQIECBAgAABAgQI5BIQTOTal26jCOiDAAECBAgQIECAAAECBIYICCaGMCoyS0BdAgQIECBAgAABAgQIEKgtIJiovd+j0zlHgAABAgQIECBAgAABAgS2CAgmlrK7jAABAgQIECBAgAABAgQIEPgpUDOY+DmhvwkQIECAAAECBAgQIECAAIGwAreCibBTaYwAAQIECBAgQIAAAQIECBAYJjCzkGBipq7aBAgQIECAAAECBAgQIEDguEDLk4KJlms3NAECBAgQIECAAAECBDoLmD2SgGAi0jb0QoAAAQIECBAgQIAAgUoCZiFwQEAwcQDJEQIECBAgQIAAAQIECEQW0BuBzAKCiczb0zsBAgQIECBAgAABAisF3EWAwAQBwcQEVCUJECBAgAABAgQIELgj4F0CBDoJCCY6bdusBAgQIECAAAECBH4K+JsAAQIBBAQTAZagBQIECBAgQIAAgdoCpiNAgACBzwKCic82viFAgAABAgQIEMgloFsCBAgQSCggmEi4NC0TIECAAAECBPYKuJ0AAQIECIwTEEyMs1SJAAECBAgQIDBWQDUCBAgQINBAQDDRYMlGJECAAAECBL4L+JYAAQIECBDYJyCY2GfvZgIECBAg0E3AvAQIECBAgACBFwHBxAuJBwQIECBAILuA/gkQIECAAAECeQQEE3l2pVMCBAgQiCagHwIECBAgQIAAgdsCgonbhAoQIECAwGwB9QkQIECAAAECBOoKCCbq7tZkBAgQOCvgPAECBAgQIECAAIHlAoKJ5eQuJECAAAECBAgQIECAAAECBJ4CgomnhN8ECNQTMBEBAgQIECBAgAABAuEFBBPhV6RBAvEFdEiAAAECBAgQIECAAIGrAoKJq3LeI7BewI0ECBAgQIAAAQIECBAoJyCYKLdSA90XUIEAAQIECBAgQIAAAQIEVgkIJlZJu+dVwBMCBAgQIECAAAECBAgQaC8gmGjwX8CIBAgQIECAAAECBAgQIEAgqoBgYtxmVCJAgAABAgQIECBAgAABAgROCiQMJk5O6DgBAgQIECBAgAABAgQIECAQVuBzMBG2ZY0RIECAAAECBAgQIECAAAECwwQ2FxJMbF6A6wkQIECAAAECBAgQIECgh4Ap3wsIJt67eEqAAAECBAgQIECAAAECOQV0nUxAMJFsYdolQIAAAQIECBAgQIBADAFdEBgjIJgY46gKAQIECBAgQIAAAQIE5gioSqC4gGCi+IKNR4AAAQIECBAgQIDAMQGnCBDYIyCY2OPuVgIECBAgQIAAAQJdBcxNgACBXwKCiV8cPhAgQIAAAQIECBCoImAOAgQI5BAQTOTYky4JECBAgAABAgSiCuiLAAECBG4JCCZu8XmZAAECBAgQIEBglYB7CBAgQKCmgGCi5l5NRYAAAQIECBC4KuA9AgQIECCwVEAwsZTbZQQIECBAgACBp4DfBAgQIECAwENAMPFQ8EOAAAECBAjUFTAZAQIECBAgEFpAMBF6PZojQIAAAQJ5BHRKgAABAgQIELgiIJi4ouYdAgQIECCwT8DNBAgQIECAAIFSAoKJUus0DAECBAiME1CJAAECBAgQIEBghYBgYoWyOwgQIEDgs4BvCBAgQIAAAQIEWgsIJlqv3/AECHQSMCsBAgQIECBAgACBiAKCiYhb0RMBApkF9E6AAAECBAgQIECAwAkBwcQJLEcJEIgkoBcCBAgQIECAAAECBCoICCYqbNEMBGYKqE2AAAECBAgQIECAAIGJAoKJibhKEzgj4CwBAgQIECBAgAABAgQ6CggmOm6998ymJ0CAAAECBAgQIECAAIFAAoKJQMuo1YppCBAgQIAAAQIECBAgQIDA3wKCib+NYp/QHQECBAgQIECAAAECBAgQSCwgmDi4PMcIECBAgAABAgQIECBAgACB8QLRgonxE6pIgAABAgQIECBAgAABAgQIRBP4tx/BxL8U/iBAgAABAgQIECBAgAABAtUE4s8jmIi/Ix0SIECAAAECBAgQIECAQHQB/V0WEExcpvMiAQIECBAgQIAAAQIECKwWcF89AcFEvZ2aiAABAgQIECBAgAABAncFvE9gmYBgYhm1iwgQIECAAAECBAgQIPBfAZ8JEBBM+D9AgAABAgQIECBAgEB9ARMSIBBWQDARdjUaI0CAAAECBAgQIJBPQMcECBA4KyCYOCvmPAECBAgQIECAAIH9AjogQIBAGQHBRJlVGoQAAQIECBAgQGC8gIoECBAgMFtAMDFbWH0CBAgQIECAAIG/BZwgQIAAgbYCgom2qzc4AQIECBAg0FHAzAQIECBAIJqAYCLaRvRDgAABAgQIVBAwAwECBAgQIHBQQDBxEMoxAgQIECBAIKKAnggQIECAAIHsAoKJ7BvUPwECBAgQWCHgDgIECBAgQIDAJAHBxCRYZQkQIECAwBUB7xAgQIAAAQIEugkIJrpt3LwECBAg8BDwQ4AAAQIECBAgEERAMBFkEdogQIBATQFTESBAgAABAgQIEPguIJj47uNbAgQI5BDQJQECBAgQIECAAIGkAoKJpIvTNgECewTcSoAAAQIECBAgQIDAWAHBxFhP1QgQGCOgCgECBAgQIECAAAECTQQEE00WbUwC7wU8JUCAAAECBAgQIECAwF4BwcRef7d3ETAnAQIECBAgQIAAAQIECLwVEEy8ZfEwq4C+CRAgQIAAAQIECBAgQCCXgGAi176idKsPAgQIECBAgAABAgQIECAwREAwMYRxVhF1CRAgQIAAAQIECBAgQIBAbQHBxGO/fggQIECAAAECBAgQIECAAIEtAkuDiS0TupQAAQIECBAgQIAAAQIECBBYKnDmMsHEGS1nCRAgQIAAAQIECBAgQIBAHIESnQgmSqzREAQIECBAgAABAgQIECAwT0DlmQKCiZm6ahMgQIAAAQIECBAgQIDAcQEnWwoIJlqu3dAECBAgQIAAAQIECHQWMDuBSAKCiUjb0AsBAgQIECBAgAABApUEzEKAwAEBwcQBJEcIECBAgAABAgQIEIgsoDcCBDILCCYyb0/vBAgQIECAAAECBFYKuIsAAQITBAQTE1CVJECAAAECBAgQIHBHwLsECBDoJCCY6LRtsxIgQIAAAQIECPwU8DcBAgQIBBAQTARYghYIECBAgAABArUFTEeAAAECBD4LCCY+2/iGAAECBAgQIJBLQLcECBAgQCChgGAi4dK0TIAAAQIECOwVcDsBAgQIECAwTkAwMc5SJQIECBAgQGCsgGoECBAgQIBAAwHBRIMlG5EAAQIECHwX8C0BAgQIECBAYJ+AYGKfvZsJECBAoJuAeQkQIECAAAECBF4EBBMvJB4QIECAQHYB/RMgQIAAAQIECOQREEzk2ZVOCRAgEE1APwQIECBAgAABAgRuCwgmbhMqQIAAgdkC6hMgQIAAAQIECBCoKyCYqLtbkxEgcFbAeQIECBAgQIAAAQIElgsIJpaTu5AAAQIECBAgQIAAAQIECBB4CggmnhJ+E6gnYCICBAgQIECAAAECBAiEFxBMhF+RBuML6JAAAQIECBAgQIAAAQIErgoIJq7KeW+9gBsJECBAgAABAgQIECBAoJyAYKLcSu8PpAIBAgQIECBAgAABAgQIEFglIJhYJf16jycECBAgQIAAAQIECBAgQKC9QINgov2OARAgQIAAAQIECBAgQIAAgbAC44KJsCNqjAABAgQIECBAgAABAgQIEBgmMLiQYGIwqHIECBAgQIAAAQIECBAgQGCEQJcagokumzYnAQIECBAgQIAAAQIECLwT8GyzwD8AAAD//1o+bekAAAAGSURBVAMA0w0CU0oPjIYAAAAASUVORK5CYII='); background-size: 100% 100%; background-repeat: no-repeat; background-position: center; transition: opacity 0.3s; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 10; }
        #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 10px; background: rgba(255, 255, 255, 0.9); padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button { background: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; color: #475569; transition: all 0.2s; }
        button:hover { background: #f1f5f9; }
        button.active { background: #e0e7ff; color: #4f46e5; border-color: #c7d2fe; }
    </style>
</head>
<body>
    <div id="drawing-layer"></div>
    <div id="sketch-holder"></div>
    <div id="controls">
        <button id="btn-pause" onclick="togglePause()">Pause</button>
        <button id="btn-sketch" onclick="toggleSketch()">Hide Sketch</button>
        <button id="btn-anim" onclick="toggleAnim()">Hide Animation</button>
    </div>
    <script>
        let myP5; let isPaused = false; let isSketchVisible = true; let isAnimVisible = true;
        const sketch = (p) => {
            
    // --- Constants ---
    const ERUPTION_TIME = 3000; // Time in milliseconds until major eruption
    const GRAVITY = p.createVector(0, 0.2);
    let eruptionStartMillis;

    // --- Core Classes ---

    class Particle {
        constructor(pos, vel, color, size, life) {
            this.pos = pos.copy();
            this.vel = vel.copy();
            this.acc = p.createVector(0, 0);
            this.color = color;
            this.r = size;
            this.lifespan = life;
            this.maxLife = life;
            // Determine if the particle is intended for flow/heavy impact
            this.isLava = size > 4 && vel.y > -5; 
        }

        applyForce(force) {
            this.acc.add(force);
        }

        update() {
            if (!this.isLava) {
                // Apply drag for airborne particles
                let drag = this.vel.copy();
                drag.normalize();
                drag.mult(-0.01);
                this.applyForce(drag);
                
                this.applyForce(GRAVITY);
            } else {
                // Lava flows downhill, slight gravity pull
                this.applyForce(GRAVITY.copy().mult(0.5)); 
            }

            this.vel.add(this.acc);
            this.pos.add(this.vel);
            this.acc.mult(0);
            this.lifespan -= this.isLava ? 1 : 2; // Lava fades slower
        }
        
        // Custom collision/flow logic for lava
        checkFlow(volcanoBaseY, apexX, apexY) {
            if (this.isLava) {
                
                // Simplified volcano slope check: left slope only
                if (this.pos.x < apexX && this.pos.x > (apexX - 250) && this.pos.y > apexY && this.pos.y < volcanoBaseY) {
                    
                    // Calculate slope factor based on height down the volcano
                    let slopeFactor = p.map(this.pos.y, apexY, volcanoBaseY, 0.5, 0.05);
                    
                    // Apply a force generally towards the bottom left along the slope
                    let downhillForce = p.createVector(-slopeFactor * 0.5, slopeFactor);
                    this.applyForce(downhillForce);
                }

                // Stop at the ground
                if (this.pos.y >= volcanoBaseY - this.r) {
                    this.pos.y = volcanoBaseY - this.r;
                    this.vel.mult(p.createVector(0.8, 0)); // Stop vertical movement, slow horizontal creep
                    this.lifespan -= 5;
                }
            }
        }

        display() {
            p.push();
            let alpha = p.map(this.lifespan, 0, this.maxLife, 0, 255);
            let c = p.color(this.color);
            c.setAlpha(alpha);
            p.noStroke();
            p.fill(c);
            p.ellipse(this.pos.x, this.pos.y, this.r, this.r);
            p.pop();
        }

        isDead() {
            return this.lifespan < 0;
        }
    }

    class ParticleSystem {
        constructor(origin) {
            this.origin = origin.copy();
            this.particles = [];
            this.emissionRate = 0.5; // Particles per frame
            this.isMajorErupting = false;
        }

        addParticle(vel, size, color, life) {
            this.particles.push(new Particle(this.origin, vel, color, size, life));
        }

        run(volcanoBaseY, apexX, apexY) {
            let rateMultiplier = this.isMajorErupting ? 10 : 1;

            // Emit eruption particles (lava bombs/sparks)
            for (let i = 0; i < p.floor(this.emissionRate * rateMultiplier); i++) {
                if (p.random(1) < (this.emissionRate * rateMultiplier) % 1) {
                    this.emitEruption(this.isMajorErupting);
                }
            }

            // Continuous emission for smoke/ash
            this.emitSmoke(this.isMajorErupting);

            for (let i = this.particles.length - 1; i >= 0; i--) {
                let pt = this.particles[i];
                pt.update();
                pt.checkFlow(volcanoBaseY, apexX, apexY);
                pt.display();
                if (pt.isDead()) {
                    this.particles.splice(i, 1);
                }
            }
        }

        emitEruption(isMajor) {
            let vel;
            let size;
            let color;
            let life;
            let rnd = p.random(1);

            if (isMajor) {
                // High velocity lava bombs and ash
                if (rnd < 0.7) {
                    // Lava bombs
                    vel = p.createVector(p.random(-2.5, 2.5), p.random(-18, -10));
                    size = p.random(4, 10);
                    color = p.random([p.color(255, 69, 0), p.color(255, 140, 0), p.color(255, 0, 0)]); // Red/Orange
                    life = p.random(150, 250);
                } else {
                    // Ash cloud
                    vel = p.createVector(p.random(-1, 1), p.random(-10, -5));
                    size = p.random(1, 3);
                    color = p.color(50, p.random(100, 200)); // Dark grey with high alpha
                    life = p.random(100, 200);
                }
            } else {
                // Minor smoke/initial red sparks
                vel = p.createVector(p.random(-0.5, 0.5), p.random(-3, -1));
                size = p.random(1, 3);
                color = p.color(255, 0, 0, p.random(100, 200));
                life = p.random(50, 100);
            }
            this.addParticle(vel, size, color, life);
        }
        
        emitSmoke(isMajor) {
            // Wispy, dark smoke using noise
            if (p.frameCount % (isMajor ? 3 : 10) === 0) {
                let vel = p.createVector(p.random(-0.5, 0.5), p.random(-2, -0.5));
                let size = p.random(5, 15);
                // Using frameCount + noise to vary smoke density and color slightly
                let noiseColor = p.map(p.noise(p.frameCount * 0.01), 0, 1, 30, 60);
                let color = p.color(noiseColor, noiseColor, noiseColor, p.random(50, 150));
                let life = p.random(150, 300);
                this.addParticle(vel, size, color, life);
            }
        }
        
        // Specialized lava flow generation
        emitLavaFlow() {
             if (this.isMajorErupting && p.frameCount % 5 === 0) {
                 // Lava starts flowing from a higher point on the slope (simulating overflow)
                 // Start position is slightly offset from apex, down the left side.
                 let flowOriginX = this.origin.x + p.random(-15, 15); 
                 let flowOriginY = this.origin.y + p.random(20, 50);
                 
                 let flowOrigin = p.createVector(flowOriginX, flowOriginY);
                 let vel = p.createVector(p.random(-0.5, 0), p.random(0.5, 1.5));
                 let size = p.random(5, 12);
                 let color = p.random([p.color(255, 80, 0), p.color(255, 120, 0)]);
                 let life = p.random(300, 500);
                 
                 this.particles.push(new Particle(flowOrigin, vel, color, size, life));
             }
        }
    }


    class StickFigure {
        constructor(x, y, color) {
            this.pos = p.createVector(x, y);
            this.color = color;
            this.height = 30;
            this.state = 'IDLE';
            this.gaitPhase = p.random(p.TWO_PI);
            this.speed = 0;
            this.offsetY = 0; // For idle bobbing or running jump
        }

        update() {
            // Gait phase updates slightly even when idle, faster when running
            this.gaitPhase += 0.2 * (this.state === 'RUNNING' ? 1.5 : 0.2);

            if (this.state === 'RUNNING') {
                this.speed = 3.5; // Fast escape speed
                this.pos.x += this.speed;
                // Bobbing simulates frantic running
                this.offsetY = p.sin(this.gaitPhase * 2) * 2; 

            } else if (this.state === 'IDLE') {
                this.speed = 0;
                this.offsetY = p.sin(p.frameCount * 0.1) * 0.5; // Subtle idle bob
            }
        }

        drawLimb(start, angleRad, length) {
            let endX = start.x + p.cos(angleRad) * length;
            let endY = start.y + p.sin(angleRad) * length;
            // Apply minor jitter for hand-drawn look
            endX += p.random(-0.5, 0.5);
            endY += p.random(-0.5, 0.5);
            p.line(start.x, start.y, endX, endY);
            return p.createVector(endX, endY);
        }

        display() {
            p.push();
            p.translate(this.pos.x, this.pos.y + this.offsetY);
            p.stroke(this.color);
            p.strokeCap(p.ROUND);
            p.strokeWeight(3);
            
            // Core relative positions
            const headY = -this.height;
            const bodyY = headY + 7;
            const hipY = bodyY + 10;
            
            let armSwing = p.sin(this.gaitPhase * (this.state === 'RUNNING' ? 1 : 0.5));
            let legSwing1 = p.sin(this.gaitPhase * (this.state === 'RUNNING' ? 1.5 : 0.5));
            let legSwing2 = p.sin(this.gaitPhase * (this.state === 'RUNNING' ? 1.5 : 0.5) + p.PI);

            // 1. Head
            p.noFill();
            p.ellipse(0, headY, 10, 10);
            
            // 2. Body
            const neck = p.createVector(0, headY + 5);
            const hip = p.createVector(0, hipY);
            p.line(neck.x, neck.y, hip.x, hip.y);
            
            // 3. Arms (Start from neck/shoulder area)
            const shoulder = p.createVector(0, bodyY);
            const armLen = 12;
            
            // Arm 1 (swinging forward/backward)
            this.drawLimb(shoulder, p.HALF_PI + armSwing * 0.8, armLen);
            // Arm 2
            this.drawLimb(shoulder, p.HALF_PI + -armSwing * 0.8, armLen);

            // 4. Legs (Start from hip)
            const legLen = 15;
            const kneeLen = 15;
            
            // Leg 1 (Front leg)
            let legAngle1 = p.map(legSwing1, -1, 1, 0.3, 1.2); 
            let kneePos1 = this.drawLimb(hip, p.HALF_PI + legAngle1, legLen);
            // Lower leg (bent back slightly)
            this.drawLimb(kneePos1, p.HALF_PI + legAngle1 * 0.5 + 0.5, kneeLen);


            // Leg 2 (Back leg)
            let legAngle2 = p.map(legSwing2, -1, 1, 0.3, 1.2);
            let kneePos2 = this.drawLimb(hip, p.HALF_PI + legAngle2, legLen);
            // Lower leg
            this.drawLimb(kneePos2, p.HALF_PI + legAngle2 * 0.5 + 0.5, kneeLen);
            
            p.pop();
        }
    }


    // --- Instance Variables ---
    let ps;
    let figures = [];
    let isEruptingMajor = false;

    // Volcano Geometry
    let apex, leftBase, rightBase;
    let groundY;
    let shakeOffset = 0;
    let shakeIntensity = 0;

    p.setup = function() {
        
        eruptionStartMillis = p.millis();
        p.angleMode(p.RADIANS);
        
        groundY = p.height * 0.9;
        
        // Volcano Points
        apex = p.createVector(p.width * 0.3, p.height * 0.2);
        leftBase = p.createVector(p.width * 0.05, groundY);
        rightBase = p.createVector(p.width * 0.55, groundY);

        ps = new ParticleSystem(apex);

        // Stick Figures (Starting to the right of the volcano)
        const startX = p.width * 0.65;
        figures.push(new StickFigure(startX, groundY, p.color(0, 191, 255))); // Deep Cyan
        figures.push(new StickFigure(startX + 25, groundY, p.color(0, 128, 255))); // Blue
        figures.push(new StickFigure(startX + 50, groundY, p.color(0, 255, 0))); // Green
    };

    // Helper to draw the static volcano shape
    p.drawVolcano = function() {
        p.noStroke();
        // Base color (dark grey/brown)
        p.fill(40, 30, 20); 
        
        // Main Cone
        p.beginShape();
        p.vertex(apex.x - 5, apex.y); // Crater left
        p.vertex(leftBase.x, leftBase.y);
        p.vertex(rightBase.x, rightBase.y);
        p.vertex(apex.x + 5, apex.y); // Crater right
        p.endShape(p.CLOSE);
        
        // Crater Glow (Atmospherics)
        p.noStroke();
        p.fill(255, 100, 0, 80); // Soft orange glow
        p.ellipse(apex.x, apex.y, 25, 25); 
    };
    
    // Helper for screen shake effect
    p.updateShake = function() {
        if (isEruptingMajor) {
            // Shake intensity ramps up slowly
            shakeIntensity = p.min(5, p.map(p.millis() - (eruptionStartMillis + ERUPTION_TIME), 0, 5000, 0.5, 5));
            shakeOffset = p.random(-shakeIntensity, shakeIntensity);
        } else {
            shakeIntensity = 0;
            shakeOffset = 0;
        }
    }

    p.draw = function() {
        // --- 1. Environment Setup (Dark/Twilight) ---
        p.fill(15, 15, 25, 255); 
        p.rect(0, 0, p.width, p.height); 

        // Apply screen shake offset
        p.push();
        p.updateShake();
        p.translate(shakeOffset, shakeOffset);

        // --- 2. Eruption Logic & Trigger ---
        if (!isEruptingMajor && (p.millis() - eruptionStartMillis) > ERUPTION_TIME) {
            isEruptingMajor = true;
            // Transition figures to panic state
            figures.forEach(f => f.state = 'RUNNING');
            ps.isMajorErupting = true;
        }

        // --- 3. Draw Ground ---
        p.noStroke();
        p.fill(34, 139, 34); // Forest Green
        p.rect(0, groundY, p.width, p.height - groundY);

        // --- 4. Draw Volcano Structure ---
        p.drawVolcano();
        
        // --- 5. Lava Flow Simulation ---
        if (isEruptingMajor) {
            ps.emitLavaFlow(); 
        }

        // --- 6. Run Particle System (Lava Bombs/Ash/Smoke) ---
        ps.run(groundY, apex.x, apex.y);

        // --- 7. Draw Stick Figures ---
        figures.forEach(f => {
            f.update();
            f.display();
        });
        
        p.pop(); // End screen shake translation
    };

            const originalSetup = p.setup;
            p.setup = function() {
                p.createCanvas(window.innerWidth, window.innerHeight);
                p.clear(); 
                if (originalSetup) originalSetup.call(p);
            };
            p.windowResized = function() { p.resizeCanvas(window.innerWidth, window.innerHeight); p.clear(); }
        };
        window.onload = function() { if (typeof p5 !== 'undefined') { myP5 = new p5(sketch, 'sketch-holder'); } };
        function togglePause() {
            if (!myP5) return;
            const btn = document.getElementById('btn-pause');
            if (isPaused) { myP5.loop(); btn.innerText = "Pause"; btn.classList.remove('active'); isPaused = false; } 
            else { myP5.noLoop(); btn.innerText = "Resume"; btn.classList.add('active'); isPaused = true; }
        }
        function toggleSketch() {
            const el = document.getElementById('drawing-layer');
            const btn = document.getElementById('btn-sketch');
            if (isSketchVisible) { el.style.opacity = '0'; btn.innerText = "Show Sketch"; isSketchVisible = false; } 
            else { el.style.opacity = '1'; btn.innerText = "Hide Sketch"; isSketchVisible = true; }
        }
        function toggleAnim() {
            const el = document.getElementById('sketch-holder');
            const btn = document.getElementById('btn-anim');
            if (isAnimVisible) { el.style.display = 'none'; btn.innerText = "Show Animation"; isAnimVisible = false; } 
            else { el.style.display = 'block'; btn.innerText = "Hide Animation"; isAnimVisible = true; }
        }
    </script>
</body>
</html>