<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sisi's Equinox Birthday Ride</title>
  <style>
    body {
      font-family: 'Verdana', 'Arial', sans-serif;
      background-color: #f8f4e1;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Start Screen Styling */
    #start-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f8f4e1;
    }
    #play-button {
      padding: 20px 40px;
      font-size: 28px;
      background-color: #ff69b4;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    /* Main Experience Container */
    #experience {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
      display: none; /* Hidden until start button is clicked */
    }
    .page {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .active {
      display: flex;
    }
    img {
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
    }
    .text {
      font-size: 24px;
      margin: 20px 0;
      padding: 0 10px;
      text-align: center;
      max-width: 600px;
      cursor: pointer; /* Indicate that the text is tappable */
    }
    /* Highlight style for spoken words */
    .highlight {
      background-color: yellow;
    }
    @media (max-width: 768px) {
      .text {
        font-size: 20px;
        max-width: 90%;
      }
      img {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Start Screen -->
  <div id="start-screen">
    <!-- Birthday themed start button with emojis -->
    <button id="play-button">ðŸŽ‰ Start Birthday Ride ðŸŽ‚</button>
  </div>

  <!-- Main Experience Container (hidden until start) -->
  <div id="experience" class="container">
    <!-- First page now includes an instructions message -->
    <div class="page active">
      <img src="1.webp" alt="Title Page" />
      <p id="instructions" class="text"></p>
    </div>
    <div class="page">
      <img src="2.webp" alt="Introduction" />
      <p class="text">
        The sun shone brightly, the birds sang sweetly, and the flowers were blooming.
        It was the first day of Spring, the Equinox! And even more special, it was Sisi's 4th birthday!
        Her big brother Ellis and her best friend Uni the unicorn were so excited to celebrate.
      </p>
    </div>
    <div class="page">
      <img src="3.webp" alt="Getting Ready" />
      <p class="text">
        Sisi, Ellis, and Uni decided to go on a special birthday bike ride adventure.
        But first, they needed to get ready for the fun!
      </p>
    </div>
    <div class="page">
      <img src="4.webp" alt="Costume Fun" />
      <p class="text">
        Sisi chose a sparkly fairy dress and a shining crown.
        Ellis put on his favorite superhero cape and mask.
        Uni giggled and wrapped a rainbow scarf around her neck.
      </p>
    </div>
    <div class="page">
      <img src="5.webp" alt="Decorating Bikes" />
      <p class="text">
        Next, they decorated their bikes with colorful ribbons, streamers, and spring flowers.
        Uni used her magic horn to make the flowers shimmer and glow!
      </p>
    </div>
    <div class="page">
      <img src="6.webp" alt="The Ride Begins" />
      <p class="text">
        Off they went on their Equinox adventure!
        Ellis zoomed ahead, while Sisi and Uni followed, singing a happy birthday song.
        It was a perfect day for a bike ride!
      </p>
    </div>
    <div class="page">
      <img src="7.webp" alt="Fruit Feast" />
      <p class="text">
        They stopped by a magical orchard filled with juicy fruits.
        Uni used her magic to pick the tastiest ones!
      </p>
    </div>
    <div class="page">
      <img src="8.webp" alt="Sharing with Friends" />
      <p class="text">
        They shared the yummy fruits with their animal friends.
        A bunny, a squirrel, and a bluebird joined their picnic.
      </p>
    </div>
    <div class="page">
      <img src="9.webp" alt="Birthday Surprise" />
      <p class="text">
        Suddenly, they heard music!
        Uni led the girl to a clearing where all her friends were waiting with a big 'Happy Birthday!' banner.
      </p>
    </div>
    <div class="page">
      <img src="10.webp" alt="Happy Birthday!" />
      <p class="text">
        The girl had the best Equinox birthday ever!
        She celebrated with Uni and all her friends, feeling very loved and happy.
      </p>
    </div>
  </div>

  <!-- Background Audio -->
  <audio id="background-music" src="song.mp3" preload="auto"></audio>

  <script>
    // Detect mobile devices
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    // Set instructions on the first page depending on the device.
    window.addEventListener('load', () => {
      const instrElem = document.getElementById('instructions');
      if (isMobile) {
        instrElem.textContent = "Swipe left/right to switch between pages.";
      } else {
        instrElem.textContent = "Use arrow keys to switch between pages.";
      }
    });

    // Navigation variables and functions
    let currentPage = 0;
    const pages = document.querySelectorAll('.page');
    
    function showPage(index) {
      pages.forEach((page, i) => {
        page.classList.toggle('active', i === index);
      });
    }
    
    function nextPage() {
      if (currentPage < pages.length - 1) {
        currentPage++;
        showPage(currentPage);
      }
    }
    
    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        showPage(currentPage);
      }
    }
    
    // Keyboard navigation for desktop
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowRight') {
        nextPage();
      } else if (event.key === 'ArrowLeft') {
        prevPage();
      }
    });
    
    // Touch swipe navigation for mobile
    let xDown = null;
    document.addEventListener('touchstart', (event) => {
      xDown = event.touches[0].clientX;
    }, false);
    
    document.addEventListener('touchmove', (event) => {
      if (!xDown) return;
      const xUp = event.touches[0].clientX;
      const xDiff = xDown - xUp;
      if (xDiff > 0) {
        nextPage();
      } else {
        prevPage();
      }
      xDown = null;
    }, false);
    
    // Global flag to prevent overlapping speech synthesis
    let isReading = false;
    
    // Function to read aloud the text and highlight words as theyâ€™re spoken.
    // "Sisi" is replaced in the utterance (for speech only) with "CÂ C".
    function readTextAloud(textElement) {
      if (isReading) return;
      isReading = true;
      
      // Pause the background audio
      const bgAudio = document.getElementById('background-music');
      bgAudio.pause();
      
      // Store the original text if not already stored.
      if (!textElement.dataset.original) {
        textElement.dataset.original = textElement.textContent.trim();
      }
      const originalText = textElement.dataset.original;
      
      // Wrap each word in a span (preserving whitespace)
      const tokens = originalText.split(/(\s+)/);
      let wrappedHTML = "";
      tokens.forEach(token => {
        if (token.trim() === "") {
          wrappedHTML += token;
        } else {
          wrappedHTML += `<span class="word">${token}</span>`;
        }
      });
      textElement.innerHTML = wrappedHTML;
      const wordSpans = textElement.querySelectorAll('span.word');
      let currentWordIndex = 0;
      
      // For speech synthesis, replace "Sisi" with "CÂ C" (nonâ€‘breaking space) so it is pronounced correctly.
      const utteranceText = originalText.replace(/Sisi/g, 'C\u00A0C');
      const utterance = new SpeechSynthesisUtterance(utteranceText);
      utterance.lang = 'en-US';
      utterance.rate = 1;
      
      // We'll use an array to store fallback timer IDs on mobile.
      let fallbackTimers = [];
      
      if (!isMobile) {
        // On desktop, use the boundary event to highlight each word.
        utterance.onboundary = (event) => {
          if (event.name === 'word') {
            if (currentWordIndex > 0 && currentWordIndex <= wordSpans.length) {
              wordSpans[currentWordIndex - 1].classList.remove('highlight');
            }
            if (currentWordIndex < wordSpans.length) {
              wordSpans[currentWordIndex].classList.add('highlight');
            }
            currentWordIndex++;
          }
        };
      } else {
        // On mobile, use a fallback timer approach.
        // (Adjust fallbackDelay if needed for better synchronization.)
        utterance.onstart = () => {
          const fallbackDelay = 400; // milliseconds per word (approximate)
          wordSpans.forEach((span, i) => {
            let timer = setTimeout(() => {
              if (i > 0) wordSpans[i - 1].classList.remove('highlight');
              span.classList.add('highlight');
            }, i * fallbackDelay);
            fallbackTimers.push(timer);
          });
        };
      }
      
      // When speech ends, clear highlights, cancel any fallback timers, and resume background audio.
      utterance.onend = () => {
        wordSpans.forEach(span => span.classList.remove('highlight'));
        if (isMobile) {
          fallbackTimers.forEach(timer => clearTimeout(timer));
          fallbackTimers = [];
        }
        isReading = false;
        bgAudio.play().catch(error => console.log('Audio resume failed:', error));
      };
      
      window.speechSynthesis.speak(utterance);
    }
    
    // Attach tap/click listeners to each text element.
    document.querySelectorAll('.text').forEach(textElem => {
      textElem.addEventListener('click', function () {
        readTextAloud(this);
      });
    });
    
    // Start Experience: when the start button is clicked,
    // start the background audio and show the experience container.
    let musicStarted = false;
    const playButton = document.getElementById('play-button');
    playButton.addEventListener('click', () => {
      if (!musicStarted) {
        const audio = document.getElementById('background-music');
        audio.muted = false;
        audio.play()
          .then(() => console.log('Audio started'))
          .catch(error => console.log('Audio play failed:', error));
        musicStarted = true;
      }
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('experience').style.display = 'block';
      showPage(0);
    });
  </script>
</body>
</html>
