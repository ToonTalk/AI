<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sisi's Equinox Birthday Ride</title>
  <style>
    body {
      font-family: 'Verdana', 'Arial', sans-serif;
      background-color: #f8f4e1;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Start Screen Styling */
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f8f4e1;
      text-align: center;
      padding: 20px;
    }
    #start-screen h1 {
      font-size: 36px;
      margin-bottom: 40px;
    }
    #mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 600px;
    }
    .mode-button {
      font-size: 32px;
      padding: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      background-color: #ff69b4;
      color: white;
    }
    .mode-button:hover {
      opacity: 0.9;
    }
    /* Main Experience Container */
    #experience {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
      display: none;
    }
    .page {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .active {
      display: flex;
    }
    img {
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
    }
    .text {
      font-size: 24px;
      margin: 20px 0;
      padding: 0 10px;
      text-align: center;
      max-width: 600px;
      cursor: pointer;
    }
    .highlight {
      background-color: yellow;
    }
    @media (max-width: 768px) {
      .text {
        font-size: 20px;
        max-width: 90%;
      }
      img {
        max-width: 90%;
      }
      .mode-button {
        font-size: 28px;
        padding: 16px;
      }
      #start-screen h1 {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <!-- Start Screen with Two Mode Buttons -->
  <div id="start-screen">
    <h1>Welcome to Sisi's Equinox Birthday Ride! üéâüéÇ</h1>
    <div id="mode-buttons">
      <button id="readingButton" class="mode-button">
        üìñüó£Ô∏è Auto Reading Mode (No Music) üöÄ‚ú®
      </button>
      <button id="musicButton" class="mode-button">
        üé∂üéµ Music Mode (No Reading) üéßüíñ
      </button>
    </div>
  </div>

  <!-- Main Experience Container -->
  <div id="experience" class="container">
    <!-- Page 0: Title/Instructions -->
    <div class="page active">
      <img src="1.webp" alt="Title Page" />
      <p id="instructions" class="text"></p>
    </div>
    <!-- Page 1: Introduction -->
    <div class="page">
      <img src="2.webp" alt="Introduction" />
      <p class="text">
        Spring was arriving in a magical way - flowers peeked through the soil and birds practiced their sweetest songs. This special day, March 20th, was the equinox, when day and night are exactly the same length. And it was also Sisi's 4th birthday! Her big brother Ellis and her best friend Uni the unicorn could hardly wait to start celebrating.
      </p>
    </div>
    <!-- Page 2: Getting Ready -->
    <div class="page">
      <img src="3.webp" alt="Getting Ready" />
      <p class="text">
        'Let's go on a birthday bike ride adventure!' Uni suggested, her rainbow tail swishing with excitement. 'But first,' Ellis added with a grin, 'we need to dress up for such a special occasion!'
      </p>
    </div>
    <!-- Page 3: Costume Fun -->
    <div class="page">
      <img src="4.webp" alt="Costume Fun" />
      <p class="text">
        'I feel like a real fairy princess!' Sisi twirled in her sparkly dress and adjusted her shining crown. 'And I'm ready to save the day!' Ellis announced, swooshing his superhero cape. Uni pranced around them both, her rainbow scarf floating behind her like a happy cloud.
      </p>
    </div>
    <!-- Page 4: Decorating the Bikes -->
    <div class="page">
      <img src="5.webp" alt="Decorating Bikes" />
      <p class="text">
        'Every birthday bike needs special decorations,' Ellis said, helping Sisi tie ribbons to her handlebars. 'And every birthday girl needs magical flowers,' Uni added, touching each spring blossom with her glowing horn until they sparkled like stars.
      </p>
    </div>
    <!-- Page 5: The Ride Begins -->
    <div class="page">
      <img src="6.webp" alt="The Ride Begins" />
      <p class="text">
        The spring breeze carried the scent of flowers as they set off on their adventure. Ellis led the way, while Sisi and Uni followed close behind. Their voices filled the air with a happy birthday song that made the butterflies dance.
      </p>
    </div>
    <!-- Page 6: Fruit Feast -->
    <div class="page">
      <img src="7.webp" alt="Fruit Feast" />
      <p class="text">
        'Look what I found!' Uni's horn glowed brightly as she discovered a magical orchard. The trees were heavy with fruit of every color. 'Birthday girls get to pick first,' Uni winked, helping Sisi reach the juiciest strawberries with her sparkly magic.
      </p>
    </div>
    <!-- Page 7: Sharing with Friends -->
    <div class="page">
      <img src="8.webp" alt="Sharing with Friends" />
      <p class="text">
        A fluffy bunny hopped over to share the strawberries. A squirrel chattered excitedly about the blueberries. A little bluebird swooped down to join them, singing 'Happy Birthday' in her own special way. 'Sharing makes everything taste better,' Sisi smiled.
      </p>
    </div>
    <!-- Page 8: Birthday Surprise -->
    <div class="page">
      <img src="9.webp" alt="Birthday Surprise" />
      <p class="text">
        'Do you hear that?' Uni's ears perked up at the sound of giggles and whispers. 'Follow me!' She led them down a flower-lined path to a sunny clearing where... SURPRISE! All their friends were waiting with streamers, balloons, and the biggest 'Happy Birthday, Sisi!' banner ever made.
      </p>
    </div>
    <!-- Page 9: Happy Birthday! -->
    <div class="page">
      <img src="10.webp" alt="Happy Birthday!" />
      <p class="text">
        As Sisi blew out her candles, she made a wish - though she couldn't imagine anything more magical than this perfect spring day. Surrounded by Ellis, Uni, and all her friends, she knew that turning four on the equinox was the most special birthday of all.
      </p>
    </div>
  </div>

  <!-- Background Audio (used only in Music Mode) -->
  <audio id="background-music" src="song.mp3" preload="auto"></audio>

  <script>
    /***********************
     * Global Variables
     ***********************/
    let appMode = ""; // "reading" or "music"
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    let currentPage = 0;
    let isReading = false;    // True when TTS is active.
    let autoReading = false;  // True when auto-reading is in progress.
    let selectedVoice = null;
    const pages = document.querySelectorAll('.page');
    const bgAudio = document.getElementById('background-music');

    /***********************
     * Mode Button Event Listeners
     ***********************/
    document.getElementById('readingButton').addEventListener('click', () => {
      appMode = "reading";
      startExperience();
    });
    document.getElementById('musicButton').addEventListener('click', () => {
      appMode = "music";
      startExperience();
    });

    /***********************
     * Start Experience
     ***********************/
    function startExperience() {
      const instrElem = document.getElementById('instructions');
      if (appMode === "reading") {
        instrElem.textContent = "Welcome to Sisi's Equinox Birthday Ride!";
        bgAudio.pause();
      } else if (appMode === "music") {
        instrElem.textContent = "Music Mode: Enjoy the background music. Use arrow keys (desktop) or swipe (mobile) to switch pages.";
        bgAudio.muted = false;
        bgAudio.play().catch(error => console.log('Audio play failed:', error));
      }
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('experience').style.display = 'block';
      showPage(0);
    }

    /***********************
     * Voice Selection (with Preferred Order)
     ***********************/
    function loadVoices() {
      const voices = window.speechSynthesis.getVoices();
      if (!voices || voices.length === 0) return;

      // Preferred: en-GB female
      let candidate = voices.filter(voice =>
        voice.lang &&
        voice.lang.toLowerCase().startsWith("en-gb") &&
        /female/i.test(voice.name)
      );
      if (candidate.length > 0) {
        selectedVoice = candidate[0];
        console.log("Selected voice (en-GB female):", selectedVoice);
        return;
      }

      // Next: en-GB (any)
      candidate = voices.filter(voice =>
        voice.lang && voice.lang.toLowerCase().startsWith("en-gb")
      );
      if (candidate.length > 0) {
        const femaleCandidates = candidate.filter(voice => /female/i.test(voice.name));
        selectedVoice = (femaleCandidates.length > 0) ? femaleCandidates[0] : candidate[0];
        console.log("Selected voice (en-GB any):", selectedVoice);
        return;
      }

      // Next: en-US female
      candidate = voices.filter(voice =>
        voice.lang &&
        voice.lang.toLowerCase().startsWith("en-us") &&
        /female/i.test(voice.name)
      );
      if (candidate.length > 0) {
        selectedVoice = candidate[0];
        console.log("Selected voice (en-US female):", selectedVoice);
        return;
      }

      // Next: en-US (any)
      candidate = voices.filter(voice =>
        voice.lang && voice.lang.toLowerCase().startsWith("en-us")
      );
      if (candidate.length > 0) {
        const femaleCandidates = candidate.filter(voice => /female/i.test(voice.name));
        selectedVoice = (femaleCandidates.length > 0) ? femaleCandidates[0] : candidate[0];
        console.log("Selected voice (en-US any):", selectedVoice);
        return;
      }

      // Next: any English voice (look for voices with "en" in the language code)
      candidate = voices.filter(voice =>
        voice.lang && voice.lang.toLowerCase().includes("en")
      );
      if (candidate.length > 0) {
        const femaleCandidates = candidate.filter(voice => /female/i.test(voice.name));
        selectedVoice = (femaleCandidates.length > 0) ? femaleCandidates[0] : candidate[0];
        console.log("Selected voice (any English):", selectedVoice);
        return;
      }

      // Fallback: use the very first voice.
      selectedVoice = voices[0];
      console.log("Selected fallback voice:", selectedVoice);
    }
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;

    /***********************
     * Helper: Stop Speech
     ***********************/
    function stopSpeech(resumeAudio) {
      window.speechSynthesis.cancel();
      isReading = false;
      autoReading = false;
      if (resumeAudio && appMode === "music") {
        bgAudio.play().catch(error => console.log('Audio resume failed:', error));
      }
    }

    /***********************
     * Navigation Functions
     ***********************/
    function showPage(index) {
      stopSpeech(false);
      pages.forEach((page, i) => {
        page.classList.toggle('active', i === index);
      });
      currentPage = index;
      if (appMode === "reading") {
        const activePage = pages[index];
        const textElem = activePage.querySelector('.text');
        if (textElem) {
          setTimeout(() => {
            if (!isReading) {
              readTextAloud(textElem);
            }
          }, 500);
        }
      }
    }
    function nextPage() {
      stopSpeech(false);
      if (currentPage < pages.length - 1) {
        showPage(currentPage + 1);
      }
    }
    function prevPage() {
      stopSpeech(false);
      if (currentPage > 0) {
        showPage(currentPage - 1);
      }
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowRight') {
        nextPage();
      } else if (event.key === 'ArrowLeft') {
        prevPage();
      }
    });
    let xDown = null;
    document.addEventListener('touchstart', (event) => {
      xDown = event.touches[0].clientX;
    }, false);
    document.addEventListener('touchmove', (event) => {
      if (!xDown) return;
      const xUp = event.touches[0].clientX;
      const xDiff = xDown - xUp;
      if (xDiff > 0) {
        nextPage();
      } else {
        prevPage();
      }
      xDown = null;
    }, false);

    /***********************
     * Cancel TTS on User Interaction
     * (Disabled in auto-reading mode so that accidental touches/clicks do not cancel narration.)
     ***********************/
    function cancelTTS(e) {
      if (!autoReading && isReading) {
        console.log("User interaction detected. Canceling TTS.");
        stopSpeech(true);
        e.stopPropagation();
        e.preventDefault();
      }
    }
    document.addEventListener('click', cancelTTS, true);
    document.addEventListener('touchstart', cancelTTS, true);

    /***********************
     * TTS with Word-by-Word Highlighting, Substitutions, and Chaining Workaround
     ***********************/
    function readTextAloud(textElement) {
      if (isReading) return;
      isReading = true;
      autoReading = true;
      
      // Pause background audio.
      bgAudio.pause();
      
      // Save original text if not already stored.
      if (!textElement.dataset.original) {
        textElement.dataset.original = textElement.textContent.trim();
      }
      const originalText = textElement.dataset.original;
      console.log("Reading text:", originalText);
      
      // Wrap each word in spans for highlighting.
      const tokens = originalText.split(/(\s+)/);
      let wrappedHTML = "";
      tokens.forEach(token => {
        if (token.trim() === "") {
          wrappedHTML += token;
        } else {
          wrappedHTML += `<span class="word">${token}</span>`;
        }
      });
      textElement.innerHTML = wrappedHTML;
      const wordSpans = textElement.querySelectorAll('span.word');
      let currentWordIndex = 0;
      
      // Substitutions:
      // Replace "Sisi's" with "see see's" and "Sisi" with "see see".
      const utteranceText = originalText
        .replace(/Sisi's/g, "see see's")
        .replace(/Sisi/g, "see see");
      console.log("Utterance text:", utteranceText);
      
      const utterance = new SpeechSynthesisUtterance(utteranceText);
      if (selectedVoice && selectedVoice.lang) {
        utterance.lang = selectedVoice.lang;
      } else {
        utterance.lang = 'en-US';
      }
      utterance.rate = 1;
      utterance.volume = 1;
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      console.log("Using voice:", selectedVoice);
      
      let fallbackTimers = [];
      
      if (!isMobile) {
        let boundaryFired = false;
        utterance.onboundary = (event) => {
          // Reduced delay (50ms) so that highlighting keeps up with speech.
          setTimeout(() => {
            boundaryFired = true;
            if (event.name === 'word') {
              if (currentWordIndex > 0 && currentWordIndex <= wordSpans.length) {
                wordSpans[currentWordIndex - 1].classList.remove('highlight');
              }
              if (currentWordIndex < wordSpans.length) {
                wordSpans[currentWordIndex].classList.add('highlight');
              }
              currentWordIndex++;
            }
          }, 50);
        };
        // If boundary events don‚Äôt fire, use fallback.
        setTimeout(() => {
          if (!boundaryFired) {
            console.log("Boundary events not firing; using fallback timer on desktop.");
            const fallbackDelay = 370; // per word
            wordSpans.forEach((span, i) => {
              let timer = setTimeout(() => {
                if (i > 0) wordSpans[i - 1].classList.remove('highlight');
                span.classList.add('highlight');
                currentWordIndex = i + 1;
              }, i * fallbackDelay);
              fallbackTimers.push(timer);
            });
          }
        }, 100);
      } else {
        utterance.onstart = () => {
          const fallbackDelay = 370;
          wordSpans.forEach((span, i) => {
            let timer = setTimeout(() => {
              if (i > 0) wordSpans[i - 1].classList.remove('highlight');
              span.classList.add('highlight');
              currentWordIndex = i + 1;
            }, i * fallbackDelay);
            fallbackTimers.push(timer);
          });
        };
      }
      
      // Helper to clear timers and remove highlights.
      function cleanupHighlights(){
        fallbackTimers.forEach(timer => clearTimeout(timer));
        fallbackTimers = [];
        wordSpans.forEach(span => span.classList.remove('highlight'));
      }
      
      utterance.onend = () => {
        // If not all words were spoken, chain the remaining text.
        if (currentWordIndex < wordSpans.length) {
          const remainingText = Array.from(wordSpans)
                                .slice(currentWordIndex)
                                .map(span => span.textContent)
                                .join("");
          console.log("Chaining remaining text:", remainingText);
          const remainingUtterance = new SpeechSynthesisUtterance(remainingText);
          remainingUtterance.lang = utterance.lang;
          remainingUtterance.rate = utterance.rate;
          remainingUtterance.volume = utterance.volume;
          remainingUtterance.voice = utterance.voice;
          remainingUtterance.onend = () => {
            cleanupHighlights();
            isReading = false;
            console.log("Finished speaking remaining text.");
            if (autoReading && currentPage < pages.length - 1) {
              nextPage();
              setTimeout(() => {
                let nextText = pages[currentPage].querySelector('.text');
                if (nextText) {
                  readTextAloud(nextText);
                }
              }, 500);
            }
          };
          window.speechSynthesis.speak(remainingUtterance);
        } else {
          cleanupHighlights();
          isReading = false;
          console.log("Finished speaking.");
          if (autoReading && currentPage < pages.length - 1) {
            nextPage();
            setTimeout(() => {
              let nextText = pages[currentPage].querySelector('.text');
              if (nextText) {
                readTextAloud(nextText);
              }
            }, 500);
          }
        }
      };
      
      utterance.onerror = () => {
        console.log("TTS error encountered. Stopping speech.");
        fallbackTimers.forEach(timer => clearTimeout(timer));
        wordSpans.forEach(span => span.classList.remove('highlight'));
        isReading = false;
        autoReading = false;
        if (currentPage < pages.length - 1) {
          nextPage();
        }
      };
      
      window.speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
