<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sisi's Equinox Birthday Ride</title>
  <style>
    body {
      font-family: 'Verdana', 'Arial', sans-serif;
      background-color: #f8f4e1;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Start Screen Styling */
    #start-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #f8f4e1;
    }
    #play-button {
      padding: 20px 40px;
      font-size: 28px;
      background-color: #ff69b4;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    /* Main Experience Container */
    #experience {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
      display: none; /* Hidden until the start button is clicked */
    }
    .page {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .active {
      display: flex;
    }
    img {
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
    }
    .text {
      font-size: 24px;
      margin: 20px 0;
      padding: 0 10px;
      text-align: center;
      max-width: 600px;
      cursor: pointer; /* Indicates that the text is tappable/clickable */
    }
    /* Highlight style for spoken words */
    .highlight {
      background-color: yellow;
    }
    @media (max-width: 768px) {
      .text {
        font-size: 20px;
        max-width: 90%;
      }
      img {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- Start Screen -->
  <div id="start-screen">
    <!-- Birthday-themed start button with emojis -->
    <button id="play-button">ðŸŽ‰ Start Birthday Ride ðŸŽ‚</button>
  </div>

  <!-- Main Experience Container (hidden until start) -->
  <div id="experience" class="container">
    <!-- Page 1: Title/Instructions -->
    <div class="page active">
      <img src="1.webp" alt="Title Page" />
      <p id="instructions" class="text"></p>
    </div>
    <!-- Page 2: Introduction -->
    <div class="page">
      <img src="2.webp" alt="Introduction" />
      <p class="text">
        Spring was arriving in a magical way - flowers peeked through the soil and birds practiced their sweetest songs. This special day, March 20th, was the equinox, when day and night are exactly the same length. And it was also Sisi's 4th birthday! Her big brother Ellis and her best friend Uni the unicorn could hardly wait to start celebrating.
      </p>
    </div>
    <!-- Page 3: Getting Ready -->
    <div class="page">
      <img src="3.webp" alt="Getting Ready" />
      <p class="text">
        'Let's go on a birthday bike ride adventure!' Uni suggested, her rainbow tail swishing with excitement. 'But first,' Ellis added with a grin, 'we need to dress up for such a special occasion!'
      </p>
    </div>
    <!-- Page 4: Costume Fun -->
    <div class="page">
      <img src="4.webp" alt="Costume Fun" />
      <p class="text">
        'I feel like a real fairy princess!' Sisi twirled in her sparkly dress and adjusted her shining crown. 'And I'm ready to save the day!' Ellis announced, swooshing his superhero cape. Uni pranced around them both, her rainbow scarf floating behind her like a happy cloud.
      </p>
    </div>
    <!-- Page 5: Decorating the Bikes -->
    <div class="page">
      <img src="5.webp" alt="Decorating Bikes" />
      <p class="text">
        'Every birthday bike needs special decorations,' Ellis said, helping Sisi tie ribbons to her handlebars. 'And every birthday girl needs magical flowers,' Uni added, touching each spring blossom with her glowing horn until they sparkled like stars.
      </p>
    </div>
    <!-- Page 6: The Ride Begins -->
    <div class="page">
      <img src="6.webp" alt="The Ride Begins" />
      <p class="text">
        The spring breeze carried the scent of flowers as they set off on their adventure. Ellis led the way, while Sisi and Uni followed close behind. Their voices filled the air with a happy birthday song that made the butterflies dance.
      </p>
    </div>
    <!-- Page 7: Fruit Feast -->
    <div class="page">
      <img src="7.webp" alt="Fruit Feast" />
      <p class="text">
        'Look what I found!' Uni's horn glowed brightly as she discovered a magical orchard. The trees were heavy with fruit of every color. 'Birthday girls get to pick first,' Uni winked, helping Sisi reach the juiciest strawberries with her sparkly magic.
      </p>
    </div>
    <!-- Page 8: Sharing with Friends -->
    <div class="page">
      <img src="8.webp" alt="Sharing with Friends" />
      <p class="text">
        A fluffy bunny hopped over to share the strawberries. A squirrel chattered excitedly about the blueberries. A little bluebird swooped down to join them, singing 'Happy Birthday' in her own special way. 'Sharing makes everything taste better,' Sisi smiled.
      </p>
    </div>
    <!-- Page 9: Birthday Surprise -->
    <div class="page">
      <img src="9.webp" alt="Birthday Surprise" />
      <p class="text">
        'Do you hear that?' Uni's ears perked up at the sound of giggles and whispers. 'Follow me!' She led them down a flower-lined path to a sunny clearing where... SURPRISE! All their friends were waiting with streamers, balloons, and the biggest 'Happy Birthday, Sisi!' banner ever made.
      </p>
    </div>
    <!-- Page 10: Happy Birthday! -->
    <div class="page">
      <img src="10.webp" alt="Happy Birthday!" />
      <p class="text">
        As Sisi blew out her candles, she made a wish - though she couldn't imagine anything more magical than this perfect spring day. Surrounded by Ellis, Uni, and all her friends, she knew that turning four on the equinox was the most special birthday of all.
      </p>
    </div>
  </div>

  <!-- Background Audio -->
  <audio id="background-music" src="song.mp3" preload="auto"></audio>

  <script>
    // Detect mobile devices
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    // Set instructions on the first page based on the device.
    window.addEventListener('load', () => {
      const instrElem = document.getElementById('instructions');
      if (isMobile) {
        instrElem.textContent = "Swipe left/right to switch pages and tap text to have it read aloud.";
      } else {
        instrElem.textContent = "Use arrow keys to switch pages and click text to have it read aloud.";
      }
    });

    // GLOBAL VOICE SELECTION with preference for female British voices.
    let selectedVoice = null;
    function loadVoices() {
      const voices = window.speechSynthesis.getVoices();
      if (voices.length === 0) return;
      
      // 1. Look for a voice that is both British (en-GB) and has "female" in its name.
      const femaleGBVoices = voices.filter(voice =>
        voice.lang &&
        voice.lang.toLowerCase().startsWith("en-gb") &&
        /female/i.test(voice.name)
      );
      if (femaleGBVoices.length > 0) {
        selectedVoice = femaleGBVoices[0];
      } else {
        // 2. Otherwise, look for any British voice.
        const britishVoices = voices.filter(voice =>
          voice.lang && voice.lang.toLowerCase().startsWith("en-gb")
        );
        if (britishVoices.length > 0) {
          selectedVoice = britishVoices[0];
        } else {
          // 3. Otherwise, look for any female voice.
          const femaleVoices = voices.filter(voice =>
            /female/i.test(voice.name)
          );
          if (femaleVoices.length > 0) {
            selectedVoice = femaleVoices[0];
          } else {
            // 4. Fallback: Use the first available voice.
            selectedVoice = voices[0];
          }
        }
      }
      console.log("Selected voice:", selectedVoice);
    }
    // Load voices immediately and also when the voices list changes.
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;

    // Navigation variables and functions
    let currentPage = 0;
    const pages = document.querySelectorAll('.page');
    function showPage(index) {
      pages.forEach((page, i) => {
        page.classList.toggle('active', i === index);
      });
    }
    function nextPage() {
      if (currentPage < pages.length - 1) {
        currentPage++;
        showPage(currentPage);
      }
    }
    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        showPage(currentPage);
      }
    }
    // Keyboard navigation (desktop)
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowRight') {
        nextPage();
      } else if (event.key === 'ArrowLeft') {
        prevPage();
      }
    });
    // Touch swipe navigation (mobile)
    let xDown = null;
    document.addEventListener('touchstart', (event) => {
      xDown = event.touches[0].clientX;
    }, false);
    document.addEventListener('touchmove', (event) => {
      if (!xDown) return;
      const xUp = event.touches[0].clientX;
      const xDiff = xDown - xUp;
      if (xDiff > 0) {
        nextPage();
      } else {
        prevPage();
      }
      xDown = null;
    }, false);

    // Global flag to prevent overlapping speech synthesis
    let isReading = false;

    // Function to read aloud the text and highlight each word as it is spoken.
    // Occurrences of "Sisi" are replaced with "CÂ C" (using a non-breaking space).
    function readTextAloud(textElement) {
      if (isReading) return;
      isReading = true;
      
      // Pause background audio
      const bgAudio = document.getElementById('background-music');
      bgAudio.pause();
      
      // Store original text if not already stored
      if (!textElement.dataset.original) {
        textElement.dataset.original = textElement.textContent.trim();
      }
      const originalText = textElement.dataset.original;
      
      // Debug logging
      console.log("Reading text:", originalText);
      
      // Wrap each word in a span (preserving whitespace)
      const tokens = originalText.split(/(\s+)/);
      let wrappedHTML = "";
      tokens.forEach(token => {
        if (token.trim() === "") {
          wrappedHTML += token;
        } else {
          wrappedHTML += `<span class="word">${token}</span>`;
        }
      });
      textElement.innerHTML = wrappedHTML;
      const wordSpans = textElement.querySelectorAll('span.word');
      let currentWordIndex = 0;
      
      // For speech synthesis, replace "Sisi" with "CÂ C" (non-breaking space)
      const utteranceText = originalText.replace(/Sisi/g, 'C\u00A0C');
      console.log("Utterance text:", utteranceText);
      const utterance = new SpeechSynthesisUtterance(utteranceText);
      
      // Set utterance language to the selected voice's language if available.
      if (selectedVoice && selectedVoice.lang) {
        utterance.lang = selectedVoice.lang;
      } else {
        utterance.lang = 'en-US';
      }
      utterance.rate = 1;
      utterance.volume = 1; // Ensure maximum volume
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      console.log("Using voice:", selectedVoice);
      
      // Array for fallback timer IDs (used if boundary events don't fire)
      let fallbackTimers = [];
      
      if (!isMobile) {
        // On desktop, try to use the boundary event.
        let boundaryFired = false;
        utterance.onboundary = (event) => {
          boundaryFired = true;
          if (event.name === 'word') {
            if (currentWordIndex > 0 && currentWordIndex <= wordSpans.length) {
              wordSpans[currentWordIndex - 1].classList.remove('highlight');
            }
            if (currentWordIndex < wordSpans.length) {
              wordSpans[currentWordIndex].classList.add('highlight');
            }
            currentWordIndex++;
          }
        };
        // If no boundary event fires within 200ms, use a fallback timer.
        setTimeout(() => {
          if (!boundaryFired) {
            console.log("Boundary events not firing; using fallback timer on desktop.");
            const fallbackDelay = 400; // milliseconds per word (adjust as needed)
            wordSpans.forEach((span, i) => {
              let timer = setTimeout(() => {
                if (i > 0) wordSpans[i - 1].classList.remove('highlight');
                span.classList.add('highlight');
              }, i * fallbackDelay);
              fallbackTimers.push(timer);
            });
          }
        }, 200);
      } else {
        // On mobile, always use the fallback timer approach.
        utterance.onstart = () => {
          const fallbackDelay = 400; // milliseconds per word (adjust as needed)
          wordSpans.forEach((span, i) => {
            let timer = setTimeout(() => {
              if (i > 0) wordSpans[i - 1].classList.remove('highlight');
              span.classList.add('highlight');
            }, i * fallbackDelay);
            fallbackTimers.push(timer);
          });
        };
      }
      
      // When the speech ends, clear highlights, cancel any fallback timers, and resume background audio.
      utterance.onend = () => {
        wordSpans.forEach(span => span.classList.remove('highlight'));
        fallbackTimers.forEach(timer => clearTimeout(timer));
        fallbackTimers = [];
        isReading = false;
        bgAudio.play().catch(error => console.log('Audio resume failed:', error));
        console.log("Finished speaking.");
      };
      
      window.speechSynthesis.speak(utterance);
    }
    
    // Attach click/tap listeners to each text element.
    document.querySelectorAll('.text').forEach(textElem => {
      textElem.addEventListener('click', function () {
        readTextAloud(this);
      });
    });
    
    // Start Experience: When the start button is clicked, start background audio and show the experience container.
    let musicStarted = false;
    const playButton = document.getElementById('play-button');
    playButton.addEventListener('click', () => {
      if (!musicStarted) {
        const audio = document.getElementById('background-music');
        audio.muted = false;
        audio.play()
          .then(() => console.log('Audio started'))
          .catch(error => console.log('Audio play failed:', error));
        musicStarted = true;
      }
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('experience').style.display = 'block';
      showPage(0);
    });
  </script>
</body>
</html>
