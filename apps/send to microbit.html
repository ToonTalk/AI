<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython micro:bit Web Runner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fira-code {
            font-family: 'Fira Code', monospace;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Hide password reveal toggle on WebKit browsers */
        input[type="password"]::-webkit-reveal,
        input[type="password"]::-webkit-clear-button {
            display: none;
        }
    </style>
</head>
<body class="h-full text-slate-200 antialiased">
    <div id="app" class="flex flex-col h-screen p-4 md:p-6 lg:p-8 gap-6 max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex-shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight">
                MicroPython <span class="text-sky-400">micro:bit</span> Web Runner
            </h1>
            <p class="text-slate-400 mt-1">
                Write MicroPython code, connect your micro:bit via Web Serial, and run it directly from your browser.
            </p>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col lg:flex-row gap-6 min-h-0">

            <!-- Code Editor -->
            <div class="flex-1 flex flex-col min-h-0">
                <label for="code-editor" class="text-sm font-medium text-slate-300 mb-2">Code Editor</label>
                <div class="flex-1 bg-slate-800 rounded-lg shadow-inner overflow-hidden">
                    <textarea id="code-editor" class="w-full h-full p-4 bg-transparent text-slate-200 resize-none outline-none fira-code text-sm leading-relaxed" spellcheck="false">
# Welcome! This code will cause an error on purpose.
# Click "Run Code" to see the error, then "Fix with AI".

from microbit import *

# This will fail because temperature() returns a number,
# but display.scroll() needs text (a string).
while True:
    temp = temperature()
    display.scroll(temp)
    sleep(1000)
</textarea>
                </div>
            </div>

            <!-- Controls and Output -->
            <div class="lg:w-1/3 flex flex-col gap-6">
                <!-- Controls -->
                <div class="bg-slate-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Controls</h2>
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-slate-400">Status:</span>
                        <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-700">
                            <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                            <span id="status-text" class="text-sm font-medium text-slate-300">Disconnected</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3">
                        <button id="ai-chat-button" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            âœ¨ AI Code Gen
                        </button>
                        <button id="connect-button" class="w-full bg-sky-600 hover:bg-sky-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 5.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5m-6 4.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5m3 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5"/><path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1z"/></svg>
                            Connect
                        </button>
                        <button id="run-button" disabled class="w-full bg-green-600 hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
                            Run Code
                        </button>
                        <button id="stop-button" disabled class="w-full bg-amber-600 hover:bg-amber-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/></svg>
                            Stop Program
                        </button>
                        <button id="disconnect-button" disabled class="w-full bg-red-600 hover:bg-red-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
                            Disconnect
                        </button>
                    </div>
                </div>

                <!-- Output Terminal -->
                <div class="flex-1 flex flex-col min-h-0 bg-slate-800 p-4 rounded-lg shadow-lg">
                    <div class="flex-shrink-0 flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Device Output</h2>
                         <div class="flex items-center gap-4">
                            <button id="fix-with-ai-button" class="hidden text-xs bg-amber-600 hover:bg-amber-500 text-white font-semibold py-1 px-3 rounded-md">Fix with AI</button>
                            <button id="clear-output-button" class="text-xs text-slate-400 hover:text-sky-400">Clear</button>
                        </div>
                    </div>
                    <div class="flex-1 bg-black rounded-md overflow-y-auto">
                        <pre id="output" class="p-3 text-xs fira-code text-slate-300 whitespace-pre-wrap break-words"></pre>
                    </div>
                </div>
            </div>
        </main>

        <!-- Web Serial Support Message -->
        <div id="serial-support-msg" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
             <div class="bg-slate-800 rounded-lg p-8 max-w-md text-center shadow-2xl">
                <h2 class="text-2xl font-bold text-red-500 mb-4">Browser Not Supported</h2>
                <p class="text-slate-300">This application requires the <b>Web Serial API</b>, which is not supported by your current browser. Please use a recent version of Google Chrome, Microsoft Edge, or Opera on a desktop computer.</p>
            </div>
        </div>
        
        <!-- AI Chat Modal -->
        <div id="ai-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40">
            <div class="bg-slate-800 w-full max-w-2xl h-[80vh] rounded-xl shadow-2xl flex flex-col">
                <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-wrap gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-white">AI Code Gen</h2>
                        <span id="ai-status-badge" class="px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-700 text-slate-300">Not Ready</span>
                    </div>
                     <div class="flex items-center gap-2">
                        <label for="ai-provider-select" class="text-sm font-medium text-slate-300">Provider:</label>
                        <select id="ai-provider-select" class="bg-slate-700 text-slate-200 rounded-md px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="nano">Gemini Nano (On-Device)</option>
                            <option value="gemini">Gemini (Cloud)</option>
                            <option value="claude">Claude (Cloud)</option>
                            <option value="chatgpt">ChatGPT (Cloud)</option>
                        </select>
                    </div>
                    <button id="ai-modal-close-button" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
                </header>
                 <div id="ai-settings-area" class="p-4 border-b border-slate-700">
                    <div id="api-key-group" class="hidden w-full">
                        <label for="api-key-input" id="api-key-label" class="text-sm font-medium text-slate-300 mb-1 block">API Key:</label>
                        <div class="flex gap-2">
                            <input type="password" id="api-key-input" placeholder="Enter your API key" class="flex-1 bg-slate-900 text-slate-200 rounded-md px-3 py-1.5 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <button id="save-api-key-button" class="bg-green-600 hover:bg-green-500 text-white font-bold px-4 py-1.5 rounded-md text-sm">Save</button>
                        </div>
                    </div>
                </div>
                <div id="ai-chat-history" class="flex-1 p-4 overflow-y-auto space-y-4">
                    <!-- Chat messages will be appended here -->
                </div>
                <footer class="p-4 border-t border-slate-700">
                    <form id="ai-prompt-form" class="flex gap-3">
                        <input type="text" id="ai-prompt-input" placeholder="e.g., show a beating heart on the display" class="flex-1 bg-slate-700 text-slate-200 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" id="ai-prompt-send" class="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 text-white font-bold px-4 py-2 rounded-md transition-colors">Send</button>
                    </form>
                </footer>
            </div>
        </div>

    </div>

    <script type="module">
        // --- DOM Elements ---
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const runButton = document.getElementById('run-button');
        const stopButton = document.getElementById('stop-button');
        const clearOutputButton = document.getElementById('clear-output-button');
        const codeEditor = document.getElementById('code-editor');
        const output = document.getElementById('output');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const serialSupportMsg = document.getElementById('serial-support-msg');
        const fixWithAiButton = document.getElementById('fix-with-ai-button');

        // --- AI Chat DOM Elements ---
        const aiChatButton = document.getElementById('ai-chat-button');
        const aiChatModal = document.getElementById('ai-chat-modal');
        const aiModalCloseButton = document.getElementById('ai-modal-close-button');
        const aiStatusBadge = document.getElementById('ai-status-badge');
        const aiChatHistory = document.getElementById('ai-chat-history');
        const aiPromptForm = document.getElementById('ai-prompt-form');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const aiPromptSend = document.getElementById('ai-prompt-send');
        const aiProviderSelect = document.getElementById('ai-provider-select');
        const apiKeyGroup = document.getElementById('api-key-group');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const apiKeyLabel = document.getElementById('api-key-label');

        // --- Web Serial State ---
        let port = null;
        let reader = null;
        let writer = null;
        const textEncoder = new TextEncoder();

        // --- AI State ---
        let aiSession = null;
        let aiStatus = 'uninitialized';
        let selectedProvider = 'nano';
        let apiKey = '';
        let lastRunCode = '';
        let isStopping = false;

        const SYSTEM_PROMPT = "You are an expert in MicroPython programming for the BBC micro:bit. Generate concise, complete, and correct MicroPython code snippets based on the user's request. Only output the code, enclosed in markdown code blocks (```python ... ```). Do not add any extra explanations or introductory text. Pay close attention to data types; for example, always convert numbers to strings using str() before passing them to functions like display.scroll().";

        // --- UI Update Functions ---
        const log = (message, type = 'info') => {
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-sky-400';
            output.innerHTML += `<span class="${color}">> ${message}\n</span>`;
            output.scrollTop = output.scrollHeight;
        };
        
        const logDeviceData = (data) => {
             output.textContent += data;
             output.scrollTop = output.scrollHeight;
             // Check for common error signatures, but ignore them if we are actively stopping the code.
             if (!isStopping && (data.includes('Traceback') || data.includes('Error:'))) {
                fixWithAiButton.classList.remove('hidden');
             }
        };

        const updateUIForConnection = () => {
            statusText.textContent = 'Connected';
            statusDot.classList.remove('bg-red-500', 'animate-pulse');
            statusDot.classList.add('bg-green-500');
            connectButton.disabled = true;
            disconnectButton.disabled = false;
            runButton.disabled = false;
            stopButton.disabled = false;
            log('micro:bit connected successfully!', 'success');
        };

        const updateUIForDisconnection = () => {
            statusText.textContent = 'Disconnected';
            statusDot.classList.remove('bg-green-500');
            statusDot.classList.add('bg-red-500', 'animate-pulse');
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            runButton.disabled = true;
            stopButton.disabled = true;
        };

        // --- Web Serial Core Functions ---
        async function connect() {
            try {
                if (!('serial' in navigator)) {
                    serialSupportMsg.classList.remove('hidden');
                    throw new Error('Web Serial API not available');
                }
                log('Requesting serial port...');
                port = await navigator.serial.requestPort({
                    filters: [{ usbVendorId: 0x0d28 }] // micro:bit Vendor ID
                });

                log('Opening port at 115200 baud...');
                await port.open({ baudRate: 115200 });

                startReadLoop();
                writer = port.writable.getWriter();
                updateUIForConnection();

                navigator.serial.addEventListener('disconnect', (e) => {
                    if (e.port === port) {
                        log('Device was disconnected.', 'error');
                        disconnect();
                    }
                });

            } catch (err) {
                if (err.message.includes('Failed to open serial port')) {
                    log('Connection failed: The serial port is already in use.', 'error');
                    log('Please close any other program using the micro:bit (e.g., Mu, Thonny) and try again.', 'info');
                } else {
                    log(`Connection failed: ${err.message}`, 'error');
                }
                await disconnect();
            }
        }

        async function disconnect() {
            try {
                if (reader) { await reader.cancel(); reader = null; }
                if (writer) { if (port && port.writable) { writer.releaseLock(); } writer = null; }
                if (port) { if (port.readable) { await port.close(); } port = null; }
            } catch (err) { console.error("Error during disconnect:", err); } 
            finally { updateUIForDisconnection(); log('Disconnected.'); }
        }

        async function startReadLoop() {
            try {
                const readerStream = port.readable.pipeThrough(new TextDecoderStream());
                reader = readerStream.getReader();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) logDeviceData(value);
                }
            } catch (err) {
                if (!err.message.includes('The user aborted a request.')) { log(`Read error: ${err.message}`, 'error'); }
            }
        }

        async function sendString(str) {
            if (!writer) return;
            const data = textEncoder.encode(str);
            await writer.write(data);
        }

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function runCode() {
            if (!port) { log('Cannot run code, device not connected.', 'error'); return; }
            fixWithAiButton.classList.add('hidden'); // Hide on new run
            const code = codeEditor.value;
            lastRunCode = code; // Store the code being run
            const formattedCode = code.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n/g, '\r\n');
            log('Entering paste mode...');
            try {
                await sendString('\x03'); await sleep(120); // Ctrl-C
                await sendString('\x05'); await sleep(80);  // Ctrl-E (Paste Mode)
                log('Sending code...');
                await sendString(formattedCode); await sleep(80);
                log('Executing...');
                await sendString('\x04'); await sleep(150); // Ctrl-D (Execute)
                await sendString('\x02'); // Ctrl-B (Back to REPL)
            } catch (err) { log(`Failed to run code: ${err.message}`, 'error'); await disconnect(); }
        }

        async function stopCode() {
            if (!port) {
                log('Not connected.', 'error');
                return;
            }
            isStopping = true;
            log('Stopping program and resetting REPL...');
            try {
                // A more robust sequence to ensure the REPL is clean
                await sendString('\x03'); // Ctrl-C: Interrupt running code
                await sleep(100);
                await sendString('\x02'); // Ctrl-B: Exit raw/paste mode, return to friendly REPL
                log('Stop signal sent. Device should be ready.', 'info');
            } catch (err) {
                log(`Failed to send stop signal: ${err.message}`, 'error');
                await disconnect();
            } finally {
                setTimeout(() => { isStopping = false; }, 500); // Reset flag after a delay
            }
        }
        
        // --- AI Chat Functions ---
        const updateAIStatus = (newStatus, message) => {
            aiStatus = newStatus;
            aiStatusBadge.textContent = message;
            aiStatusBadge.className = 'px-2 py-0.5 text-xs font-semibold rounded-full ';
            switch (newStatus) {
                case 'ready':
                    aiStatusBadge.classList.add('bg-green-700', 'text-green-200');
                    aiPromptInput.disabled = false;
                    aiPromptSend.disabled = false;
                    break;
                case 'initializing': case 'busy':
                    aiStatusBadge.classList.add('bg-yellow-700', 'text-yellow-200');
                    aiPromptInput.disabled = true;
                    aiPromptSend.disabled = true;
                    break;
                case 'unavailable':
                    aiStatusBadge.classList.add('bg-red-700', 'text-red-200');
                    aiPromptInput.disabled = true;
                    aiPromptSend.disabled = true;
                    break;
            }
        };
        
        const addMessageToChat = (sender, content) => {
            const messageDiv = document.createElement('div');
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = content.replace(/\n/g, '<br>'); // Render newlines
            if (sender === 'user') {
                messageDiv.className = "flex justify-end";
                contentDiv.className = "bg-blue-600 text-white p-3 rounded-lg max-w-xs md:max-w-md";
            } else {
                messageDiv.className = "flex justify-start";
                contentDiv.className = "bg-slate-700 text-slate-200 p-3 rounded-lg max-w-xs md:max-w-md break-all";
            }
            messageDiv.appendChild(contentDiv);
            aiChatHistory.appendChild(messageDiv);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
            return contentDiv;
        };

        const initializeAIProvider = async (provider) => {
            aiSession = null; // Reset session on provider change
            updateAIStatus('initializing', 'Initializing...');
            if (provider === 'nano') {
                try {
                    if (typeof LanguageModel === 'undefined') throw new Error("LanguageModel API not available. Try enabling chrome://flags/#prompt-api-for-gemini-nano");
                    const availability = await LanguageModel.availability();
                    if (!["available", "readily"].includes(availability)) throw new Error(`Nano model not ready. Status: ${availability}`);
                    aiSession = await LanguageModel.create({ initialPrompts: [{ role: 'system', content: SYSTEM_PROMPT }] });
                    updateAIStatus('ready', 'Ready');
                    addMessageToChat('ai', 'Gemini Nano is ready. What would you like to create?');
                } catch (error) {
                    updateAIStatus('unavailable', 'Error');
                    addMessageToChat('ai', `<b>Error:</b> ${error.message}`);
                }
            } else {
                if (apiKey) {
                    updateAIStatus('ready', 'Ready');
                    addMessageToChat('ai', `Ready to use ${provider.charAt(0).toUpperCase() + provider.slice(1)}. What would you like to create?`);
                } else {
                    updateAIStatus('unavailable', 'API Key Needed');
                    addMessageToChat('ai', `Please enter and save your API key for ${provider.charAt(0).toUpperCase() + provider.slice(1)}.`);
                }
            }
        };
        
        async function getAICode(prompt, provider, key) {
             updateAIStatus('busy', 'Generating...');
             try {
                if (provider === 'nano') {
                    if (!aiSession) throw new Error("Gemini Nano session not initialized.");
                    const stream = aiSession.promptStreaming(prompt);
                    let fullResponse = "";
                    for await (const chunk of stream) { fullResponse += chunk; }
                    return fullResponse;
                }
                
                let url, headers, body;
                switch (provider) {
                    case 'gemini':
                        url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;
                        headers = { 'Content-Type': 'application/json' };
                        body = {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                        };
                        break;
                    case 'claude':
                        url = 'https://api.anthropic.com/v1/messages';
                        headers = { 
                            'x-api-key': key, 
                            'anthropic-version': '2023-06-01', 
                            'content-type': 'application/json',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        };
                        body = { model: 'claude-3-5-haiku-20241022', max_tokens: 1024, system: SYSTEM_PROMPT, messages: [{ role: 'user', content: prompt }] };
                        break;
                    case 'chatgpt':
                        url = 'https://api.openai.com/v1/chat/completions';
                        headers = { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' };
                        body = { model: 'gpt-5', messages: [{ role: 'system', content: SYSTEM_PROMPT }, { role: 'user', content: prompt }] };
                        break;
                    default:
                        throw new Error("Unknown AI provider.");
                }

                const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                switch (provider) {
                    case 'gemini': return data.candidates[0].content.parts[0].text;
                    case 'claude': return data.content[0].text;
                    case 'chatgpt': return data.choices[0].message.content;
                }

            } catch(error) {
                console.error("AI Generation Error:", error);
                 if (provider === 'chatgpt' && error.message.includes('401')) {
                    throw new Error("The provided OpenAI API key is incorrect or invalid. Please check your key at platform.openai.com and save it again.");
                }
                 if (provider === 'claude' && error instanceof TypeError) {
                    throw new Error("Failed to fetch. This is likely a CORS error. The Anthropic API is not designed to be called directly from a browser and requires a server-side proxy, which cannot be implemented in this app.");
                }
                throw error; // Re-throw for other cases
            }
        }

        async function submitAIPrompt(prompt) {
            if (!prompt || aiStatus !== 'ready') return;
            
            addMessageToChat('user', prompt);
            aiPromptInput.value = '';
            
            try {
                const responseText = await getAICode(prompt, selectedProvider, apiKey);
                const codeBlockRegex = /```python\n([\s\S]*?)\n```/;
                const match = responseText.match(codeBlockRegex);

                if (match && match[1]) {
                    const code = match[1];
                    codeEditor.value = code;
                    aiChatModal.classList.add('hidden');
                    log('AI-generated code inserted into the editor.', 'info');
                } else {
                    addMessageToChat('ai', responseText || "Sorry, I couldn't generate a valid code snippet for that request.");
                }
            } catch (error) {
                addMessageToChat('ai', `<b>Error:</b> ${error.message}`);
            } finally {
                updateAIStatus('ready', 'Ready');
            }
        }
        
        aiPromptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitAIPrompt(aiPromptInput.value.trim());
        });
        
        // --- AI Settings Management ---
        const loadAISettings = () => {
            selectedProvider = localStorage.getItem('ai_provider') || 'nano';
            apiKey = localStorage.getItem(`ai_key_${selectedProvider}`) || '';
            aiProviderSelect.value = selectedProvider;
            apiKeyInput.value = apiKey;
            updateAIProviderUI();
        };

        const saveAISettings = () => {
            selectedProvider = aiProviderSelect.value;
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('ai_provider', selectedProvider);
            if (selectedProvider !== 'nano') {
                localStorage.setItem(`ai_key_${selectedProvider}`, apiKey);
            }
            addMessageToChat('ai', 'Settings saved.');
            initializeAIProvider(selectedProvider);
        };
        
        const updateAIProviderUI = () => {
            selectedProvider = aiProviderSelect.value;
            aiChatHistory.innerHTML = ''; // Clear chat on provider switch
            if (selectedProvider === 'nano') {
                apiKeyGroup.classList.add('hidden');
                initializeAIProvider('nano');
            } else {
                apiKeyLabel.textContent = `${selectedProvider.charAt(0).toUpperCase() + selectedProvider.slice(1)} API Key:`;
                apiKeyGroup.classList.remove('hidden');
                apiKey = localStorage.getItem(`ai_key_${selectedProvider}`) || '';
                apiKeyInput.value = apiKey;
                initializeAIProvider(selectedProvider);
            }
        };

        // --- Event Listeners & Initialization ---
        if (!('serial' in navigator)) { serialSupportMsg.classList.remove('hidden'); }
        
        connectButton.addEventListener('click', connect);
        disconnectButton.addEventListener('click', disconnect);
        runButton.addEventListener('click', runCode);
        stopButton.addEventListener('click', stopCode);
        clearOutputButton.addEventListener('click', () => { 
            output.innerHTML = ''; 
            fixWithAiButton.classList.add('hidden');
        });
        
        // AI Chat Listeners
        aiChatButton.addEventListener('click', () => {
            aiChatModal.classList.remove('hidden');
            if (aiStatus === 'uninitialized') { loadAISettings(); }
        });
        aiModalCloseButton.addEventListener('click', () => { aiChatModal.classList.add('hidden'); });
        aiProviderSelect.addEventListener('change', updateAIProviderUI);
        saveApiKeyButton.addEventListener('click', saveAISettings);
        fixWithAiButton.addEventListener('click', () => {
            const errorMessage = output.textContent;
            const fixPrompt = `The following MicroPython script produced an error. Please analyze the code and the error message and provide a fixed version of the script.\n\nFAILED CODE:\n\`\`\`python\n${lastRunCode}\n\`\`\`\n\nERROR MESSAGE:\n\`\`\`\n${errorMessage}\n\`\`\``;
            
            aiChatModal.classList.remove('hidden');
            if (aiStatus === 'uninitialized') { 
                loadAISettings(); 
            }
            // Ensure AI is ready before submitting
            setTimeout(() => submitAIPrompt(fixPrompt), 100);
            fixWithAiButton.classList.add('hidden');
        });


        // Initialize UI
        updateUIForDisconnection();

    </script>
</body>
</html>

