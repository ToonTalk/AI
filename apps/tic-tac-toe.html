<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticâ€‘Tacâ€‘Toe â€¢ AIÂ vsÂ You</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-hover: #1e4fc4;
        --radius: 10px;
        --size: 100px;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        background: #f5f6fa;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        color: #222;
      }
      h1 {
        margin: 1.2rem 0 0.5rem;
        font-size: 2.1rem;
        font-weight: 700;
        text-align: center;
      }
      .card {
        background: #fff;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.2rem;
        max-width: 380px;
        width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      /* controls */
      .controls {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr auto auto auto;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      #apiKey {
        padding: 0.45rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: var(--radius);
        font-size: 0.9rem;
        width: 100%;
      }
      .btn {
        border: none;
        border-radius: var(--radius);
        padding: 0.45rem 0.9rem;
        font-size: 0.85rem;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        transition: 0.15s background-color;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }
      .btn:hover { background: var(--primary-hover); }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }
      /* board */
      #board {
        display: grid;
        grid-template-columns: repeat(3, var(--size));
        gap: 8px;
        margin-bottom: 1rem;
      }
      .square {
        width: var(--size);
        height: var(--size);
        font-size: 3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-radius: var(--radius);
        background: #fff;
        border: 2px solid #d1d5db;
        cursor: pointer;
        transition: 0.15s background-color;
      }
      .square:hover { background: #f3f4f6; }
      .indexLabel {
        position: absolute;
        top: 4px;
        left: 6px;
        font-size: 0.65rem;
        color: #9ca3af;
        pointer-events: none;
      }
      /* status */
      #status {
        min-height: 1.5rem;
        font-size: 1.05rem;
        margin-bottom: 0.25rem;
        text-align: center;
      }
      #remark {
        min-height: 1.5rem;
        font-style: italic;
        color: #0657c2;
        text-align: center;
        margin-bottom: 0.5rem;
      }
      /* log */
      #logView {
        white-space: pre-wrap;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: var(--radius);
        padding: 0.6rem;
        max-height: 160px;
        overflow: auto;
        margin-top: 0.75rem;
        width: 100%;
        font-size: 0.8rem;
        display: none;
      }
      /* tips */
      #tips {
        margin-top: 1rem;
        font-size: 0.75rem;
        color: #555;
        list-style: disc;
        padding-left: 1.2rem;
        width: 100%;
      }
      #tips li { margin-bottom: 0.25rem; }
      @media (max-width: 500px) {
        :root { --size: 80px; }
        .controls {
          grid-template-columns: 1fr auto;
          grid-template-rows: auto auto;
          grid-auto-flow: row;
        }
        .controls .btn { margin-top: 0.5rem; }
      }
    </style>
  </head>
  <body>
    <h1>Ticâ€‘Tacâ€‘Toe</h1>
    <section class="card">
      <div class="controls">
        <input id="apiKey" type="password" placeholder="Google API key" />
        <button id="micBtn" class="btn" title="Enable microphone">ðŸŽ¤</button>
        <button id="restartBtn" class="btn">Restart</button>
        <button id="logBtn" class="btn">ShowÂ Log</button>
      </div>
      <div id="board"></div>
      <div id="status"></div>
      <div id="remark"></div>
      <pre id="logView"></pre>
      <ul id="tips">
        <li>Square numbers (0â€‘8) are shown on each tile.</li>
        <li>ClickÂ ðŸŽ¤ then allow mic so the AI can hear you.</li>
        <li>Use <em>ShowÂ Log</em> to toggle the full conversation.</li>
      </ul>
    </section>

    <script>
      /* ---------- State ---------- */
      const board = Array(9).fill(null);
      const LINES = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];
      const MODELS = [
        'gemini-2.5-pro-exp-03-25',
        'gemini-2.0-flash',
        'gemini-2.0-flash-lite'
      ];
      const context = [];
      let lastSpeech = '';
      let gameEnded = false;

      /* ---------- DOM ---------- */
      const $ = id => document.getElementById(id);
      const apiKeyEl = $('apiKey');
      const statusEl = $('status');
      const remarkEl = $('remark');
      const boardEl = $('board');
      const micBtn = $('micBtn');
      const restartBtn = $('restartBtn');
      const logBtn = $('logBtn');
      const logView = $('logView');

      /* ---------- Board UI ---------- */
      for (let i = 0; i < 9; i++) {
        const btn = document.createElement('button');
        btn.className = 'square';
        btn.innerHTML = `<span class="indexLabel">${i}</span><span class="value"></span>`;
        btn.addEventListener('click', () => humanMove(i));
        boardEl.appendChild(btn);
      }
      const squares = [...boardEl.children];
      const renderBoard = () => squares.forEach((b, i) => b.querySelector('.value').textContent = board[i] || '');

      /* ---------- Utils ---------- */
      const speak = t => { if (!t || !window.speechSynthesis) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; window.speechSynthesis.speak(u); };
      const winner = s => LINES.find(([a, b, c]) => s[a] && s[a] === s[b] && s[a] === s[c]) ? s[LINES.find(([a, b, c]) => s[a] && s[a] === s[b] && s[a] === s[c])[0]] : null;
      const full   = s => s.every(Boolean);
      const minimax = (s, ai) => {
        const w = winner(s);
        if (w === 'O') return 1;
        if (w === 'X') return -1;
        if (full(s)) return 0;
        let best = ai ? -Infinity : Infinity;
        for (let i = 0; i < 9; i++) {
          if (s[i]) continue;
          s[i] = ai ? 'O' : 'X';
          const score = minimax(s, !ai);
          s[i] = null;
          best = ai ? Math.max(best, score) : Math.min(best, score);
        }
        return best;
      };
      const bestMove = s => {
        let best = -Infinity, move = -1;
        for (let i = 0; i < 9; i++) {
          if (s[i]) continue;
          s[i] = 'O';
          const score = minimax(s, false);
          s[i] = null;
          if (score > best) { best = score; move = i; }
        }
        return move;
      };
      const grid = s => s.map(v => v || '_').reduce((r, v, i) => (r[Math.floor(i / 3)] = (r[Math.floor(i / 3)] ? r[Math.floor(i / 3)] + ' ' : '') + v, r), ['', '', '']).join(' / ');
      const addCtx = (role, text) => { context.push({ role, text }); renderLog(); };
      const renderLog = () => { logView.textContent = context.map(c => `[${c.role}] ${c.text}`).join('\n'); };

      /* ---------- Gemini ---------- */
      const gemini = async (key, prompt) => {
        for (const model of MODELS) {
          try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.9, maxOutputTokens: 64 }
              })
            });
            if (!res.ok) continue;
            const data = await res.json();
            const txt = (data.candidates?.[0]?.content?.parts || []).map(p => p.text).join(' ').trim();
            if (txt) return txt;
          } catch { /* ignore */ }
        }
        return '';
      };
      const getAIReply = async (state, moveIdx) => {
        const key = apiKeyEl.value.trim();
        if (!key) return '';
        const prompt = `Context: ${context.map(c => `[${c.role}] ${c.text}`).join(' | ')}. Board: ${grid(state)}. ${moveIdx !== null ? `AI placed O on #${moveIdx}. ` : ''}${lastSpeech ? `Human said: "${lastSpeech}". ` : ''}Reply with ONE witty line (â‰¤15 words).`;
        return await gemini(key, prompt);
      };

      /* ---------- Speech recognition ---------- */
      let recognizer = null, lastTranscript = '';
      const initMic = () => {
        if (recognizer) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('Speech recognition not supported'); return; }
        recognizer = new SR();
        recognizer.lang = 'en-US';
        recognizer.continuous = true;
        recognizer.onresult = async e => {
          if (gameEnded) return;
          const txt = e.results[e.results.length - 1][0].transcript.trim();
          if (!txt || txt === lastTranscript) return;
          lastTranscript = txt;
          lastSpeech = txt;
          addCtx('Human', txt);
          const ai = await getAIReply([...board], null);
          if (ai) { remarkEl.textContent = ai; speak(ai); addCtx('AI', ai); }
          lastSpeech = '';
        };
        recognizer.onstart = () => micBtn.textContent = 'ðŸŽ¤âœ…';
        recognizer.start();
      };
      micBtn.addEventListener('click', () => { if (micBtn.textContent !== 'ðŸŽ¤âœ…') initMic(); });

      /* ---------- Game loop ---------- */
      const gameLoop = async () => {
        const w = winner(board);
        if (w) {
          gameEnded = true;
          const msg = w === 'X' ? 'You win!' : 'I win!';
          statusEl.textContent = msg;
          speak(msg);
          addCtx('AI', msg);
          return;
        }
        if (full(board)) {
          gameEnded = true;
          const msg = "It's a draw!";
          statusEl.textContent = msg;
          speak(msg);
          addCtx('AI', msg);
          return;
        }
        const xCnt = board.filter(v => v === 'X').length;
        const oCnt = board.filter(v => v === 'O').length;
        if (xCnt > oCnt) {
          statusEl.textContent = 'AI is thinkingâ€¦';
          const move = bestMove([...board]);
          if (move > -1) {
            await new Promise(r => setTimeout(r, 300));
            board[move] = 'O';
            renderBoard();
            const line = await getAIReply([...board], move);
            if (line) {
              remarkEl.textContent = line;
              speak(line);
              addCtx('AI', line);
            } else if (!apiKeyEl.value.trim()) {
              const warn = 'Please enter a valid Google API key for witty AI comments.';
              remarkEl.textContent = warn;
              speak(warn);
            }
          }
        }
        statusEl.textContent = 'Your turn (X)';
      };

      /* ---------- User actions ---------- */
      const humanMove = idx => {
        if (gameEnded || board[idx]) return;
        remarkEl.textContent = '';
        board[idx] = 'X';
        renderBoard();
        addCtx('Human', 'Played #' + idx);
        if (!apiKeyEl.value.trim()) {
          const warn = 'Please enter a valid Google API key for witty AI comments.';
          remarkEl.textContent = warn;
          speak(warn);
          addCtx('AI', warn);
        }
        gameLoop();
      };
      restartBtn.addEventListener('click', () => {
        board.fill(null);
        context.length = 0;
        gameEnded = false;
        lastSpeech = lastTranscript = '';
        statusEl.textContent = 'Your turn (X)';
        remarkEl.textContent = '';
        renderBoard();
        speak('Game restarted. Your turn.');
        logView.textContent = '';
        logView.style.display = 'none';
        logBtn.textContent = 'ShowÂ Log';
      });
      logBtn.addEventListener('click', () => {
        const vis = logView.style.display === 'block';
        logView.style.display = vis ? 'none' : 'block';
        logBtn.textContent = vis ? 'ShowÂ Log' : 'HideÂ Log';
      });

      /* ---------- Init ---------- */
      renderBoard();
      statusEl.textContent = 'Your turn (X)';
    </script>
  </body>
</html>
