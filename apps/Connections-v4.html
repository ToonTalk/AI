<!DOCTYPE html>
<html>
<head>
    <title>Connection Games Maker</title>
    <meta http-equiv="origin-trial" content="AoKPJltg5nlVza9cgI7c5mkWgtZ+rIE0Gmfp0AB3UqNwpEuOErI99n9xm7jGQrV7BsGdyaiSFRGkeB5h56rZbwMAAABweyJvcmlnaW4iOiJodHRwczovL2NsYXVkZS5haTo0NDMiLCJmZWF0dXJlIjoiQUlQcm9tcHRBUElNdWx0aW1vZGFsSW5wdXQiLCJleHBpcnkiOjE3NzQzMTA0MDAsImlzU3ViZG9tYWluIjp0cnVlfQ==">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #e9e9e9;
            color: #333;
        }

        #grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 15px;
          padding: 20px;
          width: 90%;
          max-width: 700px;
        }

        /* Grid Items */
        .grid-item {
          background-color: #ffffff;
          padding: 5px;
          text-align: center;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          cursor: pointer;
          transition: all 0.3s ease;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 80px;
          font-size: 1.2rem; /* Default font size for text */
          line-height: 1.2;
          word-break: break-word;
        }
        
        /* Specific, larger font size for emojis */
        .grid-item.emoji {
            font-size: 3.5rem;
        }

        .grid-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .grid-item.selected {
          background-color: #007bff;
          color: white;
          transform: scale(1.05);
        }

        .grid-item.found-fade-out {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .grid-item.lost {
            background-color: #d3d3d3;
            color: #555;
            cursor: not-allowed;
        }

        .valid-message {
            font-size: 20px;
            color: green;
            font-weight: bold;
        }

        .invalid-message {
            font-size: 20px;
            color: red;
            font-weight: bold;
        }
        
        /* Style for the button inside the status message */
        #statusMessage button {
            font-size: 14px;
            padding: 8px 12px;
            margin-left: 10px;
            background-color: #6c757d;
        }

        #mistakeCounter, #foundCategories {
            margin-top: 10px;
            font-size: 18px;
        }

        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          width: 24px;
          height: 24px;
          border-radius: 50%;
          border-left-color: #09f;
          animation: spin 1s linear infinite;
          margin-left: 10px;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        .loading-icon-hidden { display: none; }
        .loading-icon-visible { display: inline-block; vertical-align: middle; }

        .prompt-container {
            width: 90%;
            max-width: 700px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #gpt4Prompt {
          width: 100%;
          box-sizing: border-box;
          margin-top: 10px;
          padding: 10px;
          font-family: monospace;
          font-size: 14px;
          border: 1px solid #ccc;
          border-radius: 4px;
        }

        .modal {
          display: none;
          position: fixed;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.4);
          z-index: 1;
        }

        .modal-content {
          background-color: #fefefe;
          margin: 5% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
          max-width: 600px;
          border-radius: 10px;
          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }

        .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          cursor: pointer;
        }

        .close:hover { color: black; }

        button {
          background-color: #007bff;
          color: white;
          padding: 12px 20px;
          margin: 8px 4px;
          border: none;
          cursor: pointer;
          border-radius: 4px;
          font-size: 16px;
          transition: background-color 0.3s ease, transform 0.3s ease;
        }

        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.97); }

        #submitBtn { background-color: #4CAF50; }
        #clearBtn { background-color: #f44336; }
        #initializeGame { background-color: #008CBA; }
        
        #instructionsButton { background-color: #6c757d; }
        
        #addEmojiPromptBtn {
            background-color: #ff9800;
        }
        
        .game-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .info-panel-hidden {
            display: none;
        }

        .info-panel-visible {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .info-panel-content {
            background-color: #2c2c2c;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
            color: #f1f1f1;
        }

        .info-panel-content h2, .info-panel-content h3 {
            color: #4CAF50;
        }

        .info-panel-content code {
            background-color: #444;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        .info-panel-content a {
            color: #8ab4f8;
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #fff;
        }

        /* Styles for the solution container */
        #solution-container {
            margin-top: 20px;
            width: 90%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .solution-category-wrapper {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .solution-category-wrapper h4 {
            margin: 0 0 10px 0;
            text-transform: uppercase;
            font-weight: bold;
            color: #333;
        }

        .solution-items-wrapper {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .solution-item {
            cursor: default;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .solution-item:hover {
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body>
    <h1>Connection Games Maker</h1>
    
    <div id="instructionsModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>How to Play Connections</h2>
        <ol>
          <li><strong>Initialize the Game</strong>: Click the "Initialize Game" button to start a new game.</li>
          <li><strong>Select Words</strong>: Click on the words in the grid to select them (up to 4).</li>
          <li><strong>Submit Group</strong>: Click "Submit" to check if the words belong to a category.</li>
          <li><strong>Mistakes</strong>: You are allowed up to 4 mistakes.</li>
        </ol>
      </div>
    </div>

    <div id="gemini-info-panel" class="info-panel-hidden">
        <div class="info-panel-content">
            <span id="close-gemini-panel" class="close-btn">&times;</span>
            <h2>Gemini Nano AI Not Available</h2>
            <p>To use the built-in Gemini AI, please ensure you meet the requirements and have enabled the necessary features in Chrome.</p>
            <h3>How to Enable</h3>
            <ol>
                <li>Go to <code>chrome://flags</code> in your address bar.</li>
                <li>Enable <strong>#prompt-api-for-gemini-nano</strong>.</li>
                <li>Enable <strong>#optimization-guide-on-device-model</strong>.</li>
                <li>Relaunch your browser.</li>
            </ol>
        </div>
    </div>
    
    <div id="lmstudio-info-panel" class="info-panel-hidden">
        <div class="info-panel-content">
            <span id="close-lmstudio-panel" class="close-btn">&times;</span>
            <h2>Troubleshooting LM Studio</h2>
            <p>If you're having trouble connecting, please check the following steps:</p>
            
            <h3>1. Start the LM Studio Server</h3>
            <p>Make sure you've clicked the "Start Server" button on the Local Server tab (<code>&lt;-&gt;</code> icon) in LM Studio.</p>

            <h3>2. Load a Compatible Model</h3>
            <p>This application requires a model that supports the chat endpoint. Load an **"Instruct"** or **"Chat"** model. After loading it, verify that <code>POST /v1/chat/completions</code> appears in the "Supported endpoints" list.</p>

            <h3>3. Configure CORS for Hosted Games</h3>
            <p>Since this game is running from a web server, you must give it permission to access LM Studio.</p>
            <ol>
                <li>In LM Studio's server settings, check the box for **Enable CORS**.</li>
                <li>In the `Access-Control-Allow-Origin` text box, paste the following value:
                    <br>
                    <code id="cors-origin-value"></code>
                </li>
                 <li>Restart the server in LM Studio.</li>
            </ol>
        </div>
    </div>

    <label for="apiChoice">Choose AI Provider:</label>
    <select id="apiChoice">
      <option value="gemini" selected>Gemini Nano (Local)</option>
      <option value="openai">OpenAI GPT-5</option>
      <option value="lm-studio">LM Studio (Local)</option>
    </select>
    
    <div id="apiKeyContainer" style="display: none;">
        <label for="apiKey">Enter API Key:</label>
        <input type="password" id="apiKey">
    </div>
    
    <div class="game-controls">
        <button id="initializeGame">Initialize Game</button>
        <button id="addEmojiPromptBtn">Use Emojis</button>
        <button id="instructionsButton">Instructions</button>
        <div id="loadingIcon" class="loading-icon-hidden">
          <div class="spinner"></div>
        </div>
    </div>

    <div style="text-align: center; margin-bottom: 10px;">
        <div id="mistakeCounter">Mistakes: 0</div>
        <div id="foundCategories">Found Categories:</div>
        <div id="statusMessage"></div>
    </div>

    <div id="grid"></div>
    <div id="solution-container"></div>
    <button id="submitBtn">Submit</button>
    <button id="clearBtn">Clear</button>
    
    <br>
    <div class="prompt-container">
        <div class="prompt-header">
            <label for="gpt4Prompt">Optionally edit the prompt:</label>
        </div>
        <div>
            <textarea id="gpt4Prompt" rows="16">
Generate 4 categories of words, each containing exactly 4 unique words.
Ensure that no words are duplicated across categories. In total, there should be exactly 16 unique words.
Make sure the same word does not appear in more than one category. Try to include words that could be ambiguous
and fit into more than one category. For example, the word 'mouse' could be ambiguous if both 'ANIMALS' and 
'COMPUTER PARTS' are categories but it should be part of only one category. But don't use the mouse example.
Categories can also be like "FIRE ___" for Ant, Drill, Island, Opal. Or something else about the words 
independent of their meaning.
</textarea>
        </div>
    </div>
    
    <script>
        // Initialize game state
        let selectedItems = [];
        let foundCategories = [];
        let mistakes = 0;
        let categories = {};
        let aiSession = null;

        // ### Core Game Logic ###

        function populateGrid(itemsToDisplay) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            itemsToDisplay.forEach((itemText) => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.textContent = itemText;
                const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/;
                if (emojiRegex.test(itemText)) {
                    gridItem.classList.add('emoji');
                }
                gridItem.addEventListener('click', handleItemClick);
                grid.appendChild(gridItem);
            });
        }

        function handleItemClick() {
            const itemText = this.textContent;
            const index = selectedItems.indexOf(itemText);
            if (index > -1) {
                selectedItems.splice(index, 1);
                this.classList.remove('selected');
            } else if (selectedItems.length < 4) {
                selectedItems.push(itemText);
                this.classList.add('selected');
            }
        }

        function validateSelectedItems(selected) {
            for (const [category, items] of Object.entries(categories)) {
                if (selected.length === items.length && selected.every(item => items.includes(item))) {
                    return ['correct', category];
                }
            }
            for (const [category, items] of Object.entries(categories)) {
                const intersection = selected.filter(item => items.includes(item));
                if (intersection.length === 3) {
                    return ['one-away', category];
                }
            }
            return ['incorrect', null];
        }

        function handleSubmit() {
            if (selectedItems.length !== 4) {
                updateStatusMessage('Please select exactly 4 items.', 'invalid-message');
                return;
            }
            const [result, category] = validateSelectedItems(selectedItems);
            if (result === 'correct') {
                foundCategories.push(category);
                document.getElementById('foundCategories').textContent = `Found Categories: ${foundCategories.join(', ')}`;
                updateStatusMessage('Valid group found!', 'valid-message');
                document.querySelectorAll('.grid-item.selected').forEach(gridItem => {
                    gridItem.classList.add('found-fade-out');
                });
                clearSelection();
                setTimeout(() => {
                    if (foundCategories.length === Object.keys(categories).length) {
                        displayFinalSolution(true);
                    } else {
                        let remainingItems = Object.entries(categories)
                            .filter(([cat, _]) => !foundCategories.includes(cat))
                            .flatMap(([_, items]) => items);
                        populateGrid(shuffleArray(remainingItems));
                    }
                }, 500);
            } else {
                mistakes++;
                document.getElementById('mistakeCounter').textContent = `Mistakes: ${mistakes}`;
                if (result === 'one-away') {
                    updateStatusMessage('One away...', 'invalid-message');
                } else {
                    updateStatusMessage('Invalid group. Try again.', 'invalid-message');
                }
                if (mistakes >= 4) {
                    displayFinalSolution(false);
                }
            }
        }

        function displayFinalSolution(isWin) {
            const message = isWin ? 'Congratulations, you have won!' : 'You have lost! Here is the solution:';
            updateStatusMessage(message, isWin ? 'valid-message' : 'invalid-message');
            document.getElementById('grid').innerHTML = '';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            const solutionContainer = document.getElementById('solution-container');
            solutionContainer.innerHTML = '';
            const categoryColors = ['#a0c4ff', '#9bf6ff', '#ffadad', '#ffd6a5'];
            let colorIndex = 0;
            for (const categoryName in categories) {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'solution-category-wrapper';
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = categoryName;
                categoryWrapper.appendChild(categoryTitle);
                const itemsWrapper = document.createElement('div');
                itemsWrapper.className = 'solution-items-wrapper';
                categoryWrapper.style.backgroundColor = categoryColors[colorIndex++ % categoryColors.length];
                categories[categoryName].forEach(itemText => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'grid-item solution-item';
                    itemDiv.textContent = itemText;
                    const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/;
                    if (emojiRegex.test(itemText)) itemDiv.classList.add('emoji');
                    itemsWrapper.appendChild(itemDiv);
                });
                categoryWrapper.appendChild(itemsWrapper);
                solutionContainer.appendChild(categoryWrapper);
            }
        }

        function clearSelection() {
            selectedItems = [];
            document.querySelectorAll('.grid-item.selected').forEach(item => item.classList.remove('selected'));
        }

        // ### AI Interaction and Game Initialization ###

        async function initializeAI(showUserFeedback = false) {
            if (typeof LanguageModel === 'undefined') {
                if (showUserFeedback) document.getElementById('gemini-info-panel').className = 'info-panel-visible';
                throw new Error("LanguageModel API not available.");
            }
            try {
                const availability = await LanguageModel.availability();
                if (availability === "available" || availability === "readily") {
                    if (!aiSession) aiSession = await LanguageModel.create();
                    console.log("AI session created successfully");
                } else {
                    throw new Error(`AI capabilities not available. Status: ${availability}`);
                }
            } catch (error) {
                console.error('Error initializing AI:', error);
                if (showUserFeedback) updateStatusMessage(`Error initializing AI: ${error.message}.`, 'invalid-message');
                throw error;
            }
        }

        async function geminiNano(prompt) {
            if (!aiSession) await initializeAI(true);
            try {
                return await aiSession.prompt(prompt);
            } catch (error) {
                updateStatusMessage('Error during AI interaction.', 'invalid-message');
                throw error;
            }
        }
        
        async function callOpenAI(apiKey, fullPrompt) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "gpt-5", messages: [{ "role": "user", "content": fullPrompt }] })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) return data.choices[0].message.content;
                throw new Error("Invalid response format from OpenAI.");
            } catch (error) {
                updateStatusMessage('Error communicating with OpenAI.', 'invalid-message');
                throw error;
            }
        }

        async function callLMStudio(fullPrompt) {
            try {
                const response = await fetch('http://localhost:1234/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "local-model",
                        messages: [{ "role": "user", "content": fullPrompt }]
                    })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) return data.choices[0].message.content;
                throw new Error("Invalid response format from LM Studio.");
            } catch (error) {
                const troubleshootButton = `<button onclick="showLMStudioHelp()">Troubleshoot</button>`;
                updateStatusMessage(`Error communicating with LM Studio. ${troubleshootButton}`, 'invalid-message');
                throw error;
            }
        }

        function validateCategories(categoriesData) {
            if (Object.keys(categoriesData).length !== 4) return false;
            const allWords = Object.values(categoriesData).flat();
            const uniqueWords = new Set(allWords);
            return uniqueWords.size === 16 && allWords.length === 16;
        }

        async function handleApiResponse(apiResponse, originalUserPrompt, apiConfig, attempt = 1) {
            if (!apiResponse) {
                updateStatusMessage("No valid response from AI.", "invalid-message");
                return;
            }
            try {
                const jsonMatch = apiResponse.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("No JSON object found in the response.");
                const parsedCategories = JSON.parse(jsonMatch[0]);
                if (validateCategories(parsedCategories)) {
                    categories = parsedCategories;
                    initGame();
                } else {
                    if (attempt >= 3) throw new Error("AI failed to provide a valid game after multiple attempts.");
                    updateStatusMessage(`AI response invalid. Retrying... (Attempt ${attempt + 1})`, 'invalid-message');
                    const reprompt = `The previous response was invalid. Please try again. Ensure the new response contains exactly 4 categories, each with exactly 4 unique words, for a total of 16 unique words with no duplicates. The entire output must be only a single JSON object.\n\nOriginal request: ${originalUserPrompt}`;
                    const newFullPrompt = constructFullPrompt(reprompt);
                    let result;
                    switch (apiConfig.choice) {
                        case 'openai': result = await callOpenAI(apiConfig.key, newFullPrompt); break;
                        case 'gemini': result = await geminiNano(newFullPrompt); break;
                        case 'lm-studio': result = await callLMStudio(newFullPrompt); break;
                    }
                    await handleApiResponse(result, originalUserPrompt, apiConfig, attempt + 1);
                }
            } catch (error) {
                updateStatusMessage(`Failed to process AI response: ${error.message}`, "invalid-message");
            }
        }

        function initGame() {
            mistakes = 0;
            foundCategories = [];
            selectedItems = [];
            document.getElementById('mistakeCounter').textContent = `Mistakes: 0`;
            document.getElementById('foundCategories').textContent = `Found Categories: `;
            updateStatusMessage('', '');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;
            if(document.getElementById('solution-container')) document.getElementById('solution-container').innerHTML = '';
            populateGrid(shuffleArray(Object.values(categories).flat()));
        }

        // ### UI and Utility Functions ###

        function constructFullPrompt(userPrompt) {
            const jsonStructure = [
                'The output must be only a single valid JSON object containing exactly 4 categories with 4 unique string items each. Use double quotes.',
                'Example:', '{ "FISH": ["Bass", "Flounder", "Salmon", "Trout"], "PLANETS": ["Earth", "Mars", "Jupiter", "Venus"], "COLORS": ["Red", "Blue", "Green", "Yellow"], "FRUITS": ["Apple", "Banana", "Cherry", "Date"] }'
            ];
            return [userPrompt, ...jsonStructure].join("\n");
        }

        function updateStatusMessage(message, className) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = message;
            statusMessage.className = className;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function toggleLoadingIcon(show) {
            document.getElementById('loadingIcon').style.display = show ? 'inline-block' : 'none';
        }
        
        function showLMStudioHelp() {
            const panel = document.getElementById('lmstudio-info-panel');
            document.getElementById('cors-origin-value').textContent = window.location.origin;
            panel.className = 'info-panel-visible';
        }

        // ### Event Listeners ###

        document.addEventListener('DOMContentLoaded', () => {
            const setupPanel = (panelId, buttonId, closeId) => {
                const panel = document.getElementById(panelId);
                const btn = document.getElementById(buttonId);
                const closeBtn = document.getElementById(closeId);
                if (btn) btn.onclick = () => { if (panel) panel.className = 'info-panel-visible'; };
                if (closeBtn) closeBtn.onclick = () => { if (panel) panel.className = 'info-panel-hidden'; };
            };

            const instructionsModal = document.getElementById('instructionsModal');
            if (instructionsModal) {
                 const instructionsButton = document.getElementById('instructionsButton');
                 if (instructionsButton) instructionsButton.onclick = () => { instructionsModal.style.display = 'block'; };
                 const closeSpan = instructionsModal.querySelector('.close');
                 if(closeSpan) closeSpan.onclick = () => { instructionsModal.style.display = 'none'; };
                 window.onclick = (event) => { if (event.target == instructionsModal) instructionsModal.style.display = 'none'; };
            }

            setupPanel('gemini-info-panel', null, 'close-gemini-panel');
            setupPanel('lmstudio-info-panel', null, 'close-lmstudio-panel');
            
            document.getElementById('initializeGame').addEventListener('click', async function() {
                const apiChoice = document.getElementById('apiChoice').value;
                const userPrompt = document.getElementById('gpt4Prompt').value;
                const apiConfig = { choice: apiChoice, key: document.getElementById('apiKey').value };
                toggleLoadingIcon(true);
                try {
                    const fullPrompt = constructFullPrompt(userPrompt);
                    let result;
                    switch (apiChoice) {
                        case 'openai': result = await callOpenAI(apiConfig.key, fullPrompt); break;
                        case 'gemini': result = await geminiNano(fullPrompt); break;
                        case 'lm-studio': result = await callLMStudio(fullPrompt); break;
                        default: 
                            updateStatusMessage('Please select an AI Provider.', 'invalid-message');
                            toggleLoadingIcon(false);
                            return;
                    }
                    if (result) await handleApiResponse(result, userPrompt, apiConfig);
                } catch (error) {
                    console.error('Error during API interaction:', error);
                } finally {
                    toggleLoadingIcon(false);
                }
            });

            document.getElementById('apiChoice').addEventListener('change', function() {
                const needsApiKey = this.value === 'openai';
                document.getElementById('apiKeyContainer').style.display = needsApiKey ? 'block' : 'none';
            });
            
            document.getElementById('addEmojiPromptBtn').addEventListener('click', function() {
                const promptTextArea = document.getElementById('gpt4Prompt');
                const emojiInstruction = "\n\nUse emojis instead of words but leave category labels as words.";
                if (!promptTextArea.value.includes(emojiInstruction.trim())) {
                    promptTextArea.value += emojiInstruction;
                }
            });

            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('clearBtn').addEventListener('click', clearSelection);

            categories = {'FISH':['Bass','Flounder','Salmon','Trout'],'PLANETS':['Earth','Mars','Jupiter','Venus'],'COLORS':['Red','Blue','Green','Yellow'],'FRUITS':['Apple','Banana','Cherry','Date']};
            initGame();
            initializeAI(false).catch(e => console.log("Pre-init of local AI failed."));
        });
    </script>
</body>
</html>