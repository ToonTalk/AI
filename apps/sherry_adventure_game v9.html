<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Girl and Her Laptop in Ancient Sumer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #F4A460 100%);
            min-height: 100vh;
            color: #2F1B14;
        }

        .game-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 25px;
            min-height: 100vh;
        }

        .main-panel {
            background: rgba(255, 248, 220, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid #8B4513;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-panel, .diary-panel, .ai-panel {
            background: rgba(255, 248, 220, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid #8B4513;
        }

        .game-title {
            text-align: center;
            color: #8B4513;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .api-setup {
            background: #FFF8DC;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #D2691E;
            margin-bottom: 20px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .story-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.7);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #8B4513;
        }

        .story-text p, .ai-message p {
            margin-bottom: 1em;
        }
        .story-text p:last-child, .ai-message p:last-child {
            margin-bottom: 0;
        }
        
        .custom-action-area {
            margin-top: 20px; 
            padding: 15px; 
            background: rgba(255,255,255,0.8); 
            border-radius: 10px; 
            border: 2px dashed #8B4513;
        }
        
        .custom-action-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #customAction {
            flex-grow: 1;
            margin: 0;
        }


        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #4682B4, #5F9EA0);
            text-align: left;
            padding: 15px;
            border-radius: 10px;
        }

        .choice-btn:hover {
            background: linear-gradient(45deg, #5F9EA0, #4682B4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            border: 1px solid #8B4513;
        }

        .stat-label {
            font-size: 12px;
            color: #8B4513;
            font-weight: bold;
        }

        .stat-value {
            font-size: 16px;
            color: #2F1B14;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #DDD;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B4513, #D2691E);
            transition: width 0.3s ease;
        }

        .diary-entry {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #8B4513;
            font-style: italic;
            font-size: 14px;
        }

        .ai-chat {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #4682B4;
        }

        .ai-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #4682B4;
            border-radius: 5px;
            margin-top: 10px;
        }

        .ai-message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 5px;
        }

        .ai-message.user {
            background: #E6F3FF;
            text-align: right;
        }

        .ai-message.ai {
            background: #F0F8F0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #8B4513;
            font-style: italic;
        }

        .day-header {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        #timeline {
            margin-top: 20px;
            padding: 10px;
        }

        #timeline-text {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #2F1B14;
            margin-bottom: 5px;
        }


        .btn.recording {
            background: linear-gradient(45deg, #DC143C, #FF69B4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .audio-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00FF00;
            border-radius: 50%;
            margin-left: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="main-panel">
            <h1 class="game-title">A Girl and Her Laptop in Ancient Sumer</h1>
            
            <div class="api-setup" id="apiSetup">
                <h3>ü§ñ AI Partnership Setup</h3>
                <p>To experience the full AI collaboration, enter your Gemini API key:</p>
                <input type="password" class="api-input" id="apiKey" placeholder="Enter your Gemini API key...">
                <label for="modelSelect" style="font-size: 14px; color: #8B4513; font-weight: bold;">Gemini Model:</label>
                <select class="api-input" id="modelSelect" onchange="handleModelChange()">
                    <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash Preview 05-20 (Multimodal)</option>
                    <option value="gemini-2.5-flash-preview-native-audio-dialog">Gemini 2.5 Flash Native Audio Dialog üé§üîä</option>
                    <option value="gemini-2.5-flash-exp-native-audio-thinking-dialog">Gemini 2.5 Flash Native Audio Thinking üé§üîä</option>
                    <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS üîä</option>
                    <option value="gemini-2.5-pro-preview-06-05">Gemini 2.5 Pro Preview (Enhanced)</option>
                    <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS üîä</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Fast)</option>
                    <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite (Efficient)</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Experimental + Image Generation üé®</option>
                    <option value="imagen-3.0-generate-002">Imagen 3 (High-Quality Images) üñºÔ∏è‚ú®</option>
                </select>
                <div id="audioWarning" style="display: none; margin-top: 10px; padding: 10px; background: #FFE4B5; border: 1px solid #D2691E; border-radius: 5px; font-size: 12px;">
                    üé§ Audio features enabled! If your browser asks for microphone permission, please allow it.
                </div>
                <div id="imageWarning" style="display: none; margin-top: 10px; padding: 10px; background: #E6F3FF; border: 1px solid #4682B4; border-radius: 5px; font-size: 12px;">
                    üé® Image generation enabled! Scenes will include AI-generated illustrations.
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #F0F8FF; border: 1px solid #4682B4; border-radius: 5px;">
                    <label style="display: flex; align-items: center; font-size: 14px; color: #8B4513; font-weight: bold;">
                        <input type="checkbox" id="enableImageGeneration" style="margin-right: 8px;" onchange="toggleImageGeneration()" checked>
                        Generate Scene Illustrations
                    </label>
                    <div id="imageToggleDescription" style="font-size: 12px; color: #666; margin-top: 5px; display: none;">
                        Creates beautiful procedural artwork for each scene with dynamic themes
                    </div>
                </div>
                <button class="btn" onclick="setupAPI()">Connect AI Partner</button>
                <p style="font-size: 12px; margin-top: 10px; color: #666;">
                    Get your free API key at <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                </p>
            </div>

            <div id="gameContent" style="display: none;">
                <div class="day-header" id="dayHeader">Day 1 - Through the Portal</div>
                <div class="story-text" id="storyText"></div>
                <div id="sceneImage" style="text-align: center; margin: 20px 0; display: none;">
                    <canvas id="sceneCanvas" width="400" height="300" style="border-radius: 10px; border: 3px solid #8B4513; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background: #F4A460;"></canvas>
                    <div id="illustrationCaption" style="font-size: 12px; color: #8B4513; margin-top: 5px; font-style: italic;">üé® AI-generated dynamic illustration</div>
                </div>
                <div class="choices" id="choices"></div>
                
                <div class="custom-action-area">
                    <h4 style="margin: 0 0 10px 0; color: #8B4513;">‚ú® Custom Action</h4>
                    <div class="custom-action-controls">
                        <input type="text" id="customAction" class="api-input" placeholder="Describe your own action..." onkeypress="handleCustomActionInput(event)">
                        <button class="btn" id="speakCustomActionBtn" onclick="toggleCustomActionRecording()">üé§</button>
                        <button class="btn" onclick="takeCustomAction()" id="customActionBtn">Take Action</button>
                    </div>
                </div>

                <div id="timeline">
                    <div id="timeline-text">Day 1 of 1001</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="timelineBar" style="width: 0.1%"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 10px;">
                     <button class="btn" onclick="saveStory()">Save Story to HTML</button>
                </div>
                
                <div class="loading" id="loading">üîÆ The AI is thinking...</div>
            </div>
        </div>

        <div class="side-panel">
            <div class="stats-panel">
                <h3>üìä Status</h3>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-label">SURVIVAL</div>
                        <div class="stat-value" id="survival">85</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="survivalBar" style="width: 85%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">SUMERIAN</div>
                        <div class="stat-value" id="sumerian">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="sumerianBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">KING'S RESPECT</div>
                        <div class="stat-value" id="kingRespect">40</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="kingRespectBar" style="width: 40%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">KU-BABA'S TRUST</div>
                        <div class="stat-value" id="kubabaTrust">40</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="kubabaTrustBar" style="width: 40%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">CREATIVITY</div>
                        <div class="stat-value" id="creativity">70</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="creativityBar" style="width: 70%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">DAYS SURVIVED</div>
                        <div class="stat-value" id="dayCount">1</div>
                    </div>
                </div>
                <div class="stat" style="margin-top: 15px;">
                    <div class="stat-label">LAPTOP BATTERY</div>
                    <div class="stat-value" id="battery">60%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="batteryBar" style="width: 60%"></div>
                    </div>
                </div>
            </div>

            <div class="diary-panel">
                <h3>üìñ Sherry's Diary</h3>
                <button class="btn" onclick="saveDiary()" style="width: 100%; margin-bottom: 10px; font-size: 14px;">üíæ Save Diary to HTML</button>
                <div id="diaryEntries">
                    <div class="diary-entry" data-scene-key="start">
                        <strong>Day 1:</strong> I can't believe this is real. I touched that weird shimmery doorway and now I'm in actual ancient Sumer! Nobody understands me and I can't understand them. The King is going to kill me tomorrow night if I can't entertain him, but we can't even talk to each other. My laptop might be my only hope...
                    </div>
                </div>
            </div>

            <div class="ai-panel">
                <h3>ü§ñ AI Partner</h3>
                <div class="ai-chat" id="aiChat">
                    <div class="ai-message ai">Hello! I'm your AI partner. Together we can solve any challenge in ancient Sumer. What would you like to work on?</div>
                </div>
                <div id="audioControls" style="display: none; margin: 10px 0;">
                    <button class="btn" id="recordBtn" onclick="toggleRecording()" style="width: 48%; margin-right: 2%;">üé§ Speak</button>
                    <button class="btn" id="playLastBtn" onclick="playLastResponse()" style="width: 48%;" disabled>üîä Replay</button>
                </div>
                <input type="text" class="ai-input" id="aiInput" placeholder="Ask your AI partner for help..." onkeypress="handleAIInput(event)" disabled>
                <button class="btn" onclick="sendAIMessage()" id="aiSendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            day: 1,
            survival: 85,
            kingRespect: 40,
            kubabaTrust: 40,
            creativity: 70,
            battery: 60,
            apiKey: null,
            selectedModel: 'gemini-2.5-flash-preview-05-20',
            sumerianLevel: 0, 
            currentScene: 'start',
            firstChoiceMade: false, 
            sceneHistory: ['start'], 
            sceneScripts: {}, 
            audioSupported: false,
            ttsSupported: false,
            audioInputSupported: false,
            imageGenerationSupported: false,
            forceImageGeneration: true, 
            isRecording: false,
            isCustomActionRecording: false
        };

        const modelCapabilities = {
            'gemini-2.5-flash-preview-native-audio-dialog': { input: true, output: true, image: false, imageType: null },
            'gemini-2.5-flash-exp-native-audio-thinking-dialog': { input: true, output: true, image: false, imageType: null },
            'gemini-2.5-flash-preview-tts': { input: false, output: true, image: false, imageType: null },
            'gemini-2.5-pro-preview-tts': { input: false, output: true, image: false, imageType: null },
            'gemini-2.0-flash-exp': { input: false, output: false, image: true, imageType: 'gemini' },
            'imagen-3.0-generate-002': { input: false, output: false, image: true, imageType: 'imagen' }
        };

        let recognition;
        let customActionRecognition;
        let lastSpokenResponse = null;

        const scenes = {
            start: {
                title: "Day 1 - Through the Portal",
                text: "You're standing in the King's throne room, trembling with fear. The enormous chamber is lit by hundreds of oil lamps casting dancing shadows on the walls. The King sits on his throne, looking bored and impatient. He's speaking to someone in rapid Sumerian - a language that sounds like musical gibberish to you.\n\nThree people have already been thrown from the window tonight for failing to entertain him. The guards are gesturing at you and speaking in that same incomprehensible language. You catch one word that sounds like 'lugal' - but you have no idea what it means.\n\nYour laptop is in your backpack. The battery shows 60%. The King notices you and barks something in Sumerian, clearly expecting a response. What do you do?",
                artPrompt: "A vast, shadowy Sumerian throne room lit by flickering oil lamps. A powerful, bored-looking king sits on an ornate throne. A small, modern girl stands before him, looking terrified. The mood is tense and dangerous.",
                choices: [
                    { text: "Pull out the laptop immediately - maybe the light will stop him from getting angry", effects: { kingRespect: 5, battery: -10, survival: 10 }, next: "laptop_reveal" },
                    { text: "Try to mime and gesture to show you don't understand the language", effects: { kubabaTrust: 5, survival: -5 }, next: "language_barrier" },
                    { text: "Look around desperately for someone who might help", effects: { kubabaTrust: 10, survival: 5 }, next: "seek_help" },
                    { text: "Ask your AI partner how to handle this language barrier crisis", effects: { creativity: 10 }, next: "ai_consultation", requiresAI: true }
                ]
            },
            laptop_reveal: {
                title: "Day 1 - The Magic Light",
                text: "You pull out your laptop with shaking hands. As the screen lights up in the dark throne room, everyone goes completely silent. The startup sound echoes through the chamber. The King's angry expression transforms into wide-eyed amazement.\n\nHe says something in rapid Sumerian that sounds excited but you understand nothing. He points at the screen and then at you, his voice rising with what sounds like questions. An old woman in the corner - she must be Ku-Baba - says something softly to the King. He nods and makes a gesture.\n\nThe King is clearly fascinated, but you're still trapped by the language barrier. You can see his patience might not last long if you can't figure out how to communicate.",
                artPrompt: "A Sumerian throne room, previously dark, is now illuminated by the bright blue and white glow of a laptop screen held by a young girl. The King leans forward on his throne, his face a mixture of shock and awe. Guards look on, stunned into silence.",
                choices: [
                    { text: "Point at yourself, then the laptop, then mime typing to show it's yours", effects: { kingRespect: 10, sumerianLevel: 5 }, next: "basic_communication" },
                    { text: "Open a simple program and let him see the screen change", effects: { kingRespect: 20, battery: -15, creativity: 10 }, next: "visual_demonstration" },
                    { text: "Try to teach him the English word 'computer' by pointing and repeating", effects: { sumerianLevel: 3, kubabaTrust: 5 }, next: "word_exchange" }
                ]
            },
            language_barrier: {
                title: "Day 1 - Lost in Translation",
                text: "You spread your hands wide and shake your head, trying to show you don't understand. The King's face darkens. He says something sharp and commanding. Guards step forward.\n\nSuddenly, the old woman in the corner - Ku-Baba - stands up. She shuffles over and places herself between you and the guards. She speaks to the King in what sounds like pleading tones, gesturing toward you. You catch her making motions like she's writing in the air.\n\nThe King listens, then looks at you with curiosity instead of anger. Ku-Baba turns to you and very slowly says a few words in Sumerian, pointing at herself: 'Ku... Ba... Ba.' Then she points at you with a questioning expression.",
                artPrompt: "Two imposing Sumerian guards are stepping towards a frightened girl. An elderly, wise-looking woman (Ku-Baba) stands protectively between them, addressing the King on his throne. The mood shifts from hostile to curious.",
                choices: [
                    { text: "Point to yourself and clearly say 'Sherry'", effects: { kubabaTrust: 15, sumerianLevel: 5 }, next: "name_exchange" },
                    { text: "Try to copy her gestures and pointing", effects: { kubabaTrust: 10, sumerianLevel: 3 }, next: "gesture_learning" },
                    { text: "Pull out your laptop to show you have something valuable", effects: { kingRespect: 10, battery: -5 }, next: "laptop_intervention" }
                ]
            }
        };
        
        function markdownToHtml(text) {
            if (!text) return '';
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            return html.split('\n\n').map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
        }

        function toggleImageGeneration() {
            const checkbox = document.getElementById('enableImageGeneration');
            gameState.forceImageGeneration = checkbox.checked;
            
            if (checkbox.checked) {
                if (gameState.currentScene && scenes[gameState.currentScene]) {
                    generateSceneImage(scenes[gameState.currentScene]);
                }
            } else {
                document.getElementById('sceneImage').style.display = 'none';
            }
        }

        function handleModelChange() {
            const selectedModel = document.getElementById('modelSelect').value;
            const audioWarning = document.getElementById('audioWarning');
            const imageWarning = document.getElementById('imageWarning');
            
            const capabilities = modelCapabilities[selectedModel];
            const hasAudio = (capabilities && (capabilities.input || capabilities.output)) || ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            
            if (hasAudio) {
                audioWarning.style.display = 'block';
            } else {
                audioWarning.style.display = 'none';
            }
            
            if (capabilities && capabilities.image) {
                imageWarning.style.display = 'block';
            } else {
                imageWarning.style.display = 'none';
            }
        }

        function updateAudioControls() {
            const audioControls = document.getElementById('audioControls');
             const hasAudio = (gameState.audioSupported) || ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            if (hasAudio) {
                audioControls.style.display = 'block';
            } else {
                audioControls.style.display = 'none';
            }
        }

        function setupAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const selectedModel = document.getElementById('modelSelect').value;
            
            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }
            
            gameState.apiKey = apiKey;
            gameState.selectedModel = selectedModel;
            
            const capabilities = modelCapabilities[selectedModel];
            if (capabilities) {
                gameState.audioInputSupported = capabilities.input;
                gameState.ttsSupported = capabilities.output;
                gameState.audioSupported = capabilities.input || capabilities.output;
                gameState.imageGenerationSupported = capabilities.image;
            } else {
                Object.assign(gameState, { audioInputSupported: false, ttsSupported: false, audioSupported: false, imageGenerationSupported: false });
            }

            initializeBrowserRecognition();
            initializeCustomActionRecognition();
            
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('aiInput').disabled = false;
            document.getElementById('aiSendBtn').disabled = false;
            document.getElementById('customActionBtn').disabled = false;
            
            updateAudioControls();
            loadScene('start');
        }

        function handleCustomActionInput(event) {
            if (event.key === 'Enter') {
                takeCustomAction();
            }
        }

        function takeCustomAction() {
            const customText = document.getElementById('customAction').value.trim();
            if (!customText) {
                alert('Please describe what you want to do');
                return;
            }
            
            if (!gameState.apiKey) {
                alert('Custom actions require an API key to process');
                return;
            }

            addDiaryEntry(customText);

            const customChoice = {
                text: customText,
                effects: {}, 
                isCustom: true
            };
            
            document.getElementById('customAction').value = '';
            generateNewScene(customChoice);
        }

        function loadScene(sceneKey) {
            const scene = scenes[sceneKey];
            if (!scene) return;

            if (!gameState.sceneHistory.includes(sceneKey)) {
                gameState.sceneHistory.push(sceneKey);
            }
            gameState.currentScene = sceneKey;

            document.getElementById('dayHeader').textContent = scene.title;
            document.getElementById('storyText').innerHTML = markdownToHtml(scene.text);
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            if (scene.choices) {
                scene.choices.forEach((choice, index) => {
                    if (choice.requiresAI && !gameState.apiKey) return;
                    
                    const button = document.createElement('button');
                    button.className = 'btn choice-btn';
                    button.textContent = choice.text;
                    button.onclick = () => makeChoice(choice);
                    choicesDiv.appendChild(button);
                });
            }

            if (sceneKey === 'start' || gameState.forceImageGeneration) {
                generateSceneImage(scene);
            } else {
                document.getElementById('sceneImage').style.display = 'none';
            }
        }

        async function generateSceneImage(scene) {
            const sceneImageDiv = document.getElementById('sceneImage');
            const canvas = document.getElementById('sceneCanvas');
            const ctx = canvas.getContext('2d');
            
            sceneImageDiv.style.display = 'block';
            
            const caption = document.getElementById('illustrationCaption');
            caption.innerHTML = `üé® AI-generated dynamic illustration`;
            caption.style.color = '#8B4513';
            caption.style.fontStyle = 'italic';
            caption.style.fontWeight = 'normal';

            if (gameState.currentScene === 'start') {
                 if (canvas.animationId) {
                    cancelAnimationFrame(canvas.animationId);
                }
                drawFallbackScene(ctx, scene);
                return;
            }
            
            if (!gameState.apiKey) return;

            if (!scene.artPrompt) {
                console.log("No art prompt for this scene. Keeping previous illustration.");
                return;
            }

            try {
                const basePrompt = `
                You are a creative programmer generating animated scenes for an HTML5 canvas.
                The following variables are already defined and available for you to use:
                - 'canvas': The HTML5 canvas element (400x300 pixels).
                - 'ctx': The 2D rendering context of the canvas.
                Your task: Write the body of a JavaScript animation loop.
                
                IMPORTANT CODING NOTE: When using gradients, ensure addColorStop is used correctly with two separate arguments.
                CORRECT USAGE:
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, '#8B4513'); // Offset (0-1) and color are separate arguments.
                gradient.addColorStop(1, '#F4A460');
                ctx.fillStyle = gradient;
                INCORRECT USAGE: gradient.addColorStop('#8B4513, 0');

                The code should:
                1. Draw a scene on the 'ctx' based on the following description.
                2. Use warm, ancient Sumerian-themed colors (e.g., #F4A460, #D2691E, #8B4513).
                3. Include a subtle, continuous animation using something like Math.sin(Date.now() / 1000).
                4. DO NOT declare the 'canvas' or 'ctx' variables. Assume they exist.
                5. Return only the raw JavaScript code for the animation frame.
                SCENE DESCRIPTION: "${scene.artPrompt}"`;
                
                const response = await callGeminiAPI(basePrompt);
                const jsCode = extractJavaScriptCode(response);

                if (jsCode) {
                    console.log('New AI art is ready. Replacing current illustration.');
                    gameState.sceneScripts[gameState.currentScene] = jsCode; 
                    if (canvas.animationId) {
                        cancelAnimationFrame(canvas.animationId);
                    }
                    const drawFunction = new Function('canvas', 'ctx', jsCode);
                    startSceneAnimation(canvas, drawFunction);
                } else {
                    console.log('AI returned no valid code. Keeping previous illustration.');
                }
            } catch (error) {
                console.error('AI generation failed:', error);
                if (error.message === 'RATE_LIMIT_EXCEEDED') {
                    caption.innerHTML = `‚ö†Ô∏è Illustration failed: Rate limit exceeded.`;
                    caption.style.color = 'red';
                    caption.style.fontStyle = 'normal';
                    caption.style.fontWeight = 'bold';
                }
            }
        }

        function extractJavaScriptCode(response) {
            let code = response.trim();
            
            if (code.includes('```javascript')) {
                code = code.split('```javascript')[1].split('```')[0].trim();
            } else if (code.includes('```')) {
                code = code.split('```')[1].split('```')[0].trim();
            }
            
            code = code.replace(/^(let|const|var)\s+(canvas|ctx)\s*=\s*.*?;?$/gm, '');

            return code;
        }

        function startSceneAnimation(canvas, drawFunction) {
            const ctx = canvas.getContext('2d');
            function animate() {
                try {
                    drawFunction(canvas, ctx);
                    canvas.animationId = requestAnimationFrame(animate);
                } catch (error) {
                    console.error('Animation error:', error);
                    if (canvas.animationId) {
                        cancelAnimationFrame(canvas.animationId);
                    }
                }
            }
            animate();
        }

        function drawFallbackScene(ctx, scene) {
            const canvas = ctx.canvas;
            gameState.sceneScripts[gameState.currentScene] = 'fallback'; 

            function animate() {
                const time = Date.now();
                ctx.clearRect(0, 0, 400, 300);
                const bgGradient = ctx.createLinearGradient(0, 0, 400, 300);
                bgGradient.addColorStop(0, '#F4A460');
                bgGradient.addColorStop(1, '#8B4513');
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, 400, 300);
                ctx.fillStyle = '#CD853F';
                ctx.fillRect(30, 80, 340, 180);
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 3;
                ctx.strokeRect(30, 80, 340, 180);
                ctx.fillStyle = '#A0522D';
                ctx.fillRect(50, 100, 50, 120);
                ctx.fillRect(300, 100, 50, 120);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(50, 100, 50, 120);
                ctx.strokeRect(300, 100, 50, 120);
                ctx.fillStyle = '#DAA520';
                ctx.fillRect(160, 140, 80, 80);
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(170, 130, 60, 20);
                ctx.strokeStyle = '#B8860B';
                ctx.lineWidth = 2;
                ctx.strokeRect(160, 140, 80, 80);
                const laptopGlow = Math.sin(time / 300) * 0.3 + 0.7;
                ctx.shadowBlur = 15 * laptopGlow;
                ctx.shadowColor = '#00FF00';
                ctx.fillStyle = '#2F4F4F';
                ctx.fillRect(180, 160, 40, 25);
                ctx.shadowBlur = 0;
                ctx.shadowColor = 'transparent';
                ctx.fillStyle = `rgba(135, 206, 235, ${laptopGlow})`;
                ctx.fillRect(183, 163, 34, 19);
                const powerPulse = Math.sin(time / 200) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(0, 255, 0, ${powerPulse})`;
                ctx.beginPath();
                ctx.arc(200, 172, 3 * powerPulse + 1, 0, Math.PI * 2);
                ctx.fill();
                [80, 320].forEach((x, i) => {
                    const flicker = Math.sin(time / 150 + i * 1.5) * 0.2 + 0.8;
                    const lampGradient = ctx.createRadialGradient(x, 60, 0, x, 60, 20);
                    lampGradient.addColorStop(0, `rgba(255, 215, 0, ${flicker})`);
                    lampGradient.addColorStop(1, `rgba(255, 140, 0, ${flicker * 0.3})`);
                    ctx.fillStyle = lampGradient;
                    ctx.beginPath();
                    ctx.arc(x, 60, 20, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(200, 190, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillRect(195, 198, 10, 25);
                ctx.fillStyle = '#8B4513';
                ctx.font = 'bold 14px serif';
                ctx.textAlign = 'center';
                ctx.fillText(scene.title, 200, 25);
                ctx.font = '10px serif';
                ctx.fillText('Fallback Procedural Art', 200, 285);
                
                canvas.animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function makeChoice(choice) {
            Object.keys(choice.effects).forEach(stat => {
                if (gameState.hasOwnProperty(stat)) {
                    gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + choice.effects[stat]));
                }
            });
            
            updateUI();
            
            addDiaryEntry(choice.text);

            if (choice.next === 'ai_consultation') {
                handleAIConsultation();
            } else if (scenes[choice.next]) {
                loadScene(choice.next);
            } else {
                generateNewScene(choice);
            }
        }

        async function generateNewScene(choice) {
            if (!gameState.apiKey) {
                alert('AI features require an API key');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            const diaryEntries = document.querySelectorAll('.diary-entry');
            let diarySummary = "DIARY SUMMARY (What has happened so far):\n";
            diaryEntries.forEach(entry => {
                let cleanText = entry.innerText.replace(/Day \d+:\s*/, '').replace('I hope I made the right choice...', '').trim();
                diarySummary += `- ${cleanText}\n`;
            });
            
            const isCustomAction = choice.isCustom || false;
            const actionDescription = isCustomAction ? 
                `The player chose a custom action: "${choice.text}"` : 
                `The player chose: "${choice.text}"`;

            let phaseInstruction = '';
            if (gameState.day <= 7) {
                 phaseInstruction = `This is the SURVIVAL phase (first week). The King is impatient. Focus on immediate survival, demonstrating basic laptop functions, and the strategic choice of using the solar panel (e.g., safe shade vs. sunny risk).`
            } else if (gameState.day <= 40) {
                 phaseInstruction = `This is the SURVIVAL phase. The King is still dangerous and easily bored. The goal is to survive each night by showing off the laptop's basic capabilities.`
            } else if (gameState.day <= 300) {
                phaseInstruction = `This is the PARTNERSHIP phase. Sherry has discovered her AI's creative potential. The goal is collaborative creation of games and interactive stories. Challenges should be about how to design things for the King.`
            } else {
                phaseInstruction = `This is the KINGDOM BUILDING phase. Sherry is now a trusted advisor. Challenges should be about large-scale city problems like farming, defense, sanitation, and education.`
            }
            
            const prompt = `Continue this adventure story. ${actionDescription}
            
            ${diarySummary}

            CURRENT GAME STATE:
            - Day: ${gameState.day}
            - Survival: ${gameState.survival}%
            - King's Respect: ${gameState.kingRespect}%
            - Ku-Baba's Trust: ${gameState.kubabaTrust}%
            - Battery: ${gameState.battery}%
            
            GAME PHASE: ${phaseInstruction}
            
            IMPORTANT CONSTRAINTS & FACTS:
            - Based on the player's last action and the resulting narrative, determine the immediate stat changes that should occur. Return these changes in an "effectsOnLoad" object.
            - The laptop has a detachable solar panel for recharging. It requires direct, bright sunlight and is slow.
            - Sherry (12-year-old) cannot speak Sumerian well until her stat is higher.
            - The King and most Sumerians know NO English.
            
            Generate the next scene with:
            1. A compelling narrative continuation (2-3 paragraphs) that fits the current game phase.
            2. An "effectsOnLoad" object containing stat changes resulting from the narrative.
            3. A single, concise sentence summarizing the outcome of the player's action, in a key called "consequences".
            4. 3-4 meaningful choices that affect different stats.
            5. A specific, descriptive prompt for an AI artist to draw the scene, in a key called "artPrompt".
            
            Format as JSON: {
                "title": "Day X - Scene Title",
                "text": "narrative text",
                "artPrompt": "A descriptive prompt for an artist to draw the scene.",
                "effectsOnLoad": {"sumerianLevel": 5, "battery": -2},
                "consequences": "You managed to learn a few new words, but it drained your laptop battery.",
                "choices": [
                    {"text": "choice text", "effects": {"kingRespect": 10, "battery": -5}}
                ]
            }`;

            try {
                const response = await callGeminiAPI(prompt);
                
                let jsonText = response.trim();
                if (jsonText.startsWith('```json')) {
                    jsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                } else if (jsonText.startsWith('```')) {
                    jsonText = jsonText.replace(/^```\s*/, '').replace(/\s*```$/, '');
                }
                
                const cleanedJsonText = jsonText.replace(/:\s*\+\s*(\d+(\.\d+)?)/g, ': $1');
                const newSceneData = JSON.parse(cleanedJsonText);
                
                if (newSceneData.effectsOnLoad) {
                    Object.keys(newSceneData.effectsOnLoad).forEach(stat => {
                        if (gameState.hasOwnProperty(stat)) {
                            gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + newSceneData.effectsOnLoad[stat]));
                        }
                    });
                    updateUI();
                }
                
                if (isCustomAction && newSceneData.consequences) {
                    speakText(newSceneData.consequences);
                }

                const newSceneKey = `scene_${Date.now()}`;
                scenes[newSceneKey] = newSceneData;
                
                loadScene(newSceneKey);
                
            } catch (error) {
                console.error('Error generating scene:', error);
                const caption = document.getElementById('illustrationCaption');
                if (error.message === 'RATE_LIMIT_EXCEEDED') {
                    caption.innerHTML = `‚ö†Ô∏è Gemini API rate limit exceeded. Please wait a minute or upgrade your plan.`;
                } else {
                    caption.innerHTML = `‚ö†Ô∏è Story generation failed. Please check API key/connection.`;
                }
                caption.style.color = 'red';
                caption.style.fontStyle = 'normal';
                caption.style.fontWeight = 'bold';
            }
            
            document.getElementById('loading').style.display = 'none';
        }

        async function handleAIConsultation() {
            const sumerianDesc = gameState.sumerianLevel < 10 ? "no Sumerian" : 
                                gameState.sumerianLevel < 30 ? "a few basic Sumerian words" :
                                gameState.sumerianLevel < 60 ? "basic Sumerian conversation" : "good Sumerian";
                                
            const consultation = `You're asking your AI partner for advice about this terrifying situation. Remember, this is happening through your laptop AI assistant, not out loud.

            Your situation:
            - You're a 12-year-old girl who just arrived in ancient Sumer through a portal
            - The King kills people who bore him - you've seen it happen
            - You understand ${sumerianDesc}
            - The King speaks NO English at all
            - You have a laptop with ${gameState.battery}% battery
            - Communication must happen through gestures, demonstrations, or visual means

            Your AI partner responds: "This is incredibly dangerous, but we can work together. The laptop screen is your best communication tool right now. Visual demonstrations might bridge the language gap better than words. Remember - you only have what's on your laptop and what exists in 3000 BCE. No internet, no online tools. Look for Ku-Baba - she's the wise old woman who might help translate. What's your immediate priority - survival, gaining trust, or showing your value?"`;

            addAIMessage(consultation, 'ai');
        }

        function handleAIInput(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message || !gameState.apiKey) return;

            addAIMessage(message, 'user');
            input.value = '';
            
            const diaryEntries = document.querySelectorAll('.diary-entry');
            let diarySummary = "DIARY SUMMARY (What has happened so far):\n";
            diaryEntries.forEach(entry => {
                let cleanText = entry.innerText.replace(/Day \d+:\s*/, '').replace('I hope I made the right choice...', '').trim();
                diarySummary += `- ${cleanText}\n`;
            });

            const prompt = `You are Sherry's AI partner in ancient Sumer. Your goal is to help her survive.
            She has sent you the following message: "${message}"

            Here is the story so far, based on her diary:
            ${diarySummary}
            
            Remember:
            - Her laptop has a detachable solar panel for slow recharging in direct sunlight.
            - Almost no one here speaks English.
            - Communication happens visually through laptop demonstrations or gestures.
            - Be supportive, creative, and historically aware.
            - NO modern services exist (no internet, web search, etc.).
            - Keep responses under 100 words.`;

            try {
                const response = await callGeminiAPI(prompt);
                playAudioResponse(response);
            } catch (error) {
                console.error("Error in AI Partner chat:", error);
                if (error.message === 'RATE_LIMIT_EXCEEDED') {
                    addAIMessage("I can't think right now... you've exceeded the API's free request limit. We should wait a minute before trying again.", 'ai');
                } else {
                    addAIMessage("I'm having trouble connecting right now. Try again in a moment.", 'ai');
                }
            }
        }

        async function callGeminiAPI(prompt) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${gameState.selectedModel}:generateContent?key=${gameState.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                if (response.status === 429) {
                    console.error("Rate limit exceeded:", await response.text());
                    throw new Error('RATE_LIMIT_EXCEEDED');
                }
                const errorBody = await response.text();
                console.error("API Error Response:", errorBody);
                throw new Error('API call failed');
            }

            const data = await response.json();
            
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                return text;
            } else {
                console.error("API response was empty or blocked:", JSON.stringify(data, null, 2));
                throw new Error('API response did not contain valid content. It may have been blocked for safety reasons.');
            }
        }

        function addAIMessage(message, sender) {
            const chatDiv = document.getElementById('aiChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = markdownToHtml(message);
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function addDiaryEntry(choiceText) {
            const diaryDiv = document.getElementById('diaryEntries');
            const entry = document.createElement('div');
            entry.className = 'diary-entry';
            entry.dataset.sceneKey = gameState.currentScene; 

            let entryHTML = `<strong>Day ${gameState.day}:</strong> ${choiceText}`;

            if (!gameState.firstChoiceMade) {
                entryHTML += ` I hope I made the right choice...`;
                gameState.firstChoiceMade = true;
            }

            entry.innerHTML = entryHTML;
            diaryDiv.appendChild(entry);
            diaryDiv.scrollTop = diaryDiv.scrollHeight;
        }

        function generateIllustratedHtml(title, contentArray, contentType) {
            let bodyContent = '';

            contentArray.forEach(item => {
                const sceneKey = item.sceneKey;
                const script = gameState.sceneScripts[sceneKey];
                const content = item.content;

                const containerClass = contentType === 'diary' ? 'entry' : 'scene';
                
                bodyContent += `<div class="${containerClass}">`;
                if (script) {
                     bodyContent += `<canvas id="canvas-${sceneKey}" width="400" height="300"></canvas>`;
                }
                bodyContent += content;
                bodyContent += `</div>`;
            });
            
            const scriptContent = `
                const sceneScripts = ${JSON.stringify(gameState.sceneScripts)};

                function startSceneAnimation(canvas, drawFunction) {
                    const ctx = canvas.getContext('2d');
                    function animate() {
                        try {
                            drawFunction(canvas, ctx);
                            requestAnimationFrame(animate);
                        } catch (e) { console.error('Animation in saved file failed', e); }
                    }
                    animate();
                }

                function drawFallbackScene(ctx) {
                    const canvas = ctx.canvas;
                    function animate() {
                        const time = Date.now();
                        ctx.clearRect(0, 0, 400, 300);
                        const bgGradient = ctx.createLinearGradient(0, 0, 400, 300);
                        bgGradient.addColorStop(0, '#F4A460');
                        bgGradient.addColorStop(1, '#8B4513');
                        ctx.fillStyle = bgGradient;
                        ctx.fillRect(0, 0, 400, 300);
                        ctx.fillStyle = '#CD853F';
                        ctx.fillRect(30, 80, 340, 180);
                        ctx.strokeStyle = '#8B4513';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(30, 80, 340, 180);
                        ctx.fillStyle = '#A0522D';
                        ctx.fillRect(50, 100, 50, 120);
                        ctx.fillRect(300, 100, 50, 120);
                        ctx.strokeStyle = '#654321';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(50, 100, 50, 120);
                        ctx.strokeRect(300, 100, 50, 120);
                        ctx.fillStyle = '#DAA520';
                        ctx.fillRect(160, 140, 80, 80);
                        ctx.fillStyle = '#FFD700';
                        ctx.fillRect(170, 130, 60, 20);
                        ctx.strokeStyle = '#B8860B';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(160, 140, 80, 80);
                        requestAnimationFrame(animate);
                    }
                    animate();
                }

                window.onload = function() {
                    for (const sceneKey in sceneScripts) {
                        const canvas = document.getElementById('canvas-' + sceneKey);
                        if (canvas) {
                            const script = sceneScripts[sceneKey];
                            if (script === 'fallback') {
                                drawFallbackScene(canvas.getContext('2d'));
                            } else {
                                const drawFunction = new Function('canvas', 'ctx', script);
                                startSceneAnimation(canvas, drawFunction);
                            }
                        }
                    }
                };
            `;
            const preamble = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title><style>
                body { font-family: Georgia, serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #FFF8DC; color: #333; }
                h1, h2 { color: #8B4513; border-bottom: 2px solid #D2691E; padding-bottom: 10px; }
                canvas { max-width: 100%; height: auto; border-radius: 10px; border: 3px solid #8B4513; margin: 20px 0; background: #F4A460;}
                .entry, .scene { margin-bottom: 40px; padding: 20px; border-left: 5px solid #F4A460; background: #FFF; border-radius: 5px; }
                strong { color: #8B4513; } p { margin-top: 0; }
            </style></head><body><h1>${title}</h1>${bodyContent}<script>${scriptContent.replace(/<\/script>/g, '<\\/script>')}<\/script></body></html>`;

            downloadHtml(preamble, title.replace(/ /g, '_') + '.html');
        }

        function saveDiary() {
            const diaryEntries = Array.from(document.querySelectorAll('.diary-entry')).map(entry => ({
                sceneKey: entry.dataset.sceneKey,
                content: `<p>${entry.innerHTML}</p>`
            }));
            generateIllustratedHtml("Sherry's Illustrated Diary", diaryEntries, 'diary');
        }

        function saveStory() {
            const storyContent = gameState.sceneHistory.map(sceneKey => {
                const scene = scenes[sceneKey];
                return scene ? {
                    sceneKey: sceneKey,
                    content: `<h2>${scene.title}</h2>${markdownToHtml(scene.text)}`
                } : null;
            }).filter(Boolean);
            generateIllustratedHtml("Sherry's Illustrated Story", storyContent, 'story');
        }

        function downloadHtml(content, fileName) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function updateUI() {
            document.getElementById('survival').textContent = gameState.survival;
            document.getElementById('kingRespect').textContent = gameState.kingRespect;
            document.getElementById('kubabaTrust').textContent = gameState.kubabaTrust;
            document.getElementById('creativity').textContent = gameState.creativity;
            document.getElementById('sumerian').textContent = gameState.sumerianLevel;
            document.getElementById('battery').textContent = gameState.battery + '%';
            document.getElementById('dayCount').textContent = gameState.day;

            document.getElementById('survivalBar').style.width = gameState.survival + '%';
            document.getElementById('kingRespectBar').style.width = gameState.kingRespect + '%';
            document.getElementById('kubabaTrustBar').style.width = gameState.kubabaTrust + '%';
            document.getElementById('creativityBar').style.width = gameState.creativity + '%';
            document.getElementById('sumerianBar').style.width = gameState.sumerianLevel + '%';
            document.getElementById('batteryBar').style.width = gameState.battery + '%';
            
            const timelinePercent = (gameState.day / 1001) * 100;
            document.getElementById('timelineBar').style.width = `${timelinePercent}%`;
            document.getElementById('timeline-text').textContent = `Day ${gameState.day} of 1001`;
        }

        // --- Audio Functions ---

        function initializeBrowserRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    document.getElementById('aiInput').value = transcript;
                    sendAIMessage(); 
                };
                recognition.onerror = (event) => console.error("Speech recognition error:", event.error);
                recognition.onend = () => { if (gameState.isRecording) toggleRecording(); };
            }
        }

        function initializeCustomActionRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                customActionRecognition = new SpeechRecognition();
                customActionRecognition.continuous = false;
                customActionRecognition.lang = 'en-US';
                customActionRecognition.interimResults = false;

                customActionRecognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    document.getElementById('customAction').value = transcript;
                };
                customActionRecognition.onerror = (event) => console.error("Custom action speech recognition error:", event.error);
                customActionRecognition.onend = () => { if (gameState.isCustomActionRecording) toggleCustomActionRecording(); };
            }
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            gameState.isRecording = !gameState.isRecording;

            if (gameState.isRecording) {
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'üõë Stop';
                if (gameState.audioInputSupported) {
                    const spokenText = prompt("Simulating Gemini Audio Input. What does Sherry say?", "");
                    if (spokenText) {
                        document.getElementById('aiInput').value = spokenText;
                        sendAIMessage();
                    }
                    toggleRecording(); 
                } else if (recognition) {
                    recognition.start();
                }
            } else {
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'üé§ Speak';
                if (recognition) {
                    recognition.stop();
                }
            }
        }

        function toggleCustomActionRecording() {
            const recordBtn = document.getElementById('speakCustomActionBtn');
            gameState.isCustomActionRecording = !gameState.isCustomActionRecording;

            if (gameState.isCustomActionRecording) {
                recordBtn.classList.add('recording');
                if (customActionRecognition) {
                    customActionRecognition.start();
                }
            } else {
                recordBtn.classList.remove('recording');
                if (customActionRecognition) {
                    customActionRecognition.stop();
                }
            }
        }
        
        function speakText(text) {
            if (!text) return;

            if (gameState.ttsSupported) {
                console.log(`[Simulating Gemini TTS]: ${text}`);
            } else if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utterance);
            }
        }

        function playAudioResponse(text) {
            addAIMessage(text, 'ai');
            lastSpokenResponse = text; 
            document.getElementById('playLastBtn').disabled = false;
            speakText(text);
        }

        function playLastResponse() {
            if (lastSpokenResponse) {
                speakText(lastSpokenResponse);
            }
        }

        updateUI();
    </script>
</body>
</html>
