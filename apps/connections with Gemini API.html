<!DOCTYPE html>
<html>
<head>
    <title>Star Visualization of Embeddings with Gemini API</title>
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f5f5f5;
        font-family: Arial, sans-serif;
    }

    .input-group {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    canvas {
        border: 1px solid #ddd;
        margin-top: 20px;
    }

    .button {
        padding: 10px 15px;
        margin: 5px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .button:hover {
        background-color: #45a049;
    }

    .button:disabled {
        background-color: #cccccc;
        cursor: default;
    }

    input[type="text"], input[type="password"] {
        padding: 10px;
        margin: 5px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 300px;
    }
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 5px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

</style>

</head>
<body>
    <div class="input-group" id="visualizeTextInterface">
        <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key">
        <input type="text" id="wordInput" placeholder="Enter a word or sentence">
        <button id="visualizeButton" class="button">Visualize Embedding</button>
    </div>
    <button id="howToUseButton" class="button">How to Use</button>
    <div id="howToUseModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p id="howToUseText"></p>
        </div>
    </div>

    <canvas id="myCanvas" width="800" height="600"></canvas>
</body>

<script>
const canvasWidth = 800;
const initialX = canvasWidth / 6;
const initialY = 150;
let currentX = initialX;
let currentY = initialY;
const spacingX = 300;
const spacingY = 300;
const maxLineLength = 100;

async function getGeminiEmbedding(text, apiKey) {
    const model = 'text-embedding-004';
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:embedContent?key=${apiKey}`;

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            model: `models/${model}`,
            content: {
                parts: [{
                    text: text,
                }],
            },
        }),
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error.message);
    }

    const data = await response.json();
    return data.embedding.values;
}


function createStarVisualization(embedding, word) {
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const requiredSpace = maxLineLength * 2 + 20;

    if (currentX + requiredSpace > canvas.width) {
        currentX = initialX;
        currentY += spacingY;
    }

    const maxAbsValue = Math.max(...embedding.map(Math.abs));
    const scale = maxAbsValue > 0 ? (maxLineLength / maxAbsValue) : 1;
    const starWidth = maxAbsValue * scale * 2;
    const maxWidth = starWidth * 0.5;

    embedding.forEach((value, index) => {
        const angle = (2 * Math.PI / embedding.length) * index;
        const length = Math.abs(value) * scale;
        const endX = currentX + length * Math.cos(angle);
        const endY = currentY - length * Math.sin(angle);

        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
        ctx.lineTo(endX, endY);
        ctx.strokeStyle = value >= 0 ? 'orange' : 'blue';
        ctx.stroke();
    });

    const textLines = splitText(ctx, word, maxWidth);
    ctx.fillStyle = 'black';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    textLines.forEach((line, index) => {
        ctx.fillText(line, currentX, currentY + requiredSpace / 2 + (index * 20));
    });

    currentX += requiredSpace;
}

function clearCanvasAndReset() {
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    currentX = initialX;
    currentY = initialY;
}

function splitText(ctx, text, maxWidth) {
    const words = text.split(' ');
    let lines = [];
    let currentLine = words[0];

    for (let i = 1; i < words.length; i++) {
        const testLine = currentLine + ' ' + words[i];
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && i > 0) {
            lines.push(currentLine);
            currentLine = words[i];
        } else {
            currentLine = testLine;
        }
    }
    lines.push(currentLine);
    return lines;
}

async function performEmbeddingArithmetic(input, apiKey) {
    const visualizeButton = document.getElementById('visualizeButton');
    visualizeButton.disabled = true;
    visualizeButton.textContent = 'Loading...';

    try {
        if (!input.includes('+') && !input.includes('-')) {
            const embedding = await getGeminiEmbedding(input, apiKey);
            createStarVisualization(embedding, input);
            return;
        }

        const phraseRegex = /"([^"]+)"|(\b\w+\b)/g;
        const operationRegex = /[+-]/g;
        let phrases = [...input.matchAll(phraseRegex)].map(match => match[1] || match[2]);
        let operations = [...input.matchAll(operationRegex)].map(match => match[0]);

        const embeddings = await Promise.all(
            phrases.map(phrase => getGeminiEmbedding(phrase, apiKey))
        );

        let resultEmbedding = embeddings[0];
        for (let i = 0; i < operations.length; i++) {
            let nextEmbedding = embeddings[i + 1];
            resultEmbedding = resultEmbedding.map((val, index) =>
                operations[i] === '+' ? val + nextEmbedding[index] : val - nextEmbedding[index]
            );
        }

        createStarVisualization(resultEmbedding, input);
    } catch (error) {
        const modal = document.getElementById('howToUseModal');
        const modalText = document.getElementById('howToUseText');
        modalText.innerText = `An error occurred: ${error.message}`;
        modal.style.display = "block";
    } finally {
        visualizeButton.disabled = false;
        visualizeButton.textContent = 'Visualize Embedding';
    }
}

document.getElementById('visualizeButton').addEventListener('click', () => {
    const inputExpression = document.getElementById('wordInput').value;
    const apiKey = document.getElementById('apiKeyInput').value;

    if (!apiKey) {
        const modal = document.getElementById('howToUseModal');
        const modalText = document.getElementById('howToUseText');
        modalText.innerText = `Please enter your Gemini API Key. You can get one from Google AI Studio.`;
        modal.style.display = "block";
        return;
    }
    if (!inputExpression) {
        return;
    }
    performEmbeddingArithmetic(inputExpression, apiKey);
});


document.getElementById('howToUseButton').addEventListener('click', function() {
    const modal = document.getElementById('howToUseModal');
    const modalText = document.getElementById('howToUseText');
    let instructions = "How to Use:\n\n";
    instructions += "- Get your Gemini API Key from Google AI Studio.\n";
    instructions += "- Paste your API key into the input field.\n";
    instructions += "- Enter a word or phrase and click 'Visualize Embedding' to see its representation.\n";
    instructions += "- Perform arithmetic on phrases or words, e.g., 'king' - 'man' + 'woman'.\n";
    instructions += "- Use quotes for multi-word phrases, e.g., \"computer programmer\" - \"hacker\".\n";


    modalText.innerText = instructions;
    modal.style.display = "block";
});

document.getElementsByClassName("close")[0].onclick = function() {
    document.getElementById('howToUseModal').style.display = "none";
}

window.onclick = function(event) {
    const modal = document.getElementById('howToUseModal');
    if (event.target === modal) {
        modal.style.display = "none";
    }
}

</script>
</body>
</html>

