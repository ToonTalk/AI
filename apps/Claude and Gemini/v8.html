<!DOCTYPE html>
<html>
<head>
  <title>Sisi & Ada's Dream Weaver v8 (Live API Ready)</title>
  <style>
    /* All styles from v7 are here */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a1a; color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px 0; }
    .container { max-width: 600px; width: 95%; text-align: center; background-color: #2a2a2a; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #memoryTrailContainer { height: 60px; width: 100%; background-color: #333; border-radius: 8px; margin-bottom: 20px; }
    #artwork { width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; border: 2px solid #444; min-height: 300px; background-color: #333; }
    #story { text-align: left; line-height: 1.6; margin-bottom: 20px; padding: 15px; background-color: #333; border-radius: 8px; max-height: 200px; overflow-y: auto;}
    #choicesContainer { display: flex; justify-content: space-around; align-items: center; min-height: 120px; padding: 10px; flex-wrap: wrap; }
    .choice-orb { flex-shrink: 0; margin: 5px; width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle, #5c4a93, #3a2e5c); display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid #7e57c2; box-shadow: 0 0 15px rgba(126, 87, 194, 0.5); }
    .choice-orb:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(157, 121, 217, 0.8); }
    .choice-orb span { font-size: 0.8em; color: white; padding: 5px; }
  </style>
</head>
<body>

  <div id="mainApp" class="container">
    <div id="memoryTrailContainer"><svg id="memoryTrail" width="100%" height="100%"></svg></div>
    <img id="artwork" src="https://storage.googleapis.com/gemini-prod/images/prototype_start.png" alt="The dream begins...">
    <div id="story"></div>
    <div id="choicesContainer"><p>Weaving the dream...</p></div>
  </div>

  <script>
    let storyState;

    async function startGame() {
      storyState = { /* ... initial state object ... */ };
      // The first scene can be hardcoded or generated
      const initialScene = {
        narrative: "You enter a pawn shop that doesn’t buy goods, it buys memories. The shopkeeper offers you a choice: trade a memory of first love for a key, or trade a nightmare for a compass that points to what you’ve lost.",
        artUrl: "https://storage.googleapis.com/gemini-prod/images/prototype_start.png",
        choices: [ { text: "Trade the nightmare for the compass.", effects: { worldFlags: {"nightmare_traded": true} } } ]
      };
      storyState.history = ["scene_1_seed"];
      updatePage(initialScene);
    }

    async function handleChoice(choice) {
      document.getElementById('choicesContainer').innerHTML = '<p>Weaving the dream...</p>';
      
      // 1. Apply effects of the choice to the state
      Object.assign(storyState.worldFlags, choice.effects.worldFlags || {});
      // ... more state updates from design doc ...
      
      // 2. Build the Master Prompt using Sisi & Claude's template
      const masterPrompt = `
        You are a collaborative storyteller for Dream Weaver, a surreal interactive narrative.
        Your tone is poetic, mysterious, and slightly melancholic.

        This is the player's current state:
        ${JSON.stringify(storyState, null, 2)}

        The player just made this choice: "${choice.text}"

        Your task is to generate the next scene. Respond ONLY with a valid JSON object with these keys:
        - "narrative": A 2-3 sentence continuation of the story.
        - "artPrompt": A detailed prompt for an image generator in a "Surrealist Oil Painting" style, reflecting the new narrative.
        - "choices": An array of 2-3 new choices, each an object with "text" and "effects" keys.
        - "updatedFlags": A JSON object of any worldFlags that should be added or changed.
      `;

      // 3. --- THIS IS THE LIVE GEMINI API CALL ---
      // const model = gemini.getGenerativeModel({ model: 'gemini-pro' });
      // const result = await model.generateContent(masterPrompt);
      // const responseJson = JSON.parse(result.response.text());
      // const newSceneData = responseJson;
      
      // For now, using a mock response until the prompt is finalized
      const mockResponse = {
        narrative: "The old woman smiles. She plucks the nightmare from your mind, and a brass compass materializes in your hand, its needle spinning wildly.",
        artPrompt: "A brass compass held in a hand, needle glowing, with a wise old woman's face fading into the background of a dusty shop. Surrealist Oil Painting.",
        choices: [
          { text: "Follow the compass.", effects: { worldFlags: { compassFollowed: true }}},
          { text: "Ask what you've lost.", effects: { worldFlags: { askedAboutLoss: true }}}
        ],
        updatedFlags: { nightmare_traded: true }
      };
      
      // 4. --- THIS WOULD BE THE LIVE IMAGE GENERATION CALL ---
      // const imageResult = await gemini.generateImage({ prompt: newSceneData.artPrompt });
      // newSceneData.artUrl = imageResult.url; // or however the API returns it
      mockResponse.artUrl = "https://storage.googleapis.com/gemini-prod/images/surreal_compass.png";

      // 5. Update the page
      updatePage(mockResponse);
    }
    
    function updatePage(sceneData) {
      document.getElementById('artwork').src = sceneData.artUrl;
      document.getElementById('story').innerHTML += `<p>${sceneData.narrative}</p>`;
      
      const choicesDiv = document.getElementById('choicesContainer');
      choicesDiv.innerHTML = '';
      sceneData.choices.forEach(choice => {
        const orb = document.createElement('div');
        orb.className = 'choice-orb';
        orb.onclick = () => handleChoice(choice);
        orb.innerHTML = `<span>${choice.text}</span>`;
        choicesDiv.appendChild(orb);
      });
      // renderMemoryTrail(); // Not shown for brevity
    }

    startGame();
  </script>

</body>
</html>