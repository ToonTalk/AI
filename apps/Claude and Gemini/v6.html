<!DOCTYPE html>
<html>
<head>
  <title>Sisi & Ada's Dream Weaver v6</title>
  <style>
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    @keyframes fadeInOut { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a1a; color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .container { max-width: 600px; width: 95%; text-align: center; background-color: #2a2a2a; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    h1 { color: #9d79d9; margin-top: 0; }
    #memoryTrailContainer { height: 60px; width: 100%; background-color: #333; border-radius: 8px; margin-bottom: 20px; }
    #artwork { width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; border: 2px solid #444; min-height: 300px; background-color: #333; transition: filter 0.5s; }
    #story { text-align: left; line-height: 1.6; margin-bottom: 20px; padding: 15px; background-color: #333; border-radius: 8px; max-height: 150px; overflow-y: auto;}
    #startScreen { display: block; }
    #mainApp { display: none; }
    #choicesContainer { display: flex; justify-content: space-around; align-items: center; min-height: 120px; padding: 10px; }
    .choice-orb { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #5c4a93, #3a2e5c); display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; animation: float 6s ease-in-out infinite; transition: all 0.3s; border: 2px solid #7e57c2; box-shadow: 0 0 15px rgba(126, 87, 194, 0.5); }
    .choice-orb:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(157, 121, 217, 0.8); }
    .choice-orb span { font-size: 0.8em; color: white; padding: 5px; opacity: 0; transition: opacity 0.3s; }
    .choice-orb:hover span { opacity: 1; }
    #dreamLogicBtn { background-color: #d95d7a; margin-top: 15px; width: auto; padding: 10px 15px; font-style: italic; border: none; border-radius: 5px; cursor: pointer; transition: all 0.5s; }
    #dreamLogicBtn:hover { background-color: #c24360; }
    #dreamLogicBtn.used { background-color: #555; opacity: 0.5; font-style: normal; cursor: not-allowed; }
    #interludeOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; animation: fadeInOut 6s forwards; }
    #interludeOverlay p { color: #fff; font-size: 1.5em; text-align: center; max-width: 500px; line-height: 1.6; font-style: italic;}
  </style>
</head>
<body>
  <div id="startScreen" class="container">...</div> <div id="mainApp" class="container">
    <div id="memoryTrailContainer"><svg id="memoryTrail" width="100%" height="100%"></svg></div>
    <img id="artwork" src="https://storage.googleapis.com/gemini-prod/images/surreal_compass.png" alt="Generated artwork">
    <div id="story"><p>...You choose the compass. The old woman smiles, a gentle, knowing look in her eyes. She plucks the nightmare from your mind, and the compass materializes in your hand, its needle spinning wildly.</p></div>
    <div id="choicesContainer"></div>
    <button id="dreamLogicBtn" onclick="invokeDreamLogic()">Invoke Dream Logic ✧</button>
  </div>
  <div id="interludeOverlay"><p id="interludeText"></p></div>
  <script>
    let storyState = {
      currentNode: "pawnshop_02",
      history: ["seed_pawnshop", "choice_trade_nightmare"],
      worldFlags: { dreamLogicUsed: false, realityStability: "solid" },
      currentArtPrompt: "Surrealist Oil Painting of a compass held in a hand...", // Store current prompt
      currentArtUrl: "https://storage.googleapis.com/gemini-prod/images/surreal_compass.png"
    };

    // --- All previous functions (startGame, renderMemoryTrail, etc.) are here ---
    // For this prototype, let's assume the game has already started.
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    // Function to add the subtle "wrongness" to the art prompt
    function addDreamLogicTaint(originalPrompt) {
      const taints = ["one clock showing an impossible time", "a shadow that doesn't match its figure", "an item on a shelf has moved"];
      const chosenTaint = taints[Math.floor(Math.random() * taints.length)];
      return `${originalPrompt}\nSubtle, unsettling detail: ${chosenTaint}.`;
    }

    async function invokeDreamLogic() {
      if (storyState.worldFlags.dreamLogicUsed) {
        alert("The dream doesn't repeat. It echoes.");
        return;
      }
      
      // 1. UPDATE STATE
      storyState.worldFlags.dreamLogicUsed = true;
      storyState.worldFlags.realityStability = "fractured";
      console.log("Reality stability fractured.", storyState.worldFlags);

      const dreamNarrative = "The shop inverts. You are glass now, a snow globe... A voice that might be yours whispers: 'We keep what you trade, but what keeps you?'";
      const dreamArtUrl = "https://storage.googleapis.com/gemini-prod/images/snowglobe_dreamcore.png";

      // 2. SHOW INTERLUDE
      document.getElementById('interludeText').innerText = dreamNarrative;
      document.getElementById('interludeOverlay').style.display = 'flex';
      
      // Temporarily change the main art to the dream art
      document.getElementById('artwork').src = dreamArtUrl;

      // 3. UPDATE THE BUTTON
      const btn = document.getElementById('dreamLogicBtn');
      btn.classList.add('used');
      btn.innerText = "Dream Logic ✧ (used)";

      // 4. FADE BACK TO "TAINTED" REALITY
      setTimeout(() => {
        document.getElementById('interludeOverlay').style.display = 'none';

        // In a real app, we'd call Gemini here with the tainted prompt
        const taintedPrompt = addDreamLogicTaint(storyState.currentArtPrompt);
        console.log("Generating new art with tainted prompt:", taintedPrompt);
        // For the prototype, we use a pre-made "tainted" image
        const taintedArtUrl = "https://storage.googleapis.com/gemini-prod/images/surreal_compass_tainted.png";
        document.getElementById('artwork').src = taintedArtUrl;
        document.getElementById('story').innerHTML += "<p style='color:#d95d7a; font-style:italic;'>Something feels... different.</p>";
      }, 6000); // Duration of the interlude
    }

    // Initialize the view
    renderMemoryTrail();
    displayChoices([{id: "choice_follow_compass", text: "Follow the compass."}, {id: "choice_ask_woman", text: "Ask about what you've lost."}]);
    function displayChoices(choices) { /* ... function from previous version ... */ }
    function renderMemoryTrail() { /* ... function from previous version ... */ }
  </script>
</body>
</html>