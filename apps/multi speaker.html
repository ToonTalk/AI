<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Speaker Text-to-Speech Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .file-input {
            margin: 10px 0;
        }
        .url-load-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .url-load-group input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 400px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .controls-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .primary-btn {
            background-color: #007bff;
            color: white;
        }
        .primary-btn:hover {
            background-color: #0056b3;
        }
        .primary-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
        .secondary-btn:hover {
            background-color: #545b62;
        }
        .speaker-selection {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            display: none;
        }
        .speaker-checkbox-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        .select-all-controls {
            margin: 10px 0;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
        .select-all-controls button {
            margin-right: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }
        .speaker-config {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .speaker-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        .speaker-name {
            min-width: 150px;
            font-weight: bold;
        }
        select, input[type="range"] {
            margin: 0 5px;
        }
        .range-label {
            font-size: 12px;
            margin: 0 5px;
        }
        .script-preview {
            display: none; 
        }
        .current-line {
            background-color: #554a2b;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
        }
        .url-modal {
            display: none;
            position: fixed;
            z-index: 2100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .url-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }
        .url-textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .modal-buttons {
            text-align: right;
            margin-top: 15px;
        }
        .modal-buttons button {
            margin-left: 10px;
        }
        
        /* Playback View Styles */
        #playbackView {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.95);
            color: #f1f1f1;
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .playback-controls {
            width: 100%;
            max-width: 90vw;
            text-align: right;
            margin-bottom: 20px;
        }
        .playback-content {
            width: 100%;
            max-width: 90vw;
            height: 85vh;
            background-color: #2b2b2b;
            border-radius: 10px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: row; /* Side-by-side layout */
            gap: 20px;
        }
        #playbackScriptContainer {
            flex: 0 0 40%; /* Starts at 40% width, doesn't grow, can shrink */
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
            font-size: 1.1em;
            line-height: 1.6;
            padding-right: 10px;
        }
        #playbackUrlDisplay {
            flex: 1 1 60%; /* Takes remaining space, based at 60% */
            background-color: #000;
            border-radius: 5px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0; 
        }
        #playbackUrlDisplay iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5px;
        }
        #playbackUrlDisplay img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Speaker Text-to-Speech Converter</h1>
        
        <div class="upload-section">
            <h3>Upload Your Script</h3>
            <input type="file" id="scriptFile" class="file-input" accept=".txt" />
            <p style="margin: 20px 0 5px;"><strong>Or</strong> load from a URL (e.g., a raw GitHub Gist):</p>
            <div class="url-load-group">
                <input type="text" id="scriptUrlInput" placeholder="https://example.com/script.txt">
                <button class="secondary-btn" onclick="loadScriptFromURL()">Load Script</button>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <button class="primary-btn" id="playBtn" onclick="startPlayback()" disabled>Start Playback</button>
                <button class="primary-btn" id="shareBtn" onclick="generateShareableURL()" disabled>Generate Shareable URL</button>
                <span id="statusMessage" style="margin-left: 10px; font-style: italic; color: #666;"></span>
            </div>
        </div>

        <div class="speaker-selection" id="speakerSelection">
            <h3>Select Speakers to Include</h3>
            <div class="select-all-controls">
                <button class="secondary-btn" onclick="selectAllSpeakers()">Select All</button>
                <button class="secondary-btn" onclick="deselectAllSpeakers()">Deselect All</button>
            </div>
            <div id="speakerCheckboxList"></div>
            <button class="primary-btn" onclick="updateSpeakerConfig()" style="margin-top: 15px;">Configure Selected Speakers</button>
        </div>

        <div class="speaker-config" id="speakerConfig">
            <h3>Configure Speaker Voices</h3>
            <div id="speakerList"></div>
        </div>

        <div id="urlModal" class="url-modal">
            <div class="url-modal-content">
                <h3>Shareable URL Generated!</h3>
                <p>Copy this URL to share your configured TTS setup:</p>
                <textarea id="shareableURL" readonly class="url-textarea"></textarea>
                <div class="modal-buttons">
                    <button class="secondary-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
                    <button class="primary-btn" onclick="closeURLModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="playbackView">
        <div class="playback-controls">
            <button class="secondary-btn" onclick="stopPlayback()">Exit Playback</button>
        </div>
        <div class="playback-content">
            <div id="playbackScriptContainer"></div>
            <div id="playbackUrlDisplay"></div>
        </div>
    </div>

    <script>
        // Global variables
        let parsedLines = [];
        let allSpeakers = [];
        let selectedSpeakers = [];
        let currentLineIndex = 0;
        let isPlaying = false;
        let availableVoices = [];
        let scriptSourceURL = null;

        // --- Initialization ---

        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length === 0) setTimeout(loadVoices, 100);
        }
        loadVoices();
        speechSynthesis.onvoiceschanged = loadVoices;
        window.addEventListener('load', loadFromURL);

        // --- Event Listeners & Script Loading ---

        document.getElementById('scriptFile').addEventListener('change', function(e) {
            scriptSourceURL = null;
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => parseScript(event.target.result);
                reader.readAsText(file);
            }
        });

        async function loadScriptFromURL() {
            const url = document.getElementById('scriptUrlInput').value.trim();
            if (!url) return alert('Please enter a URL.');
            document.getElementById('statusMessage').textContent = 'Loading script...';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const content = await response.text();
                scriptSourceURL = url;
                parseScript(content);
            } catch (error) {
                console.error('Failed to fetch script:', error);
                alert('Failed to load script from URL. Check console for details.');
                document.getElementById('statusMessage').textContent = 'Failed to load script.';
            }
        }
        
        // --- Core Script Processing ---

        function parseScript(content) {
            const lines = content.split('\n');
            const urlRegex = /(https?:\/\/[^\s]+)$/i;
            parsedLines = [];
            const speakerSet = new Set();

            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const speaker = line.substring(0, colonIndex).trim();
                        let dialogue = line.substring(colonIndex + 1).trim();
                        dialogue = dialogue.replace(/\([^)]*\)/g, '').trim();
                        
                        const urlMatch = dialogue.match(urlRegex);
                        const url = urlMatch ? urlMatch[0] : null;
                        const dialogueText = url ? dialogue.replace(urlRegex, '').trim() : dialogue;

                        if (dialogueText || url) {
                            speakerSet.add(speaker);
                            parsedLines.push({ speaker, dialogue: dialogueText, url });
                        }
                    }
                }
            });

            allSpeakers = Array.from(speakerSet);
            selectedSpeakers = [...allSpeakers];
            displaySpeakerSelection();
        }

        function processScript() {
            if (selectedSpeakers.length === 0) return alert('Please select at least one speaker!');
            const filteredLines = parsedLines.filter(line => selectedSpeakers.includes(line.speaker));
            if (filteredLines.length === 0) return alert('No dialogue found for the selected speakers!');
            
            window.processedLines = filteredLines;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('shareBtn').disabled = false;
            
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = `Script processed! Ready to play ${filteredLines.length} lines.`;
            statusMessage.style.color = 'green';
        }

        // --- UI Display Functions ---

        function displaySpeakerSelection() {
            const selectionDiv = document.getElementById('speakerSelection');
            const checkboxList = document.getElementById('speakerCheckboxList');
            checkboxList.innerHTML = '';
            
            allSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div'); row.className = 'speaker-checkbox-row';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `speaker_checkbox_${index}`; checkbox.value = speaker; checkbox.checked = true;
                const label = document.createElement('label'); label.htmlFor = `speaker_checkbox_${index}`; label.textContent = speaker;
                row.append(checkbox, label);
                checkboxList.appendChild(row);
            });
            
            selectionDiv.style.display = 'block';
            updateSpeakerConfig();
        }

        function updateSpeakerConfig() {
            selectedSpeakers = [];
            allSpeakers.forEach((speaker, index) => {
                const checkbox = document.getElementById(`speaker_checkbox_${index}`);
                if (checkbox?.checked) selectedSpeakers.push(speaker);
            });
            if (selectedSpeakers.length === 0) {
                document.getElementById('speakerConfig').style.display = 'none';
                document.getElementById('playBtn').disabled = true;
                document.getElementById('shareBtn').disabled = true;
                return;
            }
            displaySpeakerConfig();
            processScript();
        }
        
        function displaySpeakerConfig() {
            const configDiv = document.getElementById('speakerConfig');
            const speakerList = document.getElementById('speakerList');
            speakerList.innerHTML = '';
            
            selectedSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div'); row.className = 'speaker-row';
                const nameDiv = document.createElement('div'); nameDiv.className = 'speaker-name'; nameDiv.textContent = speaker + ':';
                const voiceSelect = document.createElement('select'); voiceSelect.id = `voice_${index}`;
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                const pitchLabel = document.createElement('span'); pitchLabel.className = 'range-label'; pitchLabel.textContent = 'Pitch:';
                const pitchRange = document.createElement('input'); pitchRange.type = 'range'; pitchRange.id = `pitch_${index}`; pitchRange.min = '0.5'; pitchRange.max = '2'; pitchRange.step = '0.1'; pitchRange.value = '1';
                const rateLabel = document.createElement('span'); rateLabel.className = 'range-label'; rateLabel.textContent = 'Rate:';
                const rateRange = document.createElement('input'); rateRange.type = 'range'; rateRange.id = `rate_${index}`; rateRange.min = '0.5'; rateRange.max = '2'; rateRange.step = '0.1'; rateRange.value = '1';
                row.append(nameDiv, voiceSelect, pitchLabel, pitchRange, rateLabel, rateRange);
                speakerList.appendChild(row);
                if (availableVoices.length > 0) {
                    voiceSelect.value = availableVoices[index % availableVoices.length]?.name;
                }
            });
            configDiv.style.display = 'block';
        }

        function selectAllSpeakers() {
            document.querySelectorAll('#speakerCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllSpeakers() {
            document.querySelectorAll('#speakerCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // --- Playback Controls ---

        function getSpeakerVoiceSettings(speaker) {
            const speakerIndex = selectedSpeakers.indexOf(speaker);
            if (speakerIndex === -1) return null;
            const voiceName = document.getElementById(`voice_${speakerIndex}`).value;
            const pitch = parseFloat(document.getElementById(`pitch_${speakerIndex}`).value);
            const rate = parseFloat(document.getElementById(`rate_${speakerIndex}`).value);
            return { voice: availableVoices.find(v => v.name === voiceName), pitch, rate };
        }

        function startPlayback() {
            speechSynthesis.cancel();
            const linesToPlay = window.processedLines;
            if (!linesToPlay || linesToPlay.length === 0) return alert('Please upload and process a script first.');
            
            document.querySelector('.container').style.display = 'none';
            document.getElementById('playbackView').style.display = 'flex';
            const scriptContainer = document.getElementById('playbackScriptContainer');
            scriptContainer.innerHTML = linesToPlay.map((line, index) => 
                `<div id="playback_line_${index}"><strong>${line.speaker}:</strong> ${line.dialogue}</div>`
            ).join('');
            
            window.playbackLines = linesToPlay;
            isPlaying = true;
            currentLineIndex = 0;
            playNextLine();
        }

        function playNextLine() {
            if (!isPlaying || currentLineIndex >= window.playbackLines.length) {
                if (currentLineIndex >= window.playbackLines.length) stopPlayback();
                return;
            }
            const currentLine = window.playbackLines[currentLineIndex];
            const voiceSettings = getSpeakerVoiceSettings(currentLine.speaker);
            const scriptContainer = document.getElementById('playbackScriptContainer');
            const urlDisplay = document.getElementById('playbackUrlDisplay');
            const isImageUrlRegex = /\.(jpg|jpeg|png|gif|webp|svg)$/i;

            if (currentLine.url) {
                if (isImageUrlRegex.test(currentLine.url)) {
                    urlDisplay.innerHTML = `<img src="${currentLine.url}" alt="Script content image">`;
                } else {
                    urlDisplay.innerHTML = `<iframe src="${currentLine.url}"></iframe>`;
                }
                urlDisplay.style.display = 'flex';
                scriptContainer.style.flex = '0 0 40%';
            } else {
                urlDisplay.style.display = 'none';
                urlDisplay.innerHTML = '';
                scriptContainer.style.flex = '1 1 100%';
            }
            
            document.querySelectorAll('[id^="playback_line_"]').forEach(line => line.classList.remove('current-line'));
            const currentLineElement = document.getElementById(`playback_line_${currentLineIndex}`);
            if (currentLineElement) {
                currentLineElement.classList.add('current-line');
                currentLineElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            const utterance = new SpeechSynthesisUtterance(currentLine.dialogue);
            if (voiceSettings) {
                if (voiceSettings.voice) utterance.voice = voiceSettings.voice;
                utterance.pitch = voiceSettings.pitch;
                utterance.rate = voiceSettings.rate;
            }
            utterance.onend = () => {
                currentLineIndex++;
                setTimeout(playNextLine, 500);
            };
            utterance.onerror = (e) => {
                console.error('Speech synthesis error:', e);
                currentLineIndex++;
                playNextLine();
            };
            
            if(utterance.text) {
                speechSynthesis.speak(utterance);
            } else {
                utterance.onend();
            }
        }

        function stopPlayback() {
            isPlaying = false;
            speechSynthesis.cancel();
            document.getElementById('playbackView').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        // --- URL Sharing & Voice Matching ---

        function inferGenderFromName(name) {
            const lowerCaseName = name.toLowerCase();
            const femaleKeywords = ['female', 'libby', 'maisie', 'sonia', 'ava', 'emma', 'ana', 'aria', 'jenny', 'michelle', 'zira', 'hazel', 'samantha', 'karen', 'tessa', 'susan', 'joanna', 'ivy', 'kendra'];
            const maleKeywords = ['male', 'ryan', 'thomas', 'andrew', 'brian', 'christopher', 'eric', 'guy', 'david', 'mark', 'alex', 'daniel', 'tom', 'fred', 'matthew', 'justin', 'joey'];
            if (femaleKeywords.some(keyword => lowerCaseName.includes(keyword))) return 'female';
            if (maleKeywords.some(keyword => lowerCaseName.includes(keyword))) return 'male';
            return null;
        }

        function generateShareableURL() {
            if (!window.processedLines || selectedSpeakers.length === 0) return alert('Please process a script first!');
            const config = { allSpeakers, selectedSpeakers, voiceSettings: {} };
            if (scriptSourceURL) {
                config.scriptURL = scriptSourceURL;
            } else {
                config.script = window.processedLines;
            }
            selectedSpeakers.forEach(speaker => {
                const settings = getSpeakerVoiceSettings(speaker);
                if (settings && settings.voice) {
                    config.voiceSettings[speaker] = { voiceName: settings.voice.name, lang: settings.voice.lang, pitch: settings.pitch, rate: settings.rate };
                }
            });
            try {
                const configJSON = JSON.stringify(config);
                const encodedConfig = btoa(unescape(encodeURIComponent(configJSON)));
                const shareableURL = `${window.location.origin}${window.location.pathname}?config=${encodedConfig}`;
                document.getElementById('shareableURL').value = shareableURL;
                document.getElementById('urlModal').style.display = 'block';
            } catch (error) {
                console.error('Error generating URL:', error);
                alert('Error generating shareable URL. The script might be too large.');
            }
        }

        async function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            if (configParam) {
                try {
                    const configJSON = decodeURIComponent(escape(atob(configParam)));
                    const config = JSON.parse(configJSON);
                    await applyConfig(config);
                } catch (error) {
                    console.error('Error loading configuration from URL:', error);
                    alert('Error loading configuration from URL. The link may be invalid.');
                }
            }
        }

        async function applyConfig(config) {
            while (availableVoices.length === 0) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            if (config.scriptURL) {
                document.getElementById('statusMessage').textContent = 'Loading shared script from URL...';
                const response = await fetch(config.scriptURL);
                const content = await response.text();
                scriptSourceURL = config.scriptURL;
                parseScript(content);
            } else {
                parsedLines = config.script || [];
                allSpeakers = config.allSpeakers || [];
            }
            selectedSpeakers = config.selectedSpeakers || [];
            displaySpeakerSelectionFromURL(config);
            displaySpeakerConfigFromURL(config);
            processScript();
        }

        function displaySpeakerSelectionFromURL(config) {
            const selectionDiv = document.getElementById('speakerSelection');
            const checkboxList = document.getElementById('speakerCheckboxList');
            checkboxList.innerHTML = '';
            allSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div');
                row.className = 'speaker-checkbox-row';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `speaker_checkbox_${index}`;
                checkbox.value = speaker;
                checkbox.checked = selectedSpeakers.includes(speaker);
                const label = document.createElement('label');
                label.htmlFor = `speaker_checkbox_${index}`;
                label.textContent = speaker;
                row.append(checkbox, label);
                checkboxList.appendChild(row);
            });
            selectionDiv.style.display = 'block';
        }

        function displaySpeakerConfigFromURL(config) {
            const configDiv = document.getElementById('speakerConfig');
            const speakerList = document.getElementById('speakerList');
            speakerList.innerHTML = '';
            const usedFallbackVoices = new Set();
            selectedSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div'); row.className = 'speaker-row';
                const nameDiv = document.createElement('div'); nameDiv.className = 'speaker-name'; nameDiv.textContent = speaker + ':';
                const voiceSelect = document.createElement('select'); voiceSelect.id = `voice_${index}`;
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                const pitchRange = document.createElement('input'); pitchRange.type = 'range'; pitchRange.id = `pitch_${index}`; pitchRange.min = '0.5'; pitchRange.max = '2'; pitchRange.step = '0.1';
                const rateRange = document.createElement('input'); rateRange.type = 'range'; rateRange.id = `rate_${index}`; rateRange.min = '0.5'; rateRange.max = '2'; rateRange.step = '0.1';
                const pitchLabel = document.createElement('span'); pitchLabel.className = 'range-label'; pitchLabel.textContent = 'Pitch:';
                const rateLabel = document.createElement('span'); rateLabel.className = 'range-label'; rateLabel.textContent = 'Rate:';

                const speakerSettings = config.voiceSettings[speaker];
                if (speakerSettings) {
                    let bestMatch = availableVoices.find(v => v.name === speakerSettings.voiceName);
                    let matchType = 'exact';
                    if (!bestMatch) {
                        const desiredGender = inferGenderFromName(speakerSettings.voiceName);
                        if (speakerSettings.lang && typeof speakerSettings.lang === 'string') {
                            const langMatches = availableVoices.filter(v => v.lang.toLowerCase() === speakerSettings.lang.toLowerCase());
                            if (langMatches.length > 0) {
                                if (desiredGender) bestMatch = langMatches.find(v => inferGenderFromName(v.name) === desiredGender && !usedFallbackVoices.has(v.name));
                                if (!bestMatch) bestMatch = langMatches.find(v => !usedFallbackVoices.has(v.name));
                                if (!bestMatch) bestMatch = langMatches[0];
                                if (bestMatch) matchType = 'language-region';
                            }
                        }
                        if (!bestMatch && speakerSettings.lang && typeof speakerSettings.lang === 'string') {
                            const baseLang = speakerSettings.lang.split('-')[0].toLowerCase();
                            const familyMatches = availableVoices.filter(v => v.lang.toLowerCase().startsWith(baseLang));
                            if (familyMatches.length > 0) {
                                if (desiredGender) bestMatch = familyMatches.find(v => inferGenderFromName(v.name) === desiredGender && !usedFallbackVoices.has(v.name));
                                if (!bestMatch) bestMatch = familyMatches.find(v => !usedFallbackVoices.has(v.name));
                                if (!bestMatch) bestMatch = familyMatches[0];
                                if (bestMatch) matchType = 'language-family';
                            }
                        }
                    }
                    if (bestMatch) {
                        voiceSelect.value = bestMatch.name;
                        if (matchType !== 'exact') {
                            usedFallbackVoices.add(bestMatch.name);
                            voiceSelect.style.border = '2px solid orange';
                        }
                    } else {
                        voiceSelect.style.border = '2px solid red';
                    }
                    pitchRange.value = speakerSettings.pitch;
                    rateRange.value = speakerSettings.rate;
                }
                row.append(nameDiv, voiceSelect, pitchLabel, pitchRange, rateLabel, rateRange);
                speakerList.appendChild(row);
            });
            configDiv.style.display = 'block';
        }

        // --- Modal Controls ---
        
        function closeURLModal() {
            document.getElementById('urlModal').style.display = 'none';
        }

        function copyToClipboard() {
            const urlTextarea = document.getElementById('shareableURL');
            urlTextarea.select();
            urlTextarea.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(urlTextarea.value);
                alert('URL copied to clipboard!');
            } catch (err) {
                alert('Failed to copy URL. Please copy it manually.');
            }
        }
    </script>
</body>
</html>