<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Speaker Text-to-Speech Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .file-input {
            margin: 10px 0;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .controls-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .volume-control label {
            font-size: 14px;
            font-weight: bold;
        }
        .volume-control input {
            width: 100px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .primary-btn {
            background-color: #007bff;
            color: white;
        }
        .primary-btn:hover {
            background-color: #0056b3;
        }
        .primary-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
        .secondary-btn:hover {
            background-color: #545b62;
        }
        .speaker-selection {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            display: none;
        }
        .speaker-checkbox-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        .select-all-controls {
            margin: 10px 0;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
        .select-all-controls button {
            margin-right: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }
        .speaker-config {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .speaker-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        .speaker-name {
            min-width: 150px;
            font-weight: bold;
        }
        select, input[type="range"] {
            margin: 0 5px;
        }
        .range-label {
            font-size: 12px;
            margin: 0 5px;
        }
        .progress {
            margin: 20px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        .script-preview {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .current-line {
            padding: 5px;
            margin: 2px 0;
            background-color: #fff3cd;
            border-radius: 3px;
        }
        .url-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .url-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }
        .url-textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .modal-buttons {
            text-align: right;
            margin-top: 15px;
        }
        .modal-buttons button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Speaker Text-to-Speech Converter</h1>
        
        <div class="upload-section">
            <h3>Upload Your Script</h3>
            <input type="file" id="scriptFile" class="file-input" accept=".txt" />
            <p>Upload a text file with dialogue in format: "Speaker Name: dialogue text"</p>
        </div>

        <div class="controls">
            <div class="controls-row">
                <button class="primary-btn" id="processBtn" onclick="processScript()" disabled>Process Script</button>
                <button class="primary-btn" id="playBtn" onclick="startPlayback()" disabled>Start Playback</button>
                <button class="secondary-btn" id="stopBtn" onclick="stopPlayback()" disabled>Stop</button>
                <button class="secondary-btn" id="pauseBtn" onclick="pausePlayback()" disabled>Pause</button>
                <div class="volume-control">
                    <label for="volumeControl">Volume:</label>
                    <input type="range" id="volumeControl" min="0" max="100" step="10" value="100">
                    <span id="volumeDisplay">100%</span>
                </div>
            </div>
             <div class="controls-row">
                <button class="primary-btn" id="shareBtn" onclick="generateShareableURL()" disabled>Generate Shareable URL</button>
                <span id="statusMessage" style="margin-left: 10px; font-style: italic; color: #666;"></span>
            </div>
        </div>

        <div class="speaker-selection" id="speakerSelection">
            <h3>Select Speakers to Include</h3>
            <div class="select-all-controls">
                <button class="secondary-btn" onclick="selectAllSpeakers()">Select All</button>
                <button class="secondary-btn" onclick="deselectAllSpeakers()">Deselect All</button>
            </div>
            <div id="speakerCheckboxList"></div>
            <button class="primary-btn" onclick="updateSpeakerConfig()" style="margin-top: 15px;">Configure Selected Speakers</button>
        </div>

        <div class="speaker-config" id="speakerConfig">
            <h3>Configure Speaker Voices</h3>
            <div id="speakerList"></div>
        </div>

        <div class="progress" id="progress">
            <div>Current: <span id="currentSpeaker"></span></div>
            <div>Line: <span id="currentLine"></span></div>
        </div>

        <div class="script-preview" id="scriptPreview">
            <h4>Script Preview</h4>
            <div id="previewContent"></div>
        </div>

        <div id="urlModal" class="url-modal">
            <div class="url-modal-content">
                <h3>Shareable URL Generated!</h3>
                <p>Copy this URL to share your configured TTS setup:</p>
                <textarea id="shareableURL" readonly class="url-textarea"></textarea>
                <div class="modal-buttons">
                    <button class="secondary-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
                    <button class="primary-btn" onclick="closeURLModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let parsedLines = [];
        let allSpeakers = [];
        let selectedSpeakers = [];
        let currentLineIndex = 0;
        let isPlaying = false;
        let isPaused = false;
        let availableVoices = [];

        // --- Initialization ---

        // Load available voices from the browser
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length === 0) {
                setTimeout(loadVoices, 100);
            }
        }
        loadVoices();
        speechSynthesis.onvoiceschanged = loadVoices;

        // On page load, check if there's a configuration in the URL
        window.addEventListener('load', loadFromURL);

        // --- Event Listeners ---

        // Volume control slider
        document.getElementById('volumeControl').addEventListener('input', function(e) {
            const volume = e.target.value;
            document.getElementById('volumeDisplay').textContent = volume + '%';
        });

        // File upload handler
        document.getElementById('scriptFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseScript(e.target.result);
                };
                reader.readAsText(file);
            }
        });
        
        // --- Core Script Processing ---

        function parseScript(content) {
            const lines = content.split('\n');
            parsedLines = [];
            const speakerSet = new Set();

            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const speaker = line.substring(0, colonIndex).trim();
                        const dialogue = line.substring(colonIndex + 1).trim();
                        const cleanedDialogue = dialogue.replace(/\([^)]*\)/g, '').trim();
                        
                        if (cleanedDialogue) {
                            speakerSet.add(speaker);
                            parsedLines.push({ speaker, dialogue: cleanedDialogue });
                        }
                    }
                }
            });

            allSpeakers = Array.from(speakerSet);
            selectedSpeakers = [...allSpeakers];
            displaySpeakerSelection();
        }

        function processScript() {
            if (selectedSpeakers.length === 0) {
                alert('Please select at least one speaker!');
                return;
            }
            
            const filteredLines = parsedLines.filter(line => selectedSpeakers.includes(line.speaker));
            if (filteredLines.length === 0) {
                alert('No dialogue found for the selected speakers!');
                return;
            }
            
            window.processedLines = filteredLines;
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('shareBtn').disabled = false;
            alert(`Script processed! Ready to play ${filteredLines.length} lines.`);
        }

        // --- UI Display Functions ---

        function displaySpeakerSelection() {
            const selectionDiv = document.getElementById('speakerSelection');
            const checkboxList = document.getElementById('speakerCheckboxList');
            checkboxList.innerHTML = '';
            
            allSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div');
                row.className = 'speaker-checkbox-row';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `speaker_checkbox_${index}`;
                checkbox.value = speaker;
                checkbox.checked = true;
                
                const label = document.createElement('label');
                label.htmlFor = `speaker_checkbox_${index}`;
                label.textContent = speaker;
                
                row.appendChild(checkbox);
                row.appendChild(label);
                checkboxList.appendChild(row);
            });
            
            selectionDiv.style.display = 'block';
            updateSpeakerConfig();
        }

        function updateSpeakerConfig() {
            selectedSpeakers = [];
            allSpeakers.forEach((speaker, index) => {
                const checkbox = document.getElementById(`speaker_checkbox_${index}`);
                if (checkbox && checkbox.checked) {
                    selectedSpeakers.push(speaker);
                }
            });

            if (selectedSpeakers.length === 0) {
                document.getElementById('speakerConfig').style.display = 'none';
                document.getElementById('processBtn').disabled = true;
                return;
            }

            displaySpeakerConfig();
            displayScriptPreview();
        }
        
        function displaySpeakerConfig() {
            const configDiv = document.getElementById('speakerConfig');
            const speakerList = document.getElementById('speakerList');
            speakerList.innerHTML = '';
            
            selectedSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div');
                row.className = 'speaker-row';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'speaker-name';
                nameDiv.textContent = speaker + ':';
                
                const voiceSelect = document.createElement('select');
                voiceSelect.id = `voice_${index}`;
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                const pitchLabel = document.createElement('span');
                pitchLabel.className = 'range-label';
                pitchLabel.textContent = 'Pitch:';
                const pitchRange = document.createElement('input');
                pitchRange.type = 'range';
                pitchRange.id = `pitch_${index}`;
                pitchRange.min = '0.5';
                pitchRange.max = '2';
                pitchRange.step = '0.1';
                pitchRange.value = '1';
                
                const rateLabel = document.createElement('span');
                rateLabel.className = 'range-label';
                rateLabel.textContent = 'Rate:';
                const rateRange = document.createElement('input');
                rateRange.type = 'range';
                rateRange.id = `rate_${index}`;
                rateRange.min = '0.5';
                rateRange.max = '2';
                rateRange.step = '0.1';
                rateRange.value = '1';
                
                row.append(nameDiv, voiceSelect, pitchLabel, pitchRange, rateLabel, rateRange);
                speakerList.appendChild(row);
                
                if (availableVoices.length > 0) {
                    const voiceIndex = index % availableVoices.length;
                    voiceSelect.value = availableVoices[voiceIndex]?.name;
                }
            });
            
            configDiv.style.display = 'block';
            document.getElementById('processBtn').disabled = false;
        }

        function displayScriptPreview() {
            const previewDiv = document.getElementById('scriptPreview');
            const previewContent = document.getElementById('previewContent');
            const filteredLines = parsedLines.filter(line => selectedSpeakers.includes(line.speaker));
            
            previewContent.innerHTML = filteredLines.map((line, index) => 
                `<div id="line_${index}"><strong>${line.speaker}:</strong> ${line.dialogue}</div>`
            ).join('');
            
            previewDiv.style.display = 'block';
        }

        function selectAllSpeakers() {
            document.querySelectorAll('#speakerCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllSpeakers() {
            document.querySelectorAll('#speakerCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // --- Playback Controls ---

        function getSpeakerVoiceSettings(speaker) {
            const speakerIndex = selectedSpeakers.indexOf(speaker);
            if (speakerIndex === -1) return null;

            const voiceName = document.getElementById(`voice_${speakerIndex}`).value;
            const pitch = parseFloat(document.getElementById(`pitch_${speakerIndex}`).value);
            const rate = parseFloat(document.getElementById(`rate_${speakerIndex}`).value);
            
            return {
                voice: availableVoices.find(v => v.name === voiceName),
                pitch,
                rate
            };
        }

        function startPlayback() {
            // --- NEW FIX HERE ---
            // Clear any stale or pending utterances before starting.
            speechSynthesis.cancel(); 
            
            const linesToPlay = window.processedLines;
            if (!linesToPlay || linesToPlay.length === 0) {
                alert('Please process the script first.');
                return;
            }
            
            window.playbackLines = linesToPlay;
            isPlaying = true;
            isPaused = false;
            currentLineIndex = 0;
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('progress').style.display = 'block';
            
            playNextLine();
        }

        function playNextLine() {
            if (!isPlaying || isPaused || currentLineIndex >= window.playbackLines.length) {
                if (currentLineIndex >= window.playbackLines.length) stopPlayback();
                return;
            }
            
            const currentLine = window.playbackLines[currentLineIndex];
            const voiceSettings = getSpeakerVoiceSettings(currentLine.speaker);
            
            document.getElementById('currentSpeaker').textContent = currentLine.speaker;
            document.getElementById('currentLine').textContent = currentLine.dialogue.substring(0, 50) + '...';
            
            document.querySelectorAll('[id^="line_"]').forEach(line => line.classList.remove('current-line'));
            const currentLineElement = document.getElementById(`line_${currentLineIndex}`);
            if (currentLineElement) currentLineElement.classList.add('current-line');
            
            const utterance = new SpeechSynthesisUtterance(currentLine.dialogue);
            
            // Safely assign settings and handle unavailable voices
            if (voiceSettings) {
                // Only assign the voice if it was successfully found
                if (voiceSettings.voice) {
                    utterance.voice = voiceSettings.voice;
                }
                // If voice is null/undefined, browser uses its default, preventing the error.
                utterance.pitch = voiceSettings.pitch;
                utterance.rate = voiceSettings.rate;
            }
            
            utterance.volume = parseInt(document.getElementById('volumeControl').value) / 100;
            
            utterance.onend = () => {
                currentLineIndex++;
                setTimeout(playNextLine, 500); // Pause between lines
            };
            
            utterance.onerror = (e) => {
                console.error('Speech synthesis error:', e);
                currentLineIndex++;
                playNextLine(); // Skip faulty line
            };
            
            speechSynthesis.speak(utterance);
        }

        function stopPlayback() {
            isPlaying = false;
            isPaused = false;
            speechSynthesis.cancel();
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = 'Pause';
            document.getElementById('progress').style.display = 'none';
            document.querySelectorAll('[id^="line_"]').forEach(line => line.classList.remove('current-line'));
        }

        function pausePlayback() {
            if (isPlaying && !isPaused) {
                isPaused = true;
                speechSynthesis.pause();
                document.getElementById('pauseBtn').textContent = 'Resume';
            } else if (isPaused) {
                isPaused = false;
                speechSynthesis.resume();
                document.getElementById('pauseBtn').textContent = 'Pause';
            }
        }

        // --- URL Sharing Functionality ---

        function generateShareableURL() {
            if (!window.processedLines || selectedSpeakers.length === 0) {
                alert('Please process a script first!');
                return;
            }

            const config = {
                script: window.processedLines,
                allSpeakers: allSpeakers,
                selectedSpeakers: selectedSpeakers,
                volume: parseInt(document.getElementById('volumeControl').value),
                voiceSettings: {}
            };

            selectedSpeakers.forEach(speaker => {
                const settings = getSpeakerVoiceSettings(speaker);
                if (settings && settings.voice) {
                    config.voiceSettings[speaker] = {
                        voiceName: settings.voice.name,
                        pitch: settings.pitch,
                        rate: settings.rate
                    };
                }
            });

            try {
                const configJSON = JSON.stringify(config);
                const encodedConfig = btoa(unescape(encodeURIComponent(configJSON))); // Handle UTF-8 characters
                const shareableURL = `${window.location.origin}${window.location.pathname}?config=${encodedConfig}`;
                
                document.getElementById('shareableURL').value = shareableURL;
                document.getElementById('urlModal').style.display = 'block';
            } catch (error) {
                console.error('Error generating URL:', error);
                alert('Error generating shareable URL. The script might be too large.');
            }
        }

        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            
            if (configParam) {
                try {
                    const configJSON = decodeURIComponent(escape(atob(configParam)));
                    const config = JSON.parse(configJSON);
                    
                    function applyConfig() {
                        if (availableVoices.length === 0) {
                            setTimeout(applyConfig, 100); // Wait for voices
                            return;
                        }
                        
                        parsedLines = config.script || [];
                        allSpeakers = config.allSpeakers || [];
                        selectedSpeakers = config.selectedSpeakers || [];
                        window.processedLines = config.script || [];
                        
                        document.getElementById('volumeControl').value = config.volume || 100;
                        document.getElementById('volumeDisplay').textContent = (config.volume || 100) + '%';
                        
                        displaySpeakerSelectionFromURL(config);
                        displaySpeakerConfigFromURL(config);
                        displayScriptPreview();
                        
                        document.getElementById('processBtn').disabled = false;
                        document.getElementById('playBtn').disabled = false;
                        document.getElementById('shareBtn').disabled = false;
                        
                        document.getElementById('statusMessage').textContent = 'Configuration loaded from URL!';
                        document.getElementById('statusMessage').style.color = 'green';
                    }
                    
                    applyConfig();
                    
                } catch (error) {
                    console.error('Error loading configuration from URL:', error);
                    alert('Error loading configuration from URL. The link may be invalid.');
                }
            }
        }

        function displaySpeakerSelectionFromURL(config) {
            const selectionDiv = document.getElementById('speakerSelection');
            const checkboxList = document.getElementById('speakerCheckboxList');
            checkboxList.innerHTML = '';
            
            allSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div');
                row.className = 'speaker-checkbox-row';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `speaker_checkbox_${index}`;
                checkbox.value = speaker;
                checkbox.checked = selectedSpeakers.includes(speaker);
                const label = document.createElement('label');
                label.htmlFor = `speaker_checkbox_${index}`;
                label.textContent = speaker;
                row.append(checkbox, label);
                checkboxList.appendChild(row);
            });
            
            selectionDiv.style.display = 'block';
        }

        function displaySpeakerConfigFromURL(config) {
            const configDiv = document.getElementById('speakerConfig');
            const speakerList = document.getElementById('speakerList');
            speakerList.innerHTML = '';
            
            selectedSpeakers.forEach((speaker, index) => {
                const row = document.createElement('div');
                row.className = 'speaker-row';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'speaker-name';
                nameDiv.textContent = speaker + ':';
                
                const voiceSelect = document.createElement('select');
                voiceSelect.id = `voice_${index}`;
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                const pitchLabel = document.createElement('span');
                pitchLabel.className = 'range-label';
                pitchLabel.textContent = 'Pitch:';
                const pitchRange = document.createElement('input');
                pitchRange.type = 'range';
                pitchRange.id = `pitch_${index}`;
                pitchRange.min = '0.5';
                pitchRange.max = '2';
                pitchRange.step = '0.1';
                
                const rateLabel = document.createElement('span');
                rateLabel.className = 'range-label';
                rateLabel.textContent = 'Rate:';
                const rateRange = document.createElement('input');
                rateRange.type = 'range';
                rateRange.id = `rate_${index}`;
                rateRange.min = '0.5';
                rateRange.max = '2';
                rateRange.step = '0.1';
                
                const speakerSettings = config.voiceSettings[speaker];
                if (speakerSettings) {
                    // Check if the saved voice exists in the current browser
                    const voiceExists = availableVoices.some(v => v.name === speakerSettings.voiceName);
                    
                    if (voiceExists) {
                        voiceSelect.value = speakerSettings.voiceName;
                    } else {
                        // Add a visual warning if the voice is not found
                        console.warn(`Voice "${speakerSettings.voiceName}" not found. Using default voice for ${speaker}.`);
                        voiceSelect.style.border = '2px solid red';
                    }
                    
                    pitchRange.value = speakerSettings.pitch;
                    rateRange.value = speakerSettings.rate;
                }
                
                row.append(nameDiv, voiceSelect, pitchLabel, pitchRange, rateLabel, rateRange);
                speakerList.appendChild(row);
            });
            
            configDiv.style.display = 'block';
        }

        // --- Modal Controls ---
        
        function closeURLModal() {
            document.getElementById('urlModal').style.display = 'none';
        }

        function copyToClipboard() {
            const urlTextarea = document.getElementById('shareableURL');
            urlTextarea.select();
            urlTextarea.setSelectionRange(0, 99999); // For mobile devices
            try {
                navigator.clipboard.writeText(urlTextarea.value);
                alert('URL copied to clipboard!');
            } catch (err) {
                alert('Failed to copy URL. Please copy it manually.');
            }
        }
        
    </script>
</body>
</html>