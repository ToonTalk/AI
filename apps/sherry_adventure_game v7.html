<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Girl and Her Laptop in Ancient Sumer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #F4A460 100%);
            min-height: 100vh;
            color: #2F1B14;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            min-height: 100vh;
        }

        .main-panel {
            background: rgba(255, 248, 220, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid #8B4513;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-panel, .diary-panel, .ai-panel {
            background: rgba(255, 248, 220, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid #8B4513;
        }

        .game-title {
            text-align: center;
            color: #8B4513;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .api-setup {
            background: #FFF8DC;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #D2691E;
            margin-bottom: 20px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #8B4513;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .story-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.7);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #8B4513;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #4682B4, #5F9EA0);
            text-align: left;
            padding: 15px;
            border-radius: 10px;
        }

        .choice-btn:hover {
            background: linear-gradient(45deg, #5F9EA0, #4682B4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            border: 1px solid #8B4513;
        }

        .stat-label {
            font-size: 12px;
            color: #8B4513;
            font-weight: bold;
        }

        .stat-value {
            font-size: 16px;
            color: #2F1B14;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #DDD;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B4513, #D2691E);
            transition: width 0.3s ease;
        }

        .diary-entry {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #8B4513;
            font-style: italic;
            font-size: 14px;
        }

        .ai-chat {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #4682B4;
        }

        .ai-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #4682B4;
            border-radius: 5px;
            margin-top: 10px;
        }

        .ai-message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 5px;
        }

        .ai-message.user {
            background: #E6F3FF;
            text-align: right;
        }

        .ai-message.ai {
            background: #F0F8F0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #8B4513;
            font-style: italic;
        }

        .day-header {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .btn.recording {
            background: linear-gradient(45deg, #DC143C, #FF69B4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .audio-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00FF00;
            border-radius: 50%;
            margin-left: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="main-panel">
            <h1 class="game-title">A Girl and Her Laptop in Ancient Sumer</h1>
            
            <div class="api-setup" id="apiSetup">
                <h3>ðŸ¤– AI Partnership Setup</h3>
                <p>To experience the full AI collaboration, enter your Gemini API key:</p>
                <input type="password" class="api-input" id="apiKey" placeholder="Enter your Gemini API key...">
                <label for="modelSelect" style="font-size: 14px; color: #8B4513; font-weight: bold;">Gemini Model:</label>
                <select class="api-input" id="modelSelect" onchange="handleModelChange()">
                    <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash Preview 05-20 (Multimodal)</option>
                    <option value="gemini-2.5-flash-preview-native-audio-dialog">Gemini 2.5 Flash Native Audio Dialog ðŸŽ¤ðŸ”Š</option>
                    <option value="gemini-2.5-flash-exp-native-audio-thinking-dialog">Gemini 2.5 Flash Native Audio Thinking ðŸŽ¤ðŸ”Š</option>
                    <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS ðŸ”Š</option>
                    <option value="gemini-2.5-pro-preview-06-05">Gemini 2.5 Pro Preview (Enhanced)</option>
                    <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS ðŸ”Š</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Fast)</option>
                    <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite (Efficient)</option>
                </select>
                <div id="audioWarning" style="display: none; margin-top: 10px; padding: 10px; background: #FFE4B5; border: 1px solid #D2691E; border-radius: 5px; font-size: 12px;">
                    ðŸŽ¤ Audio features enabled! You can speak to your AI partner and hear responses.
                </div>
                <div id="imageWarning" style="display: none; margin-top: 10px; padding: 10px; background: #E6F3FF; border: 1px solid #4682B4; border-radius: 5px; font-size: 12px;">
                    ðŸŽ¨ Image generation enabled! Scenes will include AI-generated illustrations.
                </div>
                <button class="btn" onclick="setupAPI()">Connect AI Partner</button>
                <p style="font-size: 12px; margin-top: 10px; color: #666;">
                    Get your free API key at <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                </p>
            </div>

            <div id="gameContent" style="display: none;">
                <div class="day-header" id="dayHeader">Day 1 - Through the Portal</div>
                <div class="story-text" id="storyText"></div>
                <div id="sceneImage" style="text-align: center; margin: 20px 0; display: none;">
                    <img id="generatedImage" style="max-width: 100%; border-radius: 10px; border: 3px solid #8B4513; box-shadow: 0 5px 15px rgba(0,0,0,0.3);" />
                    <div style="font-size: 12px; color: #8B4513; margin-top: 5px; font-style: italic;">ðŸŽ¨ AI-generated illustration</div>
                </div>
                <div class="choices" id="choices"></div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.8); border-radius: 10px; border: 2px dashed #8B4513;">
                    <h4 style="margin: 0 0 10px 0; color: #8B4513;">âœ¨ Custom Action</h4>
                    <input type="text" id="customAction" class="api-input" placeholder="Describe your own action..." style="margin: 5px 0;">
                    <button class="btn" onclick="takeCustomAction()" id="customActionBtn">Take This Action</button>
                </div>
                
                <div class="loading" id="loading">ðŸ”® The AI is thinking...</div>
            </div>
        </div>

        <div class="side-panel">
            <div class="stats-panel">
                <h3>ðŸ“Š Status</h3>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-label">SURVIVAL</div>
                        <div class="stat-value" id="survival">85</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="survivalBar" style="width: 85%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">SUMERIAN</div>
                        <div class="stat-value" id="sumerian">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="sumerianBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">KING'S FAVOR</div>
                        <div class="stat-value" id="kingsFavor">60</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="kingsFavorBar" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">CREATIVITY</div>
                        <div class="stat-value" id="creativity">70</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="creativityBar" style="width: 70%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">RELATIONSHIPS</div>
                        <div class="stat-value" id="relationships">40</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="relationshipsBar" style="width: 40%"></div>
                        </div>
                    </div>
                </div>
                <div class="stat" style="margin-top: 15px;">
                    <div class="stat-label">LAPTOP BATTERY</div>
                    <div class="stat-value" id="battery">60%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="batteryBar" style="width: 60%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">DAYS SURVIVED</div>
                    <div class="stat-value" id="dayCount">1</div>
                </div>
            </div>

            <div class="diary-panel">
                <h3>ðŸ“– Sherry's Diary</h3>
                <button class="btn" onclick="saveDiary()" style="width: 100%; margin-bottom: 10px; font-size: 14px;">ðŸ’¾ Save Diary</button>
                <div id="diaryEntries">
                    <div class="diary-entry">
                        <strong>Day 1:</strong> I can't believe this is real. I touched that weird shimmery doorway and now I'm in actual ancient Sumer! Nobody understands me and I can't understand them. The King is going to kill me tomorrow night if I can't entertain him, but we can't even talk to each other. My laptop might be my only hope...
                    </div>
                </div>
            </div>

            <div class="ai-panel">
                <h3>ðŸ¤– AI Partner</h3>
                <div class="ai-chat" id="aiChat">
                    <div class="ai-message ai">Hello! I'm your AI partner. Together we can solve any challenge in ancient Sumer. What would you like to work on?</div>
                </div>
                <div id="audioControls" style="display: none; margin: 10px 0;">
                    <button class="btn" id="recordBtn" onclick="toggleRecording()" style="width: 48%; margin-right: 2%;">ðŸŽ¤ Speak</button>
                    <button class="btn" id="playLastBtn" onclick="playLastResponse()" style="width: 48%;" disabled>ðŸ”Š Replay</button>
                </div>
                <input type="text" class="ai-input" id="aiInput" placeholder="Ask your AI partner for help..." onkeypress="handleAIInput(event)" disabled>
                <button class="btn" onclick="sendAIMessage()" id="aiSendBtn" disabled>Send</button>
                <button class="btn" onclick="takeCustomAction()" id="customActionBtn2" disabled style="width: 100%; margin-top: 5px; background: linear-gradient(45deg, #8B4513, #D2691E);">Custom Action</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            day: 1,
            survival: 85,
            kingsFavor: 60,
            creativity: 70,
            relationships: 40,
            battery: 60,
            apiKey: null,
            selectedModel: 'gemini-2.5-flash-preview-05-20',
            sumerianLevel: 0, // 0-100, affects communication ability
            currentScene: 'start',
            audioSupported: false,
            ttsSupported: false,
            audioInputSupported: false,
            imageGenerationSupported: false,
            isRecording: false
        };

        // Audio and image capability mapping
        const modelCapabilities = {
            'gemini-2.5-flash-preview-native-audio-dialog': { input: true, output: true, image: false },
            'gemini-2.5-flash-exp-native-audio-thinking-dialog': { input: true, output: true, image: false },
            'gemini-2.5-flash-preview-tts': { input: false, output: true, image: false },
            'gemini-2.5-pro-preview-tts': { input: false, output: true, image: false }
            // Note: Image generation models don't appear to be available via the current API
        };

        let mediaRecorder = null;
        let audioChunks = [];

        const scenes = {
            start: {
                title: "Day 1 - Through the Portal",
                text: "You're standing in the King's throne room, trembling with fear. The enormous chamber is lit by hundreds of oil lamps casting dancing shadows on the walls. The King sits on his throne, looking bored and impatient. He's speaking to someone in rapid Sumerian - a language that sounds like musical gibberish to you.\n\nThree people have already been thrown from the window tonight for failing to entertain him. The guards are gesturing at you and speaking in that same incomprehensible language. You catch one word that sounds like 'lugal' - but you have no idea what it means.\n\nYour laptop is in your backpack. The battery shows 60%. The King notices you and barks something in Sumerian, clearly expecting a response. What do you do?",
                choices: [
                    {
                        text: "Pull out the laptop immediately - maybe the light will stop him from getting angry",
                        effects: { kingsFavor: 15, battery: -10, survival: 10 },
                        next: "laptop_reveal"
                    },
                    {
                        text: "Try to mime and gesture to show you don't understand the language",
                        effects: { relationships: 5, survival: -5 },
                        next: "language_barrier"
                    },
                    {
                        text: "Look around desperately for someone who might help",
                        effects: { relationships: 10, survival: 5 },
                        next: "seek_help"
                    },
                    {
                        text: "Ask your AI partner how to handle this language barrier crisis",
                        effects: { creativity: 10 },
                        next: "ai_consultation",
                        requiresAI: true
                    }
                ]
            },
            laptop_reveal: {
                title: "Day 1 - The Magic Light",
                text: "You pull out your laptop with shaking hands. As the screen lights up in the dark throne room, everyone goes completely silent. The startup sound echoes through the chamber. The King's angry expression transforms into wide-eyed amazement.\n\nHe says something in rapid Sumerian that sounds excited but you understand nothing. He points at the screen and then at you, his voice rising with what sounds like questions. An old woman in the corner - she must be Ku-Baba - says something softly to the King. He nods and makes a gesture.\n\nThe King is clearly fascinated, but you're still trapped by the language barrier. You can see his patience might not last long if you can't figure out how to communicate.",
                choices: [
                    {
                        text: "Point at yourself, then the laptop, then mime typing to show it's yours",
                        effects: { kingsFavor: 10, sumerianLevel: 5 },
                        next: "basic_communication"
                    },
                    {
                        text: "Open a simple program and let him see the screen change",
                        effects: { kingsFavor: 20, battery: -15, creativity: 10 },
                        next: "visual_demonstration"
                    },
                    {
                        text: "Try to teach him the English word 'computer' by pointing and repeating",
                        effects: { sumerianLevel: 3, relationships: 5 },
                        next: "word_exchange"
                    }
                ]
            },
            language_barrier: {
                title: "Day 1 - Lost in Translation",
                text: "You spread your hands wide and shake your head, trying to show you don't understand. The King's face darkens. He says something sharp and commanding. Guards step forward.\n\nSuddenly, the old woman in the corner - Ku-Baba - stands up. She shuffles over and places herself between you and the guards. She speaks to the King in what sounds like pleading tones, gesturing toward you. You catch her making motions like she's writing in the air.\n\nThe King listens, then looks at you with curiosity instead of anger. Ku-Baba turns to you and very slowly says a few words in Sumerian, pointing at herself: 'Ku... Ba... Ba.' Then she points at you with a questioning expression.",
                choices: [
                    {
                        text: "Point to yourself and clearly say 'Sherry'",
                        effects: { relationships: 15, sumerianLevel: 5 },
                        next: "name_exchange"
                    },
                    {
                        text: "Try to copy her gestures and pointing",
                        effects: { relationships: 10, sumerianLevel: 3 },
                        next: "gesture_learning"
                    },
                    {
                        text: "Pull out your laptop to show you have something valuable",
                        effects: { kingsFavor: 10, battery: -5 },
                        next: "laptop_intervention"
                    }
                ]
            }
        };

        function handleModelChange() {
            const selectedModel = document.getElementById('modelSelect').value;
            const audioWarning = document.getElementById('audioWarning');
            const imageWarning = document.getElementById('imageWarning');
            
            const capabilities = modelCapabilities[selectedModel];
            
            if (capabilities && (capabilities.input || capabilities.output)) {
                audioWarning.style.display = 'block';
            } else {
                audioWarning.style.display = 'none';
            }
            
            if (capabilities && capabilities.image) {
                imageWarning.style.display = 'block';
            } else {
                imageWarning.style.display = 'none';
            }
        }

        function updateAudioControls() {
            const audioControls = document.getElementById('audioControls');
            if (gameState.audioSupported) {
                audioControls.style.display = 'block';
            } else {
                audioControls.style.display = 'none';
            }
        }

        function setupAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const selectedModel = document.getElementById('modelSelect').value;
            
            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }
            
            gameState.apiKey = apiKey;
            gameState.selectedModel = selectedModel;
            
            // Update audio capabilities
            const capabilities = modelCapabilities[selectedModel];
            if (capabilities) {
                gameState.audioInputSupported = capabilities.input;
                gameState.ttsSupported = capabilities.output;
                gameState.audioSupported = capabilities.input || capabilities.output;
                gameState.imageGenerationSupported = capabilities.image;
            } else {
                gameState.audioInputSupported = false;
                gameState.ttsSupported = false;
                gameState.audioSupported = false;
                gameState.imageGenerationSupported = false;
            }
            
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('aiInput').disabled = false;
            document.getElementById('aiSendBtn').disabled = false;
            document.getElementById('customActionBtn').disabled = false;
            document.getElementById('customActionBtn2').disabled = false;
            
            updateAudioControls();
            loadScene('start');
        }

        function takeCustomAction() {
            const customText = document.getElementById('customAction').value.trim();
            if (!customText) {
                alert('Please describe what you want to do');
                return;
            }
            
            if (!gameState.apiKey) {
                alert('Custom actions require an API key to process');
                return;
            }
            
            const customChoice = {
                text: customText,
                effects: {}, // Effects will be determined by AI
                isCustom: true
            };
            
            document.getElementById('customAction').value = '';
            generateNewScene(customChoice);
        }

        function loadScene(sceneKey) {
            const scene = scenes[sceneKey];
            if (!scene) return;

            gameState.currentScene = sceneKey;
            document.getElementById('dayHeader').textContent = scene.title;
            document.getElementById('storyText').textContent = scene.text;
            
            // Generate image if image generation is supported
            if (gameState.imageGenerationSupported && gameState.apiKey) {
                generateSceneImage(scene);
            } else {
                document.getElementById('sceneImage').style.display = 'none';
            }
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            scene.choices.forEach((choice, index) => {
                if (choice.requiresAI && !gameState.apiKey) return;
                
                const button = document.createElement('button');
                button.className = 'btn choice-btn';
                button.textContent = choice.text;
                button.onclick = () => makeChoice(choice);
                choicesDiv.appendChild(button);
            });
        }

        async function generateSceneImage(scene) {
            if (!gameState.imageGenerationSupported || !gameState.apiKey) return;

            try {
                // Show loading state with safe ASCII characters
                const sceneImageDiv = document.getElementById('sceneImage');
                const imageElement = document.getElementById('generatedImage');
                sceneImageDiv.style.display = 'block';
                
                const loadingSvg = `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="#F4A460"/>
                    <text x="50%" y="50%" text-anchor="middle" fill="#8B4513" font-size="16" font-family="serif">
                        Generating illustration...
                    </text>
                </svg>`;
                imageElement.src = 'data:image/svg+xml;base64,' + btoa(loadingSvg);

                // Note: The image generation model endpoint appears to be invalid
                // For now, we'll create a decorative placeholder image
                const placeholderSvg = `<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="desert" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#F4A460;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8B4513;stop-opacity:1" />
                        </linearGradient>
                        <radialGradient id="lamp" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:0.3" />
                        </radialGradient>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#desert)"/>
                    
                    <!-- Palace walls -->
                    <rect x="30" y="80" width="340" height="180" fill="#CD853F" stroke="#8B4513" stroke-width="3"/>
                    <rect x="50" y="100" width="50" height="120" fill="#A0522D" stroke="#654321" stroke-width="2"/>
                    <rect x="300" y="100" width="50" height="120" fill="#A0522D" stroke="#654321" stroke-width="2"/>
                    
                    <!-- Throne -->
                    <rect x="160" y="140" width="80" height="80" fill="#DAA520" stroke="#B8860B" stroke-width="2"/>
                    <rect x="170" y="130" width="60" height="20" fill="#FFD700" stroke="#FFA500" stroke-width="1"/>
                    
                    <!-- Laptop (glowing) -->
                    <rect x="180" y="160" width="40" height="25" fill="#2F4F4F" stroke="#4682B4" stroke-width="2"/>
                    <rect x="183" y="163" width="34" height="19" fill="#87CEEB" opacity="0.8"/>
                    <circle cx="200" cy="172" r="2" fill="#00FF00" opacity="0.9"/>
                    
                    <!-- Oil lamps -->
                    <circle cx="80" cy="60" r="20" fill="url(#lamp)"/>
                    <circle cx="320" cy="60" r="20" fill="url(#lamp)"/>
                    
                    <!-- Girl silhouette -->
                    <circle cx="200" cy="190" r="8" fill="#8B4513"/>
                    <rect x="195" y="198" width="10" height="25" fill="#654321"/>
                    
                    <!-- Scene title -->
                    <text x="200" y="30" text-anchor="middle" fill="#8B4513" font-size="14" font-weight="bold" font-family="serif">
                        Ancient Sumer Adventure
                    </text>
                    
                    <!-- Atmosphere lines -->
                    <line x1="60" y1="40" x2="65" y2="45" stroke="#FFD700" stroke-width="1" opacity="0.6"/>
                    <line x1="340" y1="45" x2="335" y2="50" stroke="#FFD700" stroke-width="1" opacity="0.6"/>
                    <line x1="75" y1="35" x2="80" y2="40" stroke="#FFD700" stroke-width="1" opacity="0.6"/>
                </svg>`;

                // Set the placeholder image
                imageElement.src = 'data:image/svg+xml;base64,' + btoa(placeholderSvg);

            } catch (error) {
                console.error('Error generating scene image:', error);
                // Hide image on error
                document.getElementById('sceneImage').style.display = 'none';
            }
        }

        function makeChoice(choice) {
            // Apply effects
            Object.keys(choice.effects).forEach(stat => {
                if (gameState.hasOwnProperty(stat)) {
                    gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + choice.effects[stat]));
                }
            });
            
            updateUI();
            
            if (choice.next === 'ai_consultation') {
                handleAIConsultation();
            } else if (scenes[choice.next]) {
                loadScene(choice.next);
            } else {
                generateNewScene(choice);
            }
            
            // Add diary entry
            addDiaryEntry(choice.text);
        }

        async function generateNewScene(choice) {
            if (!gameState.apiKey) {
                alert('AI features require an API key');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            
            const isCustomAction = choice.isCustom || false;
            const actionDescription = isCustomAction ? 
                `The player chose a custom action: "${choice.text}"` : 
                `The player chose: "${choice.text}"`;
            
            const prompt = `Continue this adventure story. ${actionDescription}
            
            STORY CONTEXT:
            You are continuing the story of Sherry, a 12-year-old girl who fell through a time portal into ancient Sumer (around 3000 BCE). She is trapped in the palace of a Sumerian king who kills people who fail to entertain him. Key characters:
            
            - SHERRY: 12-year-old American girl, has a laptop, speaks no Sumerian initially
            - THE KING: Sumerian ruler, speaks NO English, interested in demonstrations of power/magic
            - KU-BABA: Elderly Sumerian woman, prisoner in the palace, very wise, invented early writing, understands Sherry's situation, acts as occasional translator/helper
            - GUARDS: Sumerian soldiers who speak no English
            
            Current game state:
            - Day: ${gameState.day}
            - Survival: ${gameState.survival}%
            - King's Favor: ${gameState.kingsFavor}%
            - Creativity: ${gameState.creativity}%
            - Relationships: ${gameState.relationships}%
            - Battery: ${gameState.battery}%
            - Sumerian Language Level: ${gameState.sumerianLevel}% (0=no understanding, 100=fluent)
            
            IMPORTANT CONSTRAINTS:
            - Sherry (12-year-old) cannot speak Sumerian until level 20+ (basic words), 50+ (simple conversations), 80+ (complex ideas)
            - The King and most Sumerians know NO English
            - Communication happens through gestures, demonstrations, Ku-Baba translating, or showing laptop programs
            - Language learning is slow and realistic - only increases through meaningful cultural exchange
            - Focus on the communication barrier as a major challenge
            - NO MODERN TECHNOLOGY exists except Sherry's laptop (no internet, GPS, phones, etc.)
            - NO ONLINE SERVICES available (no web search, Google Maps, social media, etc.)
            - Only suggest actions possible with 3000 BCE technology + one laptop
            - NO MODERN NAMES (no David, Sarah, etc.) - only ancient Sumerian names
            - Stay historically accurate to ancient Mesopotamian culture
            ${isCustomAction ? '- Evaluate if the custom action is possible/realistic for a 12-year-old in ancient Sumer' : ''}
            
            Generate the next scene with:
            1. A compelling narrative continuation that respects the language barrier (2-3 paragraphs)
            2. 3-4 meaningful choices that affect different stats
            3. Keep it historically accurate to ancient Sumer
            4. Include opportunities for visual/gestural communication and laptop demonstrations
            ${isCustomAction ? '5. If the custom action is impossible/unrealistic, show realistic consequences or alternatives' : ''}
            
            Format as JSON: {
                "title": "Day X - Scene Title",
                "text": "narrative text",
                "choices": [
                    {"text": "choice text", "effects": {"survival": 10, "kingsFavor": -5, "sumerianLevel": 3}, "description": "what this choice leads to"}
                ],
                ${isCustomAction ? '"effectsFromCustomAction": {"survival": 0, "kingsFavor": 0, "creativity": 0, "relationships": 0, "sumerianLevel": 0, "battery": 0},' : ''}
                "consequences": "brief description of what happened"
            }`;

            try {
                const response = await callGeminiAPI(prompt);
                
                // Extract JSON from markdown code blocks if present
                let jsonText = response.trim();
                if (jsonText.startsWith('```json')) {
                    jsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                } else if (jsonText.startsWith('```')) {
                    jsonText = jsonText.replace(/^```\s*/, '').replace(/\s*```$/, '');
                }
                
                const newScene = JSON.parse(jsonText);
                
                // Apply effects from custom action if present
                if (isCustomAction && newScene.effectsFromCustomAction) {
                    Object.keys(newScene.effectsFromCustomAction).forEach(stat => {
                        if (gameState.hasOwnProperty(stat)) {
                            gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + newScene.effectsFromCustomAction[stat]));
                        }
                    });
                    updateUI();
                }
                
                // Generate image if supported
                if (gameState.imageGenerationSupported && gameState.apiKey) {
                    generateSceneImage({
                        title: newScene.title,
                        text: newScene.text
                    });
                } else {
                    document.getElementById('sceneImage').style.display = 'none';
                }
                
                document.getElementById('dayHeader').textContent = newScene.title;
                document.getElementById('storyText').textContent = newScene.text;
                
                const choicesDiv = document.getElementById('choices');
                choicesDiv.innerHTML = '';
                
                newScene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'btn choice-btn';
                    button.textContent = choice.text;
                    button.onclick = () => {
                        Object.keys(choice.effects).forEach(stat => {
                            if (gameState.hasOwnProperty(stat)) {
                                gameState[stat] = Math.max(0, Math.min(100, gameState[stat] + choice.effects[stat]));
                            }
                        });
                        updateUI();
                        addDiaryEntry(choice.text);
                        generateNewScene(choice);
                    };
                    choicesDiv.appendChild(button);
                });
                
                // Add diary entry for custom action
                if (isCustomAction) {
                    addDiaryEntry(choice.text);
                }
                
            } catch (error) {
                console.error('Error generating scene:', error);
                alert('Error generating new scene. Please check your API key and try again.');
            }
            
            document.getElementById('loading').style.display = 'none';
        }

        async function handleAIConsultation() {
            const sumerianDesc = gameState.sumerianLevel < 10 ? "no Sumerian" : 
                                gameState.sumerianLevel < 30 ? "a few basic Sumerian words" :
                                gameState.sumerianLevel < 60 ? "basic Sumerian conversation" : "good Sumerian";
                                
            const consultation = `You're asking your AI partner for advice about this terrifying situation. Remember, this is happening through your laptop AI assistant, not out loud.

            Your situation:
            - You're a 12-year-old girl who just arrived in ancient Sumer through a portal
            - The King kills people who bore him - you've seen it happen
            - You understand ${sumerianDesc}
            - The King speaks NO English at all
            - You have a laptop with ${gameState.battery}% battery
            - Communication must happen through gestures, demonstrations, or visual means

            Your AI partner responds: "This is incredibly dangerous, but we can work together. The laptop screen is your best communication tool right now. Visual demonstrations might bridge the language gap better than words. Remember - you only have what's on your laptop and what exists in 3000 BCE. No internet, no online tools. Look for Ku-Baba - she's the wise old woman who might help translate. What's your immediate priority - survival, gaining trust, or showing your value?"`;

            addAIMessage(consultation, 'ai');
        }

        function handleAIInput(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message || !gameState.apiKey) return;

            addAIMessage(message, 'user');
            input.value = '';

            const prompt = `You are Sherry's AI partner in ancient Sumer. Respond to her message: "${message}"
            
            STORY CONTEXT:
            Sherry is a 12-year-old girl trapped in ancient Sumer (3000 BCE) after falling through a time portal. Key characters:
            - KU-BABA: Elderly wise woman, prisoner in palace, invented early writing, helps translate occasionally
            - THE KING: Sumerian ruler who speaks NO English, kills people who bore him
            - GUARDS: Sumerian soldiers, no English
            
            Current situation:
            - Day ${gameState.day} of 1001
            - Survival: ${gameState.survival}%
            - King's Favor: ${gameState.kingsFavor}%
            - Battery: ${gameState.battery}%
            - Sumerian Level: ${gameState.sumerianLevel}% (she ${gameState.sumerianLevel < 20 ? "cannot speak Sumerian yet" : gameState.sumerianLevel < 50 ? "knows basic Sumerian words" : "can have simple Sumerian conversations"})
            
            Remember:
            - Almost no one here speaks English
            - Communication happens visually through laptop demonstrations, gestures, or Ku-Baba translating
            - Be supportive, creative, and historically aware
            - Offer practical solutions for language barriers that a 12-year-old could implement
            - NO modern services exist (no internet, web search, GPS, phones, social media)
            - Only suggest actions possible with ancient Sumerian technology + one laptop
            - NO MODERN NAMES (no David, Sarah, etc.) - only ancient Sumerian names if any
            - Keep responses under 100 words.`;

            try {
                let response;
                if (gameState.ttsSupported) {
                    response = await callGeminiAPI(prompt);
                    await playAudioResponse(response);
                } else {
                    response = await callGeminiAPI(prompt);
                    addAIMessage(response, 'ai');
                }
            } catch (error) {
                addAIMessage("I'm having trouble connecting right now. Try again in a moment.", 'ai');
            }
        }

        async function callGeminiAPI(prompt) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${gameState.selectedModel}:generateContent?key=${gameState.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error('API call failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function addAIMessage(message, sender) {
            const chatDiv = document.getElementById('aiChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.textContent = message;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function addDiaryEntry(choice) {
            const diaryDiv = document.getElementById('diaryEntries');
            const entry = document.createElement('div');
            entry.className = 'diary-entry';
            entry.innerHTML = `<strong>Day ${gameState.day}:</strong> ${choice} I hope I made the right choice...`;
            diaryDiv.appendChild(entry);
            diaryDiv.scrollTop = diaryDiv.scrollHeight;
        }

        function saveDiary() {
            const diaryEntries = document.querySelectorAll('.diary-entry');
            let diaryText = "Sherry's Diary - A Girl and Her Laptop in Ancient Sumer\n";
            diaryText += "=" .repeat(60) + "\n\n";
            
            diaryEntries.forEach(entry => {
                diaryText += entry.textContent + "\n\n";
            });
            
            diaryText += `\nFinal Stats:\n`;
            diaryText += `Days Survived: ${gameState.day}\n`;
            diaryText += `Survival: ${gameState.survival}%\n`;
            diaryText += `King's Favor: ${gameState.kingsFavor}%\n`;
            diaryText += `Creativity: ${gameState.creativity}%\n`;
            diaryText += `Relationships: ${gameState.relationships}%\n`;
            diaryText += `Sumerian Language: ${gameState.sumerianLevel}%\n`;
            diaryText += `Laptop Battery: ${gameState.battery}%\n`;
            
            const blob = new Blob([diaryText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sherry_Diary_Day${gameState.day}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function updateUI() {
            // Update stats
            document.getElementById('survival').textContent = gameState.survival;
            document.getElementById('kingsFavor').textContent = gameState.kingsFavor;
            document.getElementById('creativity').textContent = gameState.creativity;
            document.getElementById('relationships').textContent = gameState.relationships;
            document.getElementById('sumerian').textContent = gameState.sumerianLevel;
            document.getElementById('battery').textContent = gameState.battery + '%';
            document.getElementById('dayCount').textContent = gameState.day;

            // Update progress bars
            document.getElementById('survivalBar').style.width = gameState.survival + '%';
            document.getElementById('kingsFavorBar').style.width = gameState.kingsFavor + '%';
            document.getElementById('creativityBar').style.width = gameState.creativity + '%';
            document.getElementById('relationshipsBar').style.width = gameState.relationships + '%';
            document.getElementById('sumerianBar').style.width = gameState.sumerianLevel + '%';
            document.getElementById('batteryBar').style.width = gameState.battery + '%';
        }

        // Placeholder functions for audio features (to be implemented when API details are clearer)
        function toggleRecording() {
            // Audio recording functionality would go here
            console.log('Audio recording not yet implemented');
        }

        function playLastResponse() {
            // Audio playback functionality would go here
            console.log('Audio playback not yet implemented');
        }

        async function playAudioResponse(text) {
            // TTS functionality would go here
            console.log('TTS not yet implemented');
            addAIMessage(text, 'ai');
        }

        // Initialize the game
        updateUI();
    </script>
</body>
</html>